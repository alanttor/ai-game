<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é¤ç›˜è¥å…»åˆ†æ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥—</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            color: #2e7d32;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 15px;
            gap: 15px;
        }

        .left-panel {
            flex: 6;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            flex: 4;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* é¤ç›˜åŒºåŸŸ */
        .plate-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px;
        }

        .plate {
            width: 320px;
            height: 320px;
            border-radius: 50%;
            background: linear-gradient(145deg, #fff, #f5f5f5);
            border: 8px solid #e0e0e0;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), inset 0 2px 10px rgba(255,255,255,0.5);
        }

        .plate-section {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            padding: 10px;
            gap: 5px;
            transition: background 0.3s;
            position: relative;
        }

        .plate-section.dragover {
            background: rgba(76, 175, 80, 0.2);
        }

        .plate-section::before {
            content: attr(data-label);
            position: absolute;
            font-size: 0.7em;
            color: #999;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .section-protein { border-right: 2px dashed #e0e0e0; border-bottom: 2px dashed #e0e0e0; }
        .section-carbs { border-bottom: 2px dashed #e0e0e0; }
        .section-veggies { border-right: 2px dashed #e0e0e0; }

        .plate-food {
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: float 3s ease-in-out infinite;
            transition: transform 0.2s;
        }

        .plate-food:hover {
            transform: scale(1.2);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .plate-label {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
        }

        /* é£Ÿç‰©åº“ */
        .food-library {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .food-category {
            margin-bottom: 10px;
        }

        .category-title {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .food-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .food-item {
            width: 50px;
            height: 50px;
            background: #f5f5f5;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.2s;
            font-size: 1.5em;
            position: relative;
        }

        .food-item:hover {
            background: #e8f5e9;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .food-item:active {
            cursor: grabbing;
        }

        .food-item .name {
            font-size: 0.4em;
            color: #666;
            margin-top: 2px;
        }

        .food-item.dragging {
            opacity: 0.5;
        }

        /* è¥å…»ä»ªè¡¨ */
        .nutrition-meters {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .meter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meter-label {
            width: 70px;
            font-size: 0.85em;
            color: #666;
        }

        .meter-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s, background 0.3s;
        }

        .meter-fill.good { background: linear-gradient(90deg, #66bb6a, #43a047); }
        .meter-fill.warning { background: linear-gradient(90deg, #ffb74d, #ff9800); }
        .meter-fill.danger { background: linear-gradient(90deg, #ef5350, #e53935); }

        .meter-value {
            width: 80px;
            text-align: right;
            font-size: 0.8em;
            color: #666;
        }

        /* ç”¨æˆ·è®¾ç½® */
        .user-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-group label {
            font-size: 0.8em;
            color: #666;
        }

        .setting-group input, .setting-group select {
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            background: #fff;
        }

        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #4caf50;
        }

        /* æŒ‰é’® */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #66bb6a, #43a047);
            color: #fff;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* è¥å…»è¯¦æƒ… */
        .nutrition-detail {
            background: #f9fbe7;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        /* å»ºè®®å¡ç‰‡ */
        .suggestion-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .suggestion-card.warning {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }

        .suggestion-card.success {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }

        /* é¤é£Ÿåˆ—è¡¨ */
        .meal-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .meal-tab {
            padding: 8px 15px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .meal-tab.active {
            background: #4caf50;
            color: #fff;
        }

        /* é£Ÿç‰©è¯¦æƒ…å¼¹çª— */
        .food-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 300px;
        }

        .food-popup.show {
            display: block;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .popup-overlay.show {
            display: block;
        }

        .popup-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .popup-icon {
            font-size: 3em;
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        /* ä¸€å‘¨è®¡åˆ’ */
        .week-plan {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            font-size: 0.75em;
        }

        .day-column {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .day-column.today {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }

        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="panel plate-area">
                <div class="panel-title">ğŸ½ï¸ æˆ‘çš„é¤ç›˜</div>
                <div class="meal-tabs">
                    <button class="meal-tab active" data-meal="breakfast">æ—©é¤</button>
                    <button class="meal-tab" data-meal="lunch">åˆé¤</button>
                    <button class="meal-tab" data-meal="dinner">æ™šé¤</button>
                    <button class="meal-tab" data-meal="snack">åŠ é¤</button>
                </div>
                <div class="plate" id="plate">
                    <div class="plate-section section-protein" data-type="protein" data-label="è›‹ç™½è´¨"></div>
                    <div class="plate-section section-carbs" data-type="carbs" data-label="ç¢³æ°´"></div>
                    <div class="plate-section section-veggies" data-type="veggies" data-label="è”¬èœ"></div>
                    <div class="plate-section section-fruits" data-type="fruits" data-label="æ°´æœ"></div>
                </div>
                <div class="plate-label">æ‹–æ‹½é£Ÿç‰©åˆ°é¤ç›˜ | ç‚¹å‡»é¤ç›˜ä¸­çš„é£Ÿç‰©ç§»é™¤</div>
            </div>

            <div class="panel food-library">
                <div class="panel-title">ğŸ¥— é£Ÿç‰©åº“ <span style="font-weight:normal;font-size:0.8em;color:#999">(æ‹–æ‹½æ·»åŠ )</span></div>
                <div id="foodCategories"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel">
                <div class="panel-title">ğŸ‘¤ ä¸ªäººè®¾ç½®</div>
                <div class="user-settings">
                    <div class="setting-group">
                        <label>å¹´é¾„</label>
                        <input type="number" id="userAge" value="30" min="18" max="80">
                    </div>
                    <div class="setting-group">
                        <label>æ€§åˆ«</label>
                        <select id="userGender">
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>èº«é«˜ (cm)</label>
                        <input type="number" id="userHeight" value="170" min="140" max="200">
                    </div>
                    <div class="setting-group">
                        <label>ä½“é‡ (kg)</label>
                        <input type="number" id="userWeight" value="65" min="40" max="150">
                    </div>
                    <div class="setting-group">
                        <label>æ´»åŠ¨æ°´å¹³</label>
                        <select id="activityLevel">
                            <option value="sedentary">ä¹…å</option>
                            <option value="light">è½»åº¦æ´»åŠ¨</option>
                            <option value="moderate" selected>ä¸­åº¦æ´»åŠ¨</option>
                            <option value="heavy">é‡åº¦æ´»åŠ¨</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>å¥åº·ç›®æ ‡</label>
                        <select id="healthGoal">
                            <option value="maintain">ç»´æŒä½“é‡</option>
                            <option value="lose">å‡é‡</option>
                            <option value="gain">å¢è‚Œ</option>
                            <option value="lowcarb">ä½ç¢³é¥®é£Ÿ</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“Š ä»Šæ—¥è¥å…»æ‘„å…¥</div>
                <div class="nutrition-meters" id="nutritionMeters"></div>
                <div class="nutrition-detail" id="nutritionDetail"></div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ’¡ æ™ºèƒ½å»ºè®®</div>
                <div id="suggestions"></div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“… ä¸€å‘¨è®¡åˆ’</div>
                <div class="week-plan" id="weekPlan"></div>
            </div>

            <div class="panel">
                <div class="btn-group">
                    <button class="btn btn-primary" id="saveMealBtn">ğŸ’¾ ä¿å­˜é¤é£Ÿ</button>
                    <button class="btn btn-secondary" id="clearPlateBtn">ğŸ—‘ï¸ æ¸…ç©ºé¤ç›˜</button>
                    <button class="btn btn-secondary" id="shoppingListBtn">ğŸ›’ è´­ç‰©æ¸…å•</button>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="food-popup" id="foodPopup">
        <button class="popup-close" id="popupClose">Ã—</button>
        <div class="popup-header">
            <span class="popup-icon" id="popupIcon">ğŸ</span>
            <div>
                <h3 id="popupName">é£Ÿç‰©åç§°</h3>
                <p style="color:#666;font-size:0.9em" id="popupCategory">ç±»åˆ«</p>
            </div>
        </div>
        <div id="popupNutrition"></div>
        <div style="margin-top:15px">
            <label style="font-size:0.85em;color:#666">ä»½é‡è°ƒæ•´</label>
            <input type="range" id="portionSlider" min="50" max="200" value="100" style="width:100%">
            <div style="text-align:center;font-size:0.85em" id="portionValue">100%</div>
        </div>
    </div>

    <script>

        // ==================== é£Ÿç‰©æ•°æ®åº“ ====================
        const FoodDatabase = {
            protein: [
                { id: 'chicken', name: 'é¸¡èƒ¸è‚‰', icon: 'ğŸ—', cal: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0 },
                { id: 'beef', name: 'ç‰›è‚‰', icon: 'ğŸ¥©', cal: 250, protein: 26, carbs: 0, fat: 15, fiber: 0 },
                { id: 'pork', name: 'çŒªè‚‰', icon: 'ğŸ¥“', cal: 242, protein: 27, carbs: 0, fat: 14, fiber: 0 },
                { id: 'fish', name: 'é±¼è‚‰', icon: 'ğŸŸ', cal: 206, protein: 22, carbs: 0, fat: 12, fiber: 0 },
                { id: 'shrimp', name: 'è™¾', icon: 'ğŸ¦', cal: 99, protein: 24, carbs: 0, fat: 0.3, fiber: 0 },
                { id: 'egg', name: 'é¸¡è›‹', icon: 'ğŸ¥š', cal: 155, protein: 13, carbs: 1, fat: 11, fiber: 0 },
                { id: 'tofu', name: 'è±†è…', icon: 'ğŸ§ˆ', cal: 76, protein: 8, carbs: 2, fat: 4.8, fiber: 0.3 },
                { id: 'milk', name: 'ç‰›å¥¶', icon: 'ğŸ¥›', cal: 42, protein: 3.4, carbs: 5, fat: 1, fiber: 0 },
                { id: 'cheese', name: 'å¥¶é…ª', icon: 'ğŸ§€', cal: 402, protein: 25, carbs: 1.3, fat: 33, fiber: 0 },
                { id: 'yogurt', name: 'é…¸å¥¶', icon: 'ğŸ¥„', cal: 59, protein: 10, carbs: 3.6, fat: 0.7, fiber: 0 }
            ],
            carbs: [
                { id: 'rice', name: 'ç±³é¥­', icon: 'ğŸš', cal: 130, protein: 2.7, carbs: 28, fat: 0.3, fiber: 0.4 },
                { id: 'noodles', name: 'é¢æ¡', icon: 'ğŸœ', cal: 138, protein: 5, carbs: 25, fat: 2, fiber: 1 },
                { id: 'bread', name: 'é¢åŒ…', icon: 'ğŸ', cal: 265, protein: 9, carbs: 49, fat: 3.2, fiber: 2.7 },
                { id: 'potato', name: 'åœŸè±†', icon: 'ğŸ¥”', cal: 77, protein: 2, carbs: 17, fat: 0.1, fiber: 2.2 },
                { id: 'corn', name: 'ç‰ç±³', icon: 'ğŸŒ½', cal: 86, protein: 3.2, carbs: 19, fat: 1.2, fiber: 2.7 },
                { id: 'oats', name: 'ç‡•éº¦', icon: 'ğŸ¥£', cal: 389, protein: 17, carbs: 66, fat: 7, fiber: 11 },
                { id: 'sweetpotato', name: 'çº¢è–¯', icon: 'ğŸ ', cal: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3 },
                { id: 'quinoa', name: 'è—œéº¦', icon: 'ğŸŒ¾', cal: 120, protein: 4.4, carbs: 21, fat: 1.9, fiber: 2.8 }
            ],
            veggies: [
                { id: 'broccoli', name: 'è¥¿å…°èŠ±', icon: 'ğŸ¥¦', cal: 34, protein: 2.8, carbs: 7, fat: 0.4, fiber: 2.6 },
                { id: 'carrot', name: 'èƒ¡èåœ', icon: 'ğŸ¥•', cal: 41, protein: 0.9, carbs: 10, fat: 0.2, fiber: 2.8 },
                { id: 'spinach', name: 'è èœ', icon: 'ğŸ¥¬', cal: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2 },
                { id: 'tomato', name: 'ç•ªèŒ„', icon: 'ğŸ…', cal: 18, protein: 0.9, carbs: 3.9, fat: 0.2, fiber: 1.2 },
                { id: 'cucumber', name: 'é»„ç“œ', icon: 'ğŸ¥’', cal: 15, protein: 0.7, carbs: 3.6, fat: 0.1, fiber: 0.5 },
                { id: 'lettuce', name: 'ç”Ÿèœ', icon: 'ğŸ¥—', cal: 15, protein: 1.4, carbs: 2.9, fat: 0.2, fiber: 1.3 },
                { id: 'pepper', name: 'é’æ¤’', icon: 'ğŸ«‘', cal: 20, protein: 0.9, carbs: 4.6, fat: 0.2, fiber: 1.7 },
                { id: 'mushroom', name: 'è˜‘è‡', icon: 'ğŸ„', cal: 22, protein: 3.1, carbs: 3.3, fat: 0.3, fiber: 1 },
                { id: 'onion', name: 'æ´‹è‘±', icon: 'ğŸ§…', cal: 40, protein: 1.1, carbs: 9.3, fat: 0.1, fiber: 1.7 },
                { id: 'garlic', name: 'å¤§è’œ', icon: 'ğŸ§„', cal: 149, protein: 6.4, carbs: 33, fat: 0.5, fiber: 2.1 },
                { id: 'eggplant', name: 'èŒ„å­', icon: 'ğŸ†', cal: 25, protein: 1, carbs: 6, fat: 0.2, fiber: 3 },
                { id: 'cabbage', name: 'å·å¿ƒèœ', icon: 'ğŸ¥¬', cal: 25, protein: 1.3, carbs: 6, fat: 0.1, fiber: 2.5 }
            ],
            fruits: [
                { id: 'apple', name: 'è‹¹æœ', icon: 'ğŸ', cal: 52, protein: 0.3, carbs: 14, fat: 0.2, fiber: 2.4 },
                { id: 'banana', name: 'é¦™è•‰', icon: 'ğŸŒ', cal: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6 },
                { id: 'orange', name: 'æ©™å­', icon: 'ğŸŠ', cal: 47, protein: 0.9, carbs: 12, fat: 0.1, fiber: 2.4 },
                { id: 'grape', name: 'è‘¡è„', icon: 'ğŸ‡', cal: 69, protein: 0.7, carbs: 18, fat: 0.2, fiber: 0.9 },
                { id: 'strawberry', name: 'è‰è“', icon: 'ğŸ“', cal: 32, protein: 0.7, carbs: 7.7, fat: 0.3, fiber: 2 },
                { id: 'watermelon', name: 'è¥¿ç“œ', icon: 'ğŸ‰', cal: 30, protein: 0.6, carbs: 7.6, fat: 0.2, fiber: 0.4 },
                { id: 'peach', name: 'æ¡ƒå­', icon: 'ğŸ‘', cal: 39, protein: 0.9, carbs: 10, fat: 0.3, fiber: 1.5 },
                { id: 'pear', name: 'æ¢¨', icon: 'ğŸ', cal: 57, protein: 0.4, carbs: 15, fat: 0.1, fiber: 3.1 },
                { id: 'cherry', name: 'æ¨±æ¡ƒ', icon: 'ğŸ’', cal: 50, protein: 1, carbs: 12, fat: 0.3, fiber: 1.6 },
                { id: 'kiwi', name: 'çŒ•çŒ´æ¡ƒ', icon: 'ğŸ¥', cal: 61, protein: 1.1, carbs: 15, fat: 0.5, fiber: 3 },
                { id: 'mango', name: 'èŠ’æœ', icon: 'ğŸ¥­', cal: 60, protein: 0.8, carbs: 15, fat: 0.4, fiber: 1.6 },
                { id: 'pineapple', name: 'è è', icon: 'ğŸ', cal: 50, protein: 0.5, carbs: 13, fat: 0.1, fiber: 1.4 }
            ]
        };

        const CategoryNames = {
            protein: 'ğŸ¥© è›‹ç™½è´¨',
            carbs: 'ğŸš ç¢³æ°´åŒ–åˆç‰©',
            veggies: 'ğŸ¥¦ è”¬èœ',
            fruits: 'ğŸ æ°´æœ'
        };

        // ==================== è¥å…»è®¡ç®—å™¨ ====================
        class NutritionCalculator {
            constructor() {
                this.userParams = {
                    age: 30,
                    gender: 'male',
                    height: 170,
                    weight: 65,
                    activity: 'moderate',
                    goal: 'maintain'
                };
            }

            // Harris-Benedictå…¬å¼è®¡ç®—åŸºç¡€ä»£è°¢ç‡
            calculateBMR() {
                const { age, gender, height, weight } = this.userParams;
                if (gender === 'male') {
                    return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }
            }

            // è®¡ç®—æ¯æ—¥æ€»èƒ½é‡æ¶ˆè€—
            calculateTDEE() {
                const bmr = this.calculateBMR();
                const activityMultipliers = {
                    sedentary: 1.2,
                    light: 1.375,
                    moderate: 1.55,
                    heavy: 1.725
                };
                return bmr * activityMultipliers[this.userParams.activity];
            }

            // è·å–æ¨èè¥å…»æ‘„å…¥
            getRecommendedIntake() {
                let tdee = this.calculateTDEE();
                const { goal } = this.userParams;

                // æ ¹æ®ç›®æ ‡è°ƒæ•´
                if (goal === 'lose') tdee *= 0.8;
                else if (goal === 'gain') tdee *= 1.15;

                // å®é‡è¥å…»ç´ åˆ†é…
                let proteinRatio = 0.25, carbsRatio = 0.45, fatRatio = 0.30;
                if (goal === 'gain') {
                    proteinRatio = 0.30; carbsRatio = 0.45; fatRatio = 0.25;
                } else if (goal === 'lowcarb') {
                    proteinRatio = 0.30; carbsRatio = 0.20; fatRatio = 0.50;
                }

                return {
                    calories: Math.round(tdee),
                    protein: Math.round((tdee * proteinRatio) / 4), // 4 cal/g
                    carbs: Math.round((tdee * carbsRatio) / 4),
                    fat: Math.round((tdee * fatRatio) / 9), // 9 cal/g
                    fiber: 25 // å›ºå®šæ¨è
                };
            }

            // è®¡ç®—é£Ÿç‰©æ€»è¥å…»
            calculateTotal(foods) {
                const total = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
                foods.forEach(food => {
                    const portion = food.portion || 100;
                    const factor = portion / 100;
                    total.calories += food.cal * factor;
                    total.protein += food.protein * factor;
                    total.carbs += food.carbs * factor;
                    total.fat += food.fat * factor;
                    total.fiber += food.fiber * factor;
                });
                return {
                    calories: Math.round(total.calories),
                    protein: Math.round(total.protein),
                    carbs: Math.round(total.carbs),
                    fat: Math.round(total.fat),
                    fiber: Math.round(total.fiber * 10) / 10
                };
            }
        }

        // ==================== ä¸»åº”ç”¨ ====================
        class NutritionApp {
            constructor() {
                this.calculator = new NutritionCalculator();
                this.currentMeal = 'breakfast';
                this.meals = {
                    breakfast: [],
                    lunch: [],
                    dinner: [],
                    snack: []
                };
                this.weekPlan = {};
                
                this.initFoodLibrary();
                this.initDragDrop();
                this.initControls();
                this.initWeekPlan();
                this.update();
            }

            initFoodLibrary() {
                const container = document.getElementById('foodCategories');
                container.innerHTML = '';

                Object.entries(FoodDatabase).forEach(([category, foods]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'food-category';
                    categoryDiv.innerHTML = `
                        <div class="category-title">${CategoryNames[category]}</div>
                        <div class="food-grid">
                            ${foods.map(food => `
                                <div class="food-item" draggable="true" 
                                     data-id="${food.id}" data-category="${category}"
                                     title="${food.name}: ${food.cal}å¡">
                                    <span>${food.icon}</span>
                                    <span class="name">${food.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(categoryDiv);
                });
            }

            initDragDrop() {
                // é£Ÿç‰©é¡¹æ‹–æ‹½
                document.querySelectorAll('.food-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('foodId', item.dataset.id);
                        e.dataTransfer.setData('category', item.dataset.category);
                        item.classList.add('dragging');
                    });

                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                    });

                    item.addEventListener('click', () => {
                        this.showFoodPopup(item.dataset.id, item.dataset.category);
                    });
                });

                // é¤ç›˜åŒºåŸŸæ¥æ”¶
                document.querySelectorAll('.plate-section').forEach(section => {
                    section.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        section.classList.add('dragover');
                    });

                    section.addEventListener('dragleave', () => {
                        section.classList.remove('dragover');
                    });

                    section.addEventListener('drop', (e) => {
                        e.preventDefault();
                        section.classList.remove('dragover');
                        
                        const foodId = e.dataTransfer.getData('foodId');
                        const category = e.dataTransfer.getData('category');
                        this.addFoodToPlate(foodId, category);
                    });
                });
            }

            initControls() {
                // ç”¨æˆ·è®¾ç½®
                ['userAge', 'userGender', 'userHeight', 'userWeight', 'activityLevel', 'healthGoal'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        const param = id.replace('user', '').toLowerCase()
                            .replace('activitylevel', 'activity')
                            .replace('healthgoal', 'goal');
                        this.calculator.userParams[param] = e.target.value;
                        this.update();
                    });
                });

                // é¤é£Ÿæ ‡ç­¾
                document.querySelectorAll('.meal-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.meal-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentMeal = tab.dataset.meal;
                        this.renderPlate();
                    });
                });

                // æŒ‰é’®
                document.getElementById('clearPlateBtn').addEventListener('click', () => {
                    this.meals[this.currentMeal] = [];
                    this.renderPlate();
                    this.update();
                });

                document.getElementById('saveMealBtn').addEventListener('click', () => {
                    this.saveMeal();
                });

                document.getElementById('shoppingListBtn').addEventListener('click', () => {
                    this.showShoppingList();
                });

                // å¼¹çª—
                document.getElementById('popupClose').addEventListener('click', () => this.hidePopup());
                document.getElementById('popupOverlay').addEventListener('click', () => this.hidePopup());

                document.getElementById('portionSlider').addEventListener('input', (e) => {
                    document.getElementById('portionValue').textContent = e.target.value + '%';
                });
            }

            initWeekPlan() {
                const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                const today = new Date().getDay();
                const todayIndex = today === 0 ? 6 : today - 1;

                const container = document.getElementById('weekPlan');
                container.innerHTML = days.map((day, i) => `
                    <div class="day-column ${i === todayIndex ? 'today' : ''}">
                        <div class="day-name">${day}</div>
                        <div style="font-size:0.9em;color:#666">--</div>
                    </div>
                `).join('');
            }

            addFoodToPlate(foodId, category) {
                const food = FoodDatabase[category].find(f => f.id === foodId);
                if (food) {
                    this.meals[this.currentMeal].push({ ...food, category, portion: 100 });
                    this.renderPlate();
                    this.update();
                }
            }

            removeFoodFromPlate(index) {
                this.meals[this.currentMeal].splice(index, 1);
                this.renderPlate();
                this.update();
            }

            renderPlate() {
                // æ¸…ç©ºæ‰€æœ‰åŒºåŸŸ
                document.querySelectorAll('.plate-section').forEach(section => {
                    const label = section.dataset.label;
                    section.innerHTML = '';
                });

                // æ·»åŠ é£Ÿç‰©åˆ°å¯¹åº”åŒºåŸŸ
                this.meals[this.currentMeal].forEach((food, index) => {
                    const section = document.querySelector(`.plate-section[data-type="${food.category === 'protein' ? 'protein' : food.category === 'carbs' ? 'carbs' : food.category === 'veggies' ? 'veggies' : 'fruits'}"]`);
                    if (section) {
                        const foodEl = document.createElement('div');
                        foodEl.className = 'plate-food';
                        foodEl.textContent = food.icon;
                        foodEl.title = food.name;
                        foodEl.style.animationDelay = (index * 0.1) + 's';
                        foodEl.addEventListener('click', () => this.removeFoodFromPlate(index));
                        section.appendChild(foodEl);
                    }
                });
            }

            update() {
                this.updateNutritionMeters();
                this.updateSuggestions();
            }

            updateNutritionMeters() {
                const allFoods = Object.values(this.meals).flat();
                const total = this.calculator.calculateTotal(allFoods);
                const recommended = this.calculator.getRecommendedIntake();

                const nutrients = [
                    { key: 'calories', label: 'çƒ­é‡', unit: 'å¡', color: 'cal' },
                    { key: 'protein', label: 'è›‹ç™½è´¨', unit: 'g', color: 'protein' },
                    { key: 'carbs', label: 'ç¢³æ°´', unit: 'g', color: 'carbs' },
                    { key: 'fat', label: 'è„‚è‚ª', unit: 'g', color: 'fat' },
                    { key: 'fiber', label: 'çº¤ç»´', unit: 'g', color: 'fiber' }
                ];

                const container = document.getElementById('nutritionMeters');
                container.innerHTML = nutrients.map(n => {
                    const percent = Math.min(150, (total[n.key] / recommended[n.key]) * 100);
                    const status = percent < 80 ? 'good' : percent < 110 ? 'good' : percent < 130 ? 'warning' : 'danger';
                    return `
                        <div class="meter">
                            <span class="meter-label">${n.label}</span>
                            <div class="meter-bar">
                                <div class="meter-fill ${status}" style="width:${Math.min(100, percent)}%"></div>
                            </div>
                            <span class="meter-value">${total[n.key]}/${recommended[n.key]}${n.unit}</span>
                        </div>
                    `;
                }).join('');

                // è¯¦ç»†ä¿¡æ¯
                document.getElementById('nutritionDetail').innerHTML = `
                    <div class="detail-row"><span>åŸºç¡€ä»£è°¢ç‡ (BMR)</span><span>${Math.round(this.calculator.calculateBMR())} å¡</span></div>
                    <div class="detail-row"><span>æ¯æ—¥æ€»æ¶ˆè€— (TDEE)</span><span>${Math.round(this.calculator.calculateTDEE())} å¡</span></div>
                    <div class="detail-row"><span>ä»Šæ—¥å·²æ‘„å…¥</span><span>${total.calories} å¡</span></div>
                    <div class="detail-row"><span>å‰©ä½™å¯æ‘„å…¥</span><span>${Math.max(0, recommended.calories - total.calories)} å¡</span></div>
                `;
            }

            updateSuggestions() {
                const allFoods = Object.values(this.meals).flat();
                const total = this.calculator.calculateTotal(allFoods);
                const recommended = this.calculator.getRecommendedIntake();
                const suggestions = [];

                // åˆ†æè¥å…»å¹³è¡¡
                if (total.protein < recommended.protein * 0.5) {
                    suggestions.push({ type: 'warning', text: 'è›‹ç™½è´¨æ‘„å…¥ä¸è¶³ï¼Œå»ºè®®æ·»åŠ é¸¡èƒ¸è‚‰ã€é±¼è‚‰æˆ–è±†è…' });
                }
                if (total.fiber < 15) {
                    suggestions.push({ type: 'warning', text: 'è†³é£Ÿçº¤ç»´åä½ï¼Œå»ºè®®å¤šåƒè”¬èœå’Œå…¨è°·ç‰©' });
                }
                if (total.calories > recommended.calories * 1.2) {
                    suggestions.push({ type: 'warning', text: 'çƒ­é‡æ‘„å…¥åé«˜ï¼Œå»ºè®®å‡å°‘é«˜çƒ­é‡é£Ÿç‰©' });
                }
                if (total.fat > recommended.fat * 1.3) {
                    suggestions.push({ type: 'warning', text: 'è„‚è‚ªæ‘„å…¥è¿‡å¤šï¼Œå»ºè®®é€‰æ‹©ä½è„‚é£Ÿç‰©' });
                }

                // æ­£é¢åé¦ˆ
                const proteinPercent = total.protein / recommended.protein;
                const carbsPercent = total.carbs / recommended.carbs;
                if (proteinPercent >= 0.8 && proteinPercent <= 1.2 && carbsPercent >= 0.8 && carbsPercent <= 1.2) {
                    suggestions.push({ type: 'success', text: 'è¥å…»æ­é…å‡è¡¡ï¼Œç»§ç»­ä¿æŒï¼' });
                }

                if (suggestions.length === 0) {
                    suggestions.push({ type: '', text: 'å¼€å§‹æ·»åŠ é£Ÿç‰©åˆ°é¤ç›˜ï¼Œè·å–ä¸ªæ€§åŒ–å»ºè®®' });
                }

                document.getElementById('suggestions').innerHTML = suggestions.map(s => `
                    <div class="suggestion-card ${s.type}">${s.text}</div>
                `).join('');
            }

            showFoodPopup(foodId, category) {
                const food = FoodDatabase[category].find(f => f.id === foodId);
                if (!food) return;

                document.getElementById('popupIcon').textContent = food.icon;
                document.getElementById('popupName').textContent = food.name;
                document.getElementById('popupCategory').textContent = CategoryNames[category];
                document.getElementById('popupNutrition').innerHTML = `
                    <div class="detail-row"><span>çƒ­é‡</span><span>${food.cal} å¡/100g</span></div>
                    <div class="detail-row"><span>è›‹ç™½è´¨</span><span>${food.protein} g</span></div>
                    <div class="detail-row"><span>ç¢³æ°´åŒ–åˆç‰©</span><span>${food.carbs} g</span></div>
                    <div class="detail-row"><span>è„‚è‚ª</span><span>${food.fat} g</span></div>
                    <div class="detail-row"><span>è†³é£Ÿçº¤ç»´</span><span>${food.fiber} g</span></div>
                `;

                document.getElementById('foodPopup').classList.add('show');
                document.getElementById('popupOverlay').classList.add('show');
            }

            hidePopup() {
                document.getElementById('foodPopup').classList.remove('show');
                document.getElementById('popupOverlay').classList.remove('show');
            }

            saveMeal() {
                const mealNames = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤', snack: 'åŠ é¤' };
                const foods = this.meals[this.currentMeal];
                if (foods.length === 0) {
                    alert('é¤ç›˜æ˜¯ç©ºçš„ï¼Œè¯·å…ˆæ·»åŠ é£Ÿç‰©');
                    return;
                }
                alert(`${mealNames[this.currentMeal]}å·²ä¿å­˜ï¼å…±${foods.length}ç§é£Ÿç‰©`);
            }

            showShoppingList() {
                const allFoods = Object.values(this.meals).flat();
                if (allFoods.length === 0) {
                    alert('è¯·å…ˆæ·»åŠ é£Ÿç‰©åˆ°é¤ç›˜');
                    return;
                }

                const foodCounts = {};
                allFoods.forEach(food => {
                    foodCounts[food.name] = (foodCounts[food.name] || 0) + 1;
                });

                const list = Object.entries(foodCounts)
                    .map(([name, count]) => `${name} x${count}`)
                    .join('\n');

                alert('ğŸ›’ è´­ç‰©æ¸…å•ï¼š\n\n' + list);
            }
        }

        // å¯åŠ¨åº”ç”¨
        new NutritionApp();
    </script>
</body>
</html>
