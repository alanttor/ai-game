<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡çœ é˜¶æ®µä¸æ¢¦å¢ƒç”Ÿæˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ™</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0d0d2b 0%, #1a1a4e 50%, #0d0d2b 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow: hidden;
        }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .top-bar {
            height: 120px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid #3a3a6a;
            padding: 10px 20px;
        }
        .main-area { flex: 1; display: flex; }
        .dream-canvas { flex: 1; position: relative; overflow: hidden; }
        .right-panel {
            width: 300px;
            background: rgba(0,0,0,0.4);
            border-left: 1px solid #3a3a6a;
            padding: 15px;
            overflow-y: auto;
        }
        .hypnogram { height: 80px; position: relative; }
        #hypnoCanvas { width: 100%; height: 100%; }
        .stage-labels {
            position: absolute; left: 0; top: 0; bottom: 0;
            width: 50px; display: flex; flex-direction: column;
            justify-content: space-between; font-size: 0.7em; color: #888;
            padding: 5px 0;
        }
</style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="color:#a78bfa;font-weight:bold;">ğŸŒ™ ç¡çœ ç»“æ„å›¾</div>
            <div id="sleepInfo" style="color:#888;font-size:0.9em;"></div>
        </div>
        <div class="hypnogram">
            <div class="stage-labels">
                <span>æ¸…é†’</span><span>REM</span><span>N1</span><span>N2</span><span>N3</span>
            </div>
            <canvas id="hypnoCanvas"></canvas>
        </div>
    </div>
    <div class="main-area">
        <div class="dream-canvas">
            <canvas id="dreamCanvas"></canvas>
            <div id="dreamOverlay" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;"></div>
        </div>
        <div class="right-panel">
            <div style="color:#a78bfa;font-weight:bold;margin-bottom:15px;">âš™ï¸ ç¡çœ æ§åˆ¶</div>
            <div id="controls"></div>
            <div style="color:#a78bfa;font-weight:bold;margin:20px 0 15px;">ğŸ§  ç”Ÿç†æŒ‡æ ‡</div>
            <div id="vitals"></div>
            <div style="color:#a78bfa;font-weight:bold;margin:20px 0 15px;">ğŸ’­ æ¢¦å¢ƒå…ƒç´ </div>
            <div id="dreamElements"></div>
        </div>
    </div>
</div>
<script>
const hypnoCanvas = document.getElementById('hypnoCanvas');
const hypnoCtx = hypnoCanvas.getContext('2d');
const dreamCanvas = document.getElementById('dreamCanvas');
const dreamCtx = dreamCanvas.getContext('2d');

// ç¡çœ é˜¶æ®µå®šä¹‰
const sleepStages = {
    W: { name: 'æ¸…é†’', level: 0, color: '#ff6b6b', brainwave: 'Î²æ³¢', freq: '13-30Hz' },
    REM: { name: 'REMç¡çœ ', level: 1, color: '#a78bfa', brainwave: 'æ··åˆæ³¢', freq: 'æ··åˆ' },
    N1: { name: 'æµ…ç¡æœŸ', level: 2, color: '#60a5fa', brainwave: 'Î¸æ³¢', freq: '4-8Hz' },
    N2: { name: 'è½»ç¡æœŸ', level: 3, color: '#34d399', brainwave: 'çººé”¤æ³¢', freq: '12-14Hz' },
    N3: { name: 'æ·±ç¡æœŸ', level: 4, color: '#1e3a5f', brainwave: 'Î´æ³¢', freq: '0.5-4Hz' }
};

// æ¢¦å¢ƒå…ƒç´ åº“
const dreamElements = {
    locations: ['æ£®æ—', 'æµ·è¾¹', 'åŸå¸‚', 'å±±é¡¶', 'å¤ªç©º', 'ç«¥å¹´å®¶', 'å­¦æ ¡', 'åŠå…¬å®¤', 'è¿·å®«', 'äº‘ç«¯'],
    characters: ['å®¶äºº', 'æœ‹å‹', 'é™Œç”Ÿäºº', 'åŠ¨ç‰©', 'è‡ªå·±', 'åäºº', 'è€å¸ˆ', 'åŒäº‹'],
    emotions: ['å¿«ä¹', 'ç„¦è™‘', 'ææƒ§', 'å¹³é™', 'å…´å¥‹', 'å›°æƒ‘', 'è‡ªç”±', 'è¿½é€'],
    objects: ['æ°´', 'é£è¡Œ', 'å è½', 'é—¨', 'é•œå­', 'é’¥åŒ™', 'å…‰', 'å½±å­'],
    colors: ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#9b59b6', '#e74c3c', '#1abc9c', '#f39c12']
};

// ç¡çœ çŠ¶æ€
let sleepState = {
    stage: 'W',
    cycleTime: 0,
    totalTime: 0,
    cycleCount: 0,
    history: [],
    dreaming: false,
    dreamIntensity: 0
};

// ç”Ÿç†æŒ‡æ ‡
let vitals = {
    heartRate: 70,
    breathRate: 16,
    eyeMovement: 0,
    muscleTone: 100,
    brainActivity: 50
};

// æ¢¦å¢ƒçŠ¶æ€
let dreamState = {
    elements: [],
    particles: [],
    hue: 0,
    morphTime: 0
};

// æ—¥é—´ç»å†ï¼ˆå½±å“æ¢¦å¢ƒï¼‰
let dayExperiences = {
    stress: 30,
    learning: 50,
    emotion: 'neutral',
    keywords: []
};

let simulating = false;
let simSpeed = 1;

function init() {
    resizeCanvases();
    window.addEventListener('resize', resizeCanvases);
    renderControls();
    renderVitals();
    renderDreamElements();
    animate();
}

function resizeCanvases() {
    hypnoCanvas.width = hypnoCanvas.parentElement.clientWidth - 60;
    hypnoCanvas.height = hypnoCanvas.parentElement.clientHeight;
    dreamCanvas.width = dreamCanvas.parentElement.clientWidth;
    dreamCanvas.height = dreamCanvas.parentElement.clientHeight;
}

function renderControls() {
    document.getElementById('controls').innerHTML = `
        <div style="margin-bottom:15px;">
            <label style="color:#888;font-size:0.85em;display:block;margin-bottom:5px;">å‹åŠ›æ°´å¹³</label>
            <input type="range" min="0" max="100" value="${dayExperiences.stress}" 
                   onchange="dayExperiences.stress=this.value" style="width:100%;">
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:#888;font-size:0.85em;display:block;margin-bottom:5px;">å­¦ä¹ å¼ºåº¦</label>
            <input type="range" min="0" max="100" value="${dayExperiences.learning}" 
                   onchange="dayExperiences.learning=this.value" style="width:100%;">
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:#888;font-size:0.85em;display:block;margin-bottom:5px;">æ¨¡æ‹Ÿé€Ÿåº¦</label>
            <input type="range" min="1" max="10" value="${simSpeed}" 
                   onchange="simSpeed=this.value" style="width:100%;">
            <span style="color:#888;font-size:0.8em;">${simSpeed}x</span>
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:#888;font-size:0.85em;display:block;margin-bottom:5px;">æƒ…ç»ªçŠ¶æ€</label>
            <select onchange="dayExperiences.emotion=this.value" style="width:100%;padding:8px;background:#1a1a4e;border:1px solid #3a3a6a;color:#fff;border-radius:5px;">
                <option value="neutral">å¹³é™</option>
                <option value="happy">å¿«ä¹</option>
                <option value="anxious">ç„¦è™‘</option>
                <option value="sad">æ‚²ä¼¤</option>
                <option value="excited">å…´å¥‹</option>
            </select>
        </div>
        <button onclick="toggleSimulation()" style="
            width:100%;padding:12px;margin-top:10px;
            background:${simulating ? '#ff6b6b' : 'linear-gradient(135deg,#a78bfa,#6366f1)'};
            border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:bold;
        ">${simulating ? 'â¹ åœæ­¢ç¡çœ ' : 'ğŸŒ™ å¼€å§‹ç¡çœ '}</button>
        <button onclick="resetSleep()" style="
            width:100%;padding:10px;margin-top:8px;
            background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:#888;cursor:pointer;
        ">é‡ç½®</button>
    `;
}

function renderVitals() {
    const stage = sleepStages[sleepState.stage];
    document.getElementById('vitals').innerHTML = `
        <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:12px;margin-bottom:10px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="color:#888;">å½“å‰é˜¶æ®µ</span>
                <span style="color:${stage.color};font-weight:bold;">${stage.name}</span>
            </div>
            <div style="font-size:0.8em;color:#666;">${stage.brainwave} (${stage.freq})</div>
        </div>
        ${[
            { name: 'å¿ƒç‡', value: vitals.heartRate, unit: 'bpm', color: '#ff6b6b', max: 100 },
            { name: 'å‘¼å¸', value: vitals.breathRate, unit: '/min', color: '#60a5fa', max: 25 },
            { name: 'çœ¼åŠ¨', value: vitals.eyeMovement, unit: '%', color: '#a78bfa', max: 100 },
            { name: 'è‚Œå¼ åŠ›', value: vitals.muscleTone, unit: '%', color: '#34d399', max: 100 }
        ].map(v => `
            <div style="margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85em;margin-bottom:3px;">
                    <span style="color:#888;">${v.name}</span>
                    <span style="color:${v.color};">${v.value.toFixed(0)}${v.unit}</span>
                </div>
                <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;">
                    <div style="height:100%;width:${(v.value/v.max)*100}%;background:${v.color};border-radius:2px;"></div>
                </div>
            </div>
        `).join('')}
    `;
}

function renderDreamElements() {
    const container = document.getElementById('dreamElements');
    if (!sleepState.dreaming || dreamState.elements.length === 0) {
        container.innerHTML = '<div style="color:#666;font-size:0.9em;text-align:center;padding:20px;">è¿›å…¥REMç¡çœ åå¼€å§‹ç”Ÿæˆæ¢¦å¢ƒ...</div>';
        return;
    }
    
    container.innerHTML = dreamState.elements.map(el => `
        <div style="background:rgba(167,139,250,0.1);border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:0.9em;">
            ${el.type === 'location' ? 'ğŸ“' : el.type === 'character' ? 'ğŸ‘¤' : el.type === 'emotion' ? 'ğŸ’­' : 'âœ¨'} ${el.value}
        </div>
    `).join('');
}

function toggleSimulation() {
    simulating = !simulating;
    if (simulating && sleepState.stage === 'W') {
        sleepState.stage = 'N1';
    }
    renderControls();
}

function resetSleep() {
    simulating = false;
    sleepState = { stage: 'W', cycleTime: 0, totalTime: 0, cycleCount: 0, history: [], dreaming: false, dreamIntensity: 0 };
    vitals = { heartRate: 70, breathRate: 16, eyeMovement: 0, muscleTone: 100, brainActivity: 50 };
    dreamState = { elements: [], particles: [], hue: 0, morphTime: 0 };
    renderControls();
    renderVitals();
    renderDreamElements();
}

function simulateSleep() {
    if (!simulating) return;
    
    sleepState.cycleTime += 0.1 * simSpeed;
    sleepState.totalTime += 0.1 * simSpeed;
    
    // 90åˆ†é’Ÿç¡çœ å‘¨æœŸæ¨¡æ‹Ÿï¼ˆå‹ç¼©åˆ°90ç§’ï¼‰
    const cycleProgress = (sleepState.cycleTime % 90) / 90;
    
    // é˜¶æ®µè½¬æ¢é€»è¾‘
    if (cycleProgress < 0.05) sleepState.stage = 'N1';
    else if (cycleProgress < 0.15) sleepState.stage = 'N2';
    else if (cycleProgress < 0.35) sleepState.stage = 'N3';
    else if (cycleProgress < 0.45) sleepState.stage = 'N2';
    else if (cycleProgress < 0.65) sleepState.stage = 'REM';
    else if (cycleProgress < 0.75) sleepState.stage = 'N2';
    else if (cycleProgress < 0.9) sleepState.stage = 'N3';
    else sleepState.stage = 'N2';
    
    // éšæœºçŸ­æš‚è§‰é†’
    if (Math.random() < 0.001) sleepState.stage = 'W';
    
    // è®°å½•å†å²
    if (sleepState.history.length === 0 || sleepState.history[sleepState.history.length-1].stage !== sleepState.stage) {
        sleepState.history.push({ stage: sleepState.stage, time: sleepState.totalTime });
    }
    
    // æ›´æ–°ç”Ÿç†æŒ‡æ ‡
    updateVitals();
    
    // æ¢¦å¢ƒç”Ÿæˆ
    sleepState.dreaming = sleepState.stage === 'REM';
    if (sleepState.dreaming) {
        sleepState.dreamIntensity = Math.min(100, sleepState.dreamIntensity + 0.5);
        if (Math.random() < 0.02) generateDreamElement();
    } else {
        sleepState.dreamIntensity = Math.max(0, sleepState.dreamIntensity - 1);
    }
    
    // æ›´æ–°å‘¨æœŸè®¡æ•°
    if (sleepState.cycleTime >= 90) {
        sleepState.cycleTime = 0;
        sleepState.cycleCount++;
    }
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('sleepInfo').textContent = 
        `æ€»æ—¶é•¿: ${formatTime(sleepState.totalTime)} | å‘¨æœŸ: ${sleepState.cycleCount + 1} | æ¢¦å¢ƒå¼ºåº¦: ${sleepState.dreamIntensity.toFixed(0)}%`;
    
    renderVitals();
    renderDreamElements();
}

function updateVitals() {
    const stage = sleepState.stage;
    const targets = {
        W: { hr: 70, br: 16, em: 50, mt: 100, ba: 80 },
        REM: { hr: 65, br: 14, em: 80, mt: 10, ba: 70 },
        N1: { hr: 60, br: 14, em: 20, mt: 70, ba: 50 },
        N2: { hr: 55, br: 12, em: 5, mt: 50, ba: 40 },
        N3: { hr: 50, br: 10, em: 0, mt: 30, ba: 20 }
    }[stage];
    
    vitals.heartRate += (targets.hr - vitals.heartRate) * 0.05 + (Math.random() - 0.5) * 2;
    vitals.breathRate += (targets.br - vitals.breathRate) * 0.05 + (Math.random() - 0.5) * 0.5;
    vitals.eyeMovement += (targets.em - vitals.eyeMovement) * 0.1 + (stage === 'REM' ? (Math.random() - 0.5) * 20 : 0);
    vitals.muscleTone += (targets.mt - vitals.muscleTone) * 0.05;
    vitals.brainActivity += (targets.ba - vitals.brainActivity) * 0.05 + (Math.random() - 0.5) * 5;
    
    // é™åˆ¶èŒƒå›´
    vitals.heartRate = Math.max(40, Math.min(100, vitals.heartRate));
    vitals.breathRate = Math.max(8, Math.min(25, vitals.breathRate));
    vitals.eyeMovement = Math.max(0, Math.min(100, vitals.eyeMovement));
    vitals.muscleTone = Math.max(0, Math.min(100, vitals.muscleTone));
    vitals.brainActivity = Math.max(10, Math.min(100, vitals.brainActivity));
}

function generateDreamElement() {
    const types = ['location', 'character', 'emotion', 'object'];
    const type = types[Math.floor(Math.random() * types.length)];
    const pool = dreamElements[type + 's'] || dreamElements.objects;
    const value = pool[Math.floor(Math.random() * pool.length)];
    
    // å‹åŠ›å½±å“æ¢¦å¢ƒå†…å®¹
    if (dayExperiences.stress > 70 && Math.random() < 0.3) {
        dreamState.elements.unshift({ type: 'emotion', value: 'ç„¦è™‘' });
    }
    
    dreamState.elements.unshift({ type, value });
    if (dreamState.elements.length > 6) dreamState.elements.pop();
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function drawHypnogram() {
    hypnoCtx.clearRect(0, 0, hypnoCanvas.width, hypnoCanvas.height);
    
    const w = hypnoCanvas.width;
    const h = hypnoCanvas.height;
    
    // èƒŒæ™¯ç½‘æ ¼
    hypnoCtx.strokeStyle = 'rgba(255,255,255,0.1)';
    hypnoCtx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = (i / 4) * h;
        hypnoCtx.beginPath();
        hypnoCtx.moveTo(0, y);
        hypnoCtx.lineTo(w, y);
        hypnoCtx.stroke();
    }
    
    // ç»˜åˆ¶ç¡çœ å†å²
    if (sleepState.history.length > 1) {
        hypnoCtx.beginPath();
        hypnoCtx.strokeStyle = '#a78bfa';
        hypnoCtx.lineWidth = 2;
        
        const maxTime = Math.max(sleepState.totalTime, 90);
        
        sleepState.history.forEach((point, i) => {
            const x = (point.time / maxTime) * w;
            const y = (sleepStages[point.stage].level / 4) * h;
            
            if (i === 0) hypnoCtx.moveTo(x, y);
            else hypnoCtx.lineTo(x, y);
        });
        
        // å½“å‰ä½ç½®
        const currentX = (sleepState.totalTime / maxTime) * w;
        const currentY = (sleepStages[sleepState.stage].level / 4) * h;
        hypnoCtx.lineTo(currentX, currentY);
        hypnoCtx.stroke();
        
        // å½“å‰ç‚¹
        hypnoCtx.fillStyle = sleepStages[sleepState.stage].color;
        hypnoCtx.beginPath();
        hypnoCtx.arc(currentX, currentY, 5, 0, Math.PI * 2);
        hypnoCtx.fill();
    }
}

function drawDream() {
    dreamCtx.fillStyle = 'rgba(13,13,43,0.1)';
    dreamCtx.fillRect(0, 0, dreamCanvas.width, dreamCanvas.height);
    
    const cx = dreamCanvas.width / 2;
    const cy = dreamCanvas.height / 2;
    
    if (!sleepState.dreaming && sleepState.dreamIntensity < 5) {
        // éREMçŠ¶æ€ - å¹³é™çš„æ·±è‰²èƒŒæ™¯
        const gradient = dreamCtx.createRadialGradient(cx, cy, 0, cx, cy, 300);
        gradient.addColorStop(0, 'rgba(30,30,80,0.3)');
        gradient.addColorStop(1, 'rgba(13,13,43,0)');
        dreamCtx.fillStyle = gradient;
        dreamCtx.fillRect(0, 0, dreamCanvas.width, dreamCanvas.height);
        
        document.getElementById('dreamOverlay').innerHTML = `
            <div style="font-size:3em;opacity:0.3;">ğŸ˜´</div>
            <div style="color:#666;margin-top:10px;">${sleepStages[sleepState.stage].name}</div>
        `;
        return;
    }
    
    document.getElementById('dreamOverlay').innerHTML = '';
    
    // REMæ¢¦å¢ƒå¯è§†åŒ–
    dreamState.hue = (dreamState.hue + 0.2) % 360;
    dreamState.morphTime += 0.02;
    
    // æ¢¦å¢ƒç²’å­
    if (dreamState.particles.length < 100 && Math.random() < 0.1) {
        dreamState.particles.push({
            x: Math.random() * dreamCanvas.width,
            y: Math.random() * dreamCanvas.height,
            size: Math.random() * 20 + 5,
            hue: Math.random() * 360,
            speed: Math.random() * 2 + 0.5,
            angle: Math.random() * Math.PI * 2,
            life: 1
        });
    }
    
    // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
    dreamState.particles = dreamState.particles.filter(p => {
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed;
        p.angle += (Math.random() - 0.5) * 0.1;
        p.life -= 0.005;
        p.size *= 0.995;
        
        if (p.life > 0 && p.size > 1) {
            const gradient = dreamCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
            gradient.addColorStop(0, `hsla(${p.hue}, 70%, 60%, ${p.life * 0.5})`);
            gradient.addColorStop(1, `hsla(${p.hue}, 70%, 60%, 0)`);
            dreamCtx.fillStyle = gradient;
            dreamCtx.beginPath();
            dreamCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            dreamCtx.fill();
            return true;
        }
        return false;
    });
    
    // ä¸­å¿ƒæ¢¦å¢ƒæ¼©æ¶¡
    const intensity = sleepState.dreamIntensity / 100;
    for (let i = 0; i < 5; i++) {
        const radius = 50 + i * 40 + Math.sin(dreamState.morphTime + i) * 20;
        const alpha = (1 - i / 5) * intensity * 0.3;
        
        dreamCtx.strokeStyle = `hsla(${dreamState.hue + i * 30}, 70%, 60%, ${alpha})`;
        dreamCtx.lineWidth = 3;
        dreamCtx.beginPath();
        
        for (let a = 0; a < Math.PI * 2; a += 0.1) {
            const r = radius + Math.sin(a * 3 + dreamState.morphTime) * 20;
            const x = cx + Math.cos(a) * r;
            const y = cy + Math.sin(a) * r;
            if (a === 0) dreamCtx.moveTo(x, y);
            else dreamCtx.lineTo(x, y);
        }
        dreamCtx.closePath();
        dreamCtx.stroke();
    }
    
    // æ˜¾ç¤ºæ¢¦å¢ƒå…ƒç´ æ–‡å­—
    if (dreamState.elements.length > 0) {
        dreamCtx.font = '16px Arial';
        dreamCtx.textAlign = 'center';
        dreamState.elements.forEach((el, i) => {
            const angle = (i / dreamState.elements.length) * Math.PI * 2 + dreamState.morphTime * 0.5;
            const dist = 200 + Math.sin(dreamState.morphTime + i) * 30;
            const x = cx + Math.cos(angle) * dist;
            const y = cy + Math.sin(angle) * dist;
            const alpha = 0.7 - i * 0.1;
            
            dreamCtx.fillStyle = `rgba(255,255,255,${alpha})`;
            dreamCtx.fillText(el.value, x, y);
        });
    }
}

function animate() {
    simulateSleep();
    drawHypnogram();
    drawDream();
    requestAnimationFrame(animate);
}

init();
</script>
</body>
</html>