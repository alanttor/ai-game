<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­èƒ½æºæ™ºèƒ½ç®¡å®¶</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ </text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s;
        }

        body.day {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e8ed 100%);
            color: #333;
        }

        body.night {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 15px;
            gap: 15px;
        }

        .home-section {
            flex: 6;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-section {
            flex: 4;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .panel {
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        body.day .panel {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.night .panel {
            background: rgba(30, 30, 50, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.day .panel-title { color: #2c5282; }
        body.night .panel-title { color: #63b3ed; }

        /* å®¶åº­å¹³é¢å›¾ */
        .floor-plan {
            flex: 1;
            position: relative;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            min-height: 400px;
        }

        .room {
            border-radius: 10px;
            padding: 12px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        body.day .room {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border: 2px solid #e2e8f0;
        }

        body.night .room {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4a5568;
        }

        .room.lit {
            box-shadow: inset 0 0 30px rgba(255, 200, 100, 0.3);
        }

        .room-name {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .appliances {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .appliance {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
            position: relative;
        }

        body.day .appliance {
            background: #e2e8f0;
        }

        body.night .appliance {
            background: #4a5568;
        }

        .appliance.on {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.5);
        }

        .appliance.high-power.on {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(245, 101, 101, 0.5); }
            50% { box-shadow: 0 0 25px rgba(245, 101, 101, 0.8); }
        }

        .appliance.high-power.on {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .appliance-label {
            font-size: 0.5em;
            margin-top: 2px;
        }

        /* ç¯å¢ƒä¿¡æ¯ */
        .environment-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px 15px;
            border-radius: 10px;
        }

        body.day .environment-bar {
            background: linear-gradient(90deg, #ebf8ff 0%, #bee3f8 100%);
        }

        body.night .environment-bar {
            background: linear-gradient(90deg, #2a4365 0%, #2c5282 100%);
        }

        .env-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

        .env-value {
            font-weight: bold;
        }

        /* ä»ªè¡¨ç›˜ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .metric-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        body.day .metric-card {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }

        body.night .metric-card {
            background: linear-gradient(135deg, #22543d 0%, #276749 100%);
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%) !important;
        }

        body.night .metric-card.warning {
            background: linear-gradient(135deg, #744210 0%, #975a16 100%) !important;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2f855a;
        }

        body.night .metric-value {
            color: #68d391;
        }

        .metric-card.warning .metric-value {
            color: #c05621;
        }

        .metric-label {
            font-size: 0.75em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* æ§åˆ¶æ»‘å— */
        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .control-value {
            font-weight: bold;
            color: #3182ce;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            border-radius: 3px;
            outline: none;
        }

        body.day input[type="range"] {
            background: #e2e8f0;
        }

        body.night input[type="range"] {
            background: #4a5568;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3182ce;
            border-radius: 50%;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        body.day select {
            background: #fff;
            border: 1px solid #e2e8f0;
            color: #333;
        }

        body.night select {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #fff;
        }

        /* æŒ‰é’® */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3182ce;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2c5282;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        body.night .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
        }

        /* å›¾è¡¨ */
        .chart-container {
            height: 150px;
            position: relative;
        }

        /* å»ºè®®å¡ç‰‡ */
        .suggestion {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.day .suggestion {
            background: #ebf8ff;
            border-left: 3px solid #3182ce;
        }

        body.night .suggestion {
            background: #2a4365;
            border-left: 3px solid #63b3ed;
        }

        .suggestion-icon {
            font-size: 1.2em;
        }

        /* æ—¶é—´æ§åˆ¶ */
        .time-control {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        body.day .time-control {
            background: #f7fafc;
        }

        body.night .time-control {
            background: #2d3748;
        }

        .time-display {
            font-size: 1.5em;
            font-weight: bold;
            font-family: monospace;
        }

        .speed-btns {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            padding: 5px 10px;
            border: 1px solid #3182ce;
            background: transparent;
            color: #3182ce;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .speed-btn.active {
            background: #3182ce;
            color: #fff;
        }
    </style>
</head>
<body class="day">
    <div class="container">
        <div class="home-section">
            <div class="panel environment-bar">
                <div class="env-item">
                    <span>ğŸŒ¡ï¸</span>
                    <span>å®¤å¤–æ¸©åº¦:</span>
                    <span class="env-value" id="outdoorTemp">28Â°C</span>
                </div>
                <div class="env-item">
                    <span id="weatherIcon">â˜€ï¸</span>
                    <span id="weatherText">æ™´å¤©</span>
                </div>
                <div class="env-item">
                    <span>ğŸ </span>
                    <span>å®¤å†…æ¸©åº¦:</span>
                    <span class="env-value" id="indoorTemp">24Â°C</span>
                </div>
                <div class="env-item">
                    <span>â˜€ï¸</span>
                    <span>å¤ªé˜³èƒ½å‘ç”µ:</span>
                    <span class="env-value" id="solarPower">0W</span>
                </div>
                <div style="margin-left:auto">
                    <button class="btn btn-secondary" id="toggleDayNight">ğŸŒ™ åˆ‡æ¢å¤œé—´</button>
                </div>
            </div>

            <div class="panel floor-plan" id="floorPlan">
                <!-- æˆ¿é—´å°†ç”±JSç”Ÿæˆ -->
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“Š 24å°æ—¶èƒ½è€—æ›²çº¿</div>
                <div class="chart-container">
                    <canvas id="chartCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="panel">
                <div class="panel-title">â±ï¸ æ—¶é—´æ§åˆ¶</div>
                <div class="time-control">
                    <div class="time-display" id="timeDisplay">08:00</div>
                    <div class="speed-btns">
                        <button class="speed-btn" data-speed="0">â¸</button>
                        <button class="speed-btn active" data-speed="1">1x</button>
                        <button class="speed-btn" data-speed="60">60x</button>
                        <button class="speed-btn" data-speed="360">360x</button>
                    </div>
                    <select id="seasonSelect" style="width:auto">
                        <option value="summer">å¤å­£</option>
                        <option value="winter">å†¬å­£</option>
                        <option value="spring">æ˜¥ç§‹</option>
                    </select>
                </div>
            </div>

            <div class="panel dashboard">
                <div class="metric-card">
                    <div class="metric-value" id="currentPower">0</div>
                    <div class="metric-label">å½“å‰åŠŸç‡ (W)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="todayCost">0.00</div>
                    <div class="metric-label">ä»Šæ—¥è´¹ç”¨ (å…ƒ)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="carbonEmission">0.0</div>
                    <div class="metric-label">ç¢³æ’æ”¾ (kg)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="monthEstimate">0</div>
                    <div class="metric-label">é¢„ä¼°æœˆè´¹ (å…ƒ)</div>
                </div>
                <div class="metric-card" id="savingsCard">
                    <div class="metric-value" id="savingsPercent">0%</div>
                    <div class="metric-label">èŠ‚èƒ½æ¯”ä¾‹</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="energyLevel">A</div>
                    <div class="metric-label">èƒ½æ•ˆç­‰çº§</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">âš™ï¸ å‚æ•°è®¾ç½®</div>
                <div class="control-group">
                    <div class="control-label">
                        <span>ğŸŒ¡ï¸ ç©ºè°ƒæ¸©åº¦</span>
                        <span class="control-value" id="acTempVal">24Â°C</span>
                    </div>
                    <input type="range" id="acTemp" min="16" max="30" value="24">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>â„ï¸ å†°ç®±æ¸©åº¦</span>
                        <span class="control-value" id="fridgeTempVal">4Â°C</span>
                    </div>
                    <input type="range" id="fridgeTemp" min="2" max="8" value="4">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>ğŸ’¡ ç…§æ˜äº®åº¦</span>
                        <span class="control-value" id="lightVal">80%</span>
                    </div>
                    <input type="range" id="lightBrightness" min="0" max="100" value="80">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­äººæ•°</span>
                        <span class="control-value" id="familyVal">3äºº</span>
                    </div>
                    <input type="range" id="familySize" min="1" max="6" value="3">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>â˜€ï¸ å¤ªé˜³èƒ½æ¯”ä¾‹</span>
                        <span class="control-value" id="solarVal">0%</span>
                    </div>
                    <input type="range" id="solarPercent" min="0" max="100" value="0">
                </div>
                <div class="control-group">
                    <div class="control-label"><span>âš¡ ç”µä»·æ—¶æ®µ</span></div>
                    <select id="priceMode">
                        <option value="auto">è‡ªåŠ¨ï¼ˆæŒ‰æ—¶é—´ï¼‰</option>
                        <option value="peak">å³°æ—¶ (0.85å…ƒ/åº¦)</option>
                        <option value="normal">å¹³æ—¶ (0.55å…ƒ/åº¦)</option>
                        <option value="valley">è°·æ—¶ (0.35å…ƒ/åº¦)</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label"><span>ğŸ·ï¸ ç”µå™¨èƒ½æ•ˆç­‰çº§</span></div>
                    <select id="efficiencyLevel">
                        <option value="1">1çº§èƒ½æ•ˆ (æœ€èŠ‚èƒ½)</option>
                        <option value="2" selected>2çº§èƒ½æ•ˆ</option>
                        <option value="3">3çº§èƒ½æ•ˆ</option>
                        <option value="4">4çº§èƒ½æ•ˆ</option>
                        <option value="5">5çº§èƒ½æ•ˆ (æœ€è€—èƒ½)</option>
                    </select>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ’¡ æ™ºèƒ½èŠ‚èƒ½å»ºè®®</div>
                <div id="suggestions">
                    <!-- å»ºè®®å°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ¯ èŠ‚èƒ½æŒ‘æˆ˜</div>
                <div id="challenge">
                    <div style="margin-bottom:10px">
                        <strong>ä»Šæ—¥ç›®æ ‡ï¼š</strong>ç”¨ç”µé‡ä½äº <span id="targetUsage">15</span> åº¦
                    </div>
                    <div style="background:#e2e8f0;border-radius:10px;height:20px;overflow:hidden">
                        <div id="challengeProgress" style="background:linear-gradient(90deg,#48bb78,#38a169);height:100%;width:0%;transition:width 0.3s"></div>
                    </div>
                    <div style="font-size:0.8em;margin-top:5px;opacity:0.8">
                        å½“å‰: <span id="currentUsage">0</span> åº¦ / <span id="targetUsage2">15</span> åº¦
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="btn-group">
                    <button class="btn btn-primary" id="compareBtn">ğŸ“Š å¯¹æ¯”æ¨¡å¼</button>
                    <button class="btn btn-secondary" id="resetBtn">â†º é‡ç½®</button>
                    <button class="btn btn-secondary" id="allOffBtn">ğŸ”Œ å…¨éƒ¨å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        // ==================== æ•°æ®æ¨¡å‹ ====================
        const ApplianceData = {
            ac: { name: 'ç©ºè°ƒ', icon: 'â„ï¸', basePower: 1500, category: 'climate' },
            fridge: { name: 'å†°ç®±', icon: 'ğŸ§Š', basePower: 150, category: 'always', alwaysOn: true },
            tv: { name: 'ç”µè§†', icon: 'ğŸ“º', basePower: 120, category: 'entertainment' },
            light: { name: 'ç¯', icon: 'ğŸ’¡', basePower: 60, category: 'lighting' },
            washer: { name: 'æ´—è¡£æœº', icon: 'ğŸ§º', basePower: 500, category: 'appliance' },
            microwave: { name: 'å¾®æ³¢ç‚‰', icon: 'ğŸ“¡', basePower: 1000, category: 'kitchen' },
            computer: { name: 'ç”µè„‘', icon: 'ğŸ’»', basePower: 200, category: 'entertainment' },
            heater: { name: 'çƒ­æ°´å™¨', icon: 'ğŸš¿', basePower: 2000, category: 'water' },
            fan: { name: 'é£æ‰‡', icon: 'ğŸŒ€', basePower: 50, category: 'climate' },
            router: { name: 'è·¯ç”±å™¨', icon: 'ğŸ“¶', basePower: 10, category: 'always', alwaysOn: true }
        };

        const RoomData = [
            { id: 'living', name: 'å®¢å…', appliances: ['ac', 'tv', 'light', 'fan', 'router'] },
            { id: 'bedroom1', name: 'ä¸»å§', appliances: ['ac', 'light', 'computer'] },
            { id: 'bedroom2', name: 'æ¬¡å§', appliances: ['ac', 'light', 'fan'] },
            { id: 'kitchen', name: 'å¨æˆ¿', appliances: ['fridge', 'microwave', 'light'] },
            { id: 'bathroom', name: 'æµ´å®¤', appliances: ['heater', 'light'] },
            { id: 'study', name: 'ä¹¦æˆ¿', appliances: ['computer', 'light', 'ac'] }
        ];

        const PriceRates = {
            peak: 0.85,    // å³°æ—¶ 8:00-11:00, 18:00-21:00
            normal: 0.55,  // å¹³æ—¶ 7:00-8:00, 11:00-18:00, 21:00-23:00
            valley: 0.35   // è°·æ—¶ 23:00-7:00
        };

        // ==================== èƒ½æºç®¡ç†å™¨ ====================
        class EnergyManager {
            constructor() {
                this.appliances = {};
                this.params = {
                    acTemp: 24,
                    fridgeTemp: 4,
                    lightBrightness: 80,
                    familySize: 3,
                    solarPercent: 0,
                    efficiencyLevel: 2,
                    priceMode: 'auto'
                };
                
                this.time = 8 * 60; // åˆ†é’Ÿï¼Œä»8:00å¼€å§‹
                this.speed = 1;
                this.isNight = false;
                this.season = 'summer';
                this.outdoorTemp = 28;
                
                this.todayUsage = 0; // åº¦
                this.todayCost = 0;
                this.hourlyUsage = new Array(24).fill(0);
                this.baselineUsage = 20; // åŸºå‡†ç”¨ç”µé‡
                
                this.initRooms();
                this.initControls();
                this.animate();
            }
            
            initRooms() {
                const floorPlan = document.getElementById('floorPlan');
                floorPlan.innerHTML = '';
                
                RoomData.forEach(room => {
                    const roomEl = document.createElement('div');
                    roomEl.className = 'room';
                    roomEl.id = room.id;
                    
                    roomEl.innerHTML = `
                        <div class="room-name">${room.name}</div>
                        <div class="appliances">
                            ${room.appliances.map(appId => {
                                const app = ApplianceData[appId];
                                const uniqueId = `${room.id}_${appId}`;
                                this.appliances[uniqueId] = {
                                    ...app,
                                    id: uniqueId,
                                    roomId: room.id,
                                    type: appId,
                                    isOn: app.alwaysOn || false
                                };
                                const isHighPower = app.basePower >= 1000;
                                return `
                                    <div class="appliance ${app.alwaysOn ? 'on' : ''} ${isHighPower ? 'high-power' : ''}" 
                                         data-id="${uniqueId}" title="${app.name} (${app.basePower}W)">
                                        <span>${app.icon}</span>
                                        <span class="appliance-label">${app.name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    floorPlan.appendChild(roomEl);
                });
                
                // ç»‘å®šç”µå™¨ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.appliance').forEach(el => {
                    el.addEventListener('click', () => {
                        const id = el.dataset.id;
                        const app = this.appliances[id];
                        if (app.alwaysOn) return;
                        
                        app.isOn = !app.isOn;
                        el.classList.toggle('on', app.isOn);
                        this.updateRoomLighting();
                    });
                });
            }
            
            initControls() {
                // å‚æ•°æ»‘å—
                const sliders = [
                    { id: 'acTemp', param: 'acTemp', display: 'acTempVal', suffix: 'Â°C' },
                    { id: 'fridgeTemp', param: 'fridgeTemp', display: 'fridgeTempVal', suffix: 'Â°C' },
                    { id: 'lightBrightness', param: 'lightBrightness', display: 'lightVal', suffix: '%' },
                    { id: 'familySize', param: 'familySize', display: 'familyVal', suffix: 'äºº' },
                    { id: 'solarPercent', param: 'solarPercent', display: 'solarVal', suffix: '%' }
                ];
                
                sliders.forEach(s => {
                    document.getElementById(s.id).addEventListener('input', (e) => {
                        this.params[s.param] = parseInt(e.target.value);
                        document.getElementById(s.display).textContent = e.target.value + s.suffix;
                    });
                });
                
                document.getElementById('priceMode').addEventListener('change', (e) => {
                    this.params.priceMode = e.target.value;
                });
                
                document.getElementById('efficiencyLevel').addEventListener('change', (e) => {
                    this.params.efficiencyLevel = parseInt(e.target.value);
                });
                
                document.getElementById('seasonSelect').addEventListener('change', (e) => {
                    this.season = e.target.value;
                    this.updateWeather();
                });
                
                // æ—¶é—´é€Ÿåº¦æ§åˆ¶
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.speed = parseInt(btn.dataset.speed);
                    });
                });
                
                // æ—¥å¤œåˆ‡æ¢
                document.getElementById('toggleDayNight').addEventListener('click', () => {
                    this.isNight = !this.isNight;
                    document.body.className = this.isNight ? 'night' : 'day';
                    document.getElementById('toggleDayNight').textContent = 
                        this.isNight ? 'â˜€ï¸ åˆ‡æ¢ç™½å¤©' : 'ğŸŒ™ åˆ‡æ¢å¤œé—´';
                    this.updateRoomLighting();
                });
                
                // æŒ‰é’®
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                document.getElementById('allOffBtn').addEventListener('click', () => this.turnAllOff());
                document.getElementById('compareBtn').addEventListener('click', () => this.showComparison());
            }
            
            getCurrentPrice() {
                if (this.params.priceMode !== 'auto') {
                    return PriceRates[this.params.priceMode];
                }
                
                const hour = Math.floor(this.time / 60);
                if ((hour >= 8 && hour < 11) || (hour >= 18 && hour < 21)) {
                    return PriceRates.peak;
                } else if (hour >= 23 || hour < 7) {
                    return PriceRates.valley;
                }
                return PriceRates.normal;
            }
            
            calculatePower() {
                let totalPower = 0;
                const efficiencyFactor = 1 + (this.params.efficiencyLevel - 1) * 0.15;
                
                Object.values(this.appliances).forEach(app => {
                    if (!app.isOn) return;
                    
                    let power = app.basePower * efficiencyFactor;
                    
                    // ç©ºè°ƒåŠŸç‡å—æ¸©å·®å½±å“
                    if (app.type === 'ac') {
                        const tempDiff = Math.abs(this.outdoorTemp - this.params.acTemp);
                        power *= (0.5 + tempDiff * 0.05);
                    }
                    
                    // ç¯å…‰åŠŸç‡å—äº®åº¦å½±å“
                    if (app.type === 'light') {
                        power *= this.params.lightBrightness / 100;
                    }
                    
                    // å†°ç®±åŠŸç‡å—æ¸©åº¦è®¾ç½®å½±å“
                    if (app.type === 'fridge') {
                        power *= (1 + (4 - this.params.fridgeTemp) * 0.1);
                    }
                    
                    totalPower += power;
                });
                
                // å®¶åº­äººæ•°å½±å“
                totalPower *= (0.8 + this.params.familySize * 0.1);
                
                // å¤ªé˜³èƒ½æŠµæ¶ˆ
                const solarGeneration = this.getSolarGeneration();
                totalPower = Math.max(0, totalPower - solarGeneration);
                
                return totalPower;
            }
            
            getSolarGeneration() {
                if (this.params.solarPercent === 0) return 0;
                
                const hour = Math.floor(this.time / 60);
                let solarFactor = 0;
                
                // æ—¥ç…§æ›²çº¿
                if (hour >= 6 && hour <= 18) {
                    solarFactor = Math.sin((hour - 6) / 12 * Math.PI);
                }
                
                // å¤©æ°”å½±å“
                if (this.weather === 'cloudy') solarFactor *= 0.5;
                if (this.weather === 'rainy') solarFactor *= 0.2;
                
                const maxSolarPower = 3000 * (this.params.solarPercent / 100);
                return maxSolarPower * solarFactor;
            }
            
            updateWeather() {
                const hour = Math.floor(this.time / 60);
                
                // æ ¹æ®å­£èŠ‚è®¾ç½®æ¸©åº¦
                const baseTemp = this.season === 'summer' ? 32 : 
                                this.season === 'winter' ? 5 : 20;
                
                // æ—¥å¤œæ¸©å·®
                const tempVariation = Math.sin((hour - 6) / 24 * Math.PI * 2) * 5;
                this.outdoorTemp = Math.round(baseTemp + tempVariation);
                
                // éšæœºå¤©æ°”
                const weathers = ['sunny', 'cloudy', 'rainy'];
                const icons = { sunny: 'â˜€ï¸', cloudy: 'â›…', rainy: 'ğŸŒ§ï¸' };
                const texts = { sunny: 'æ™´å¤©', cloudy: 'å¤šäº‘', rainy: 'é›¨å¤©' };
                
                if (Math.random() < 0.01) {
                    this.weather = weathers[Math.floor(Math.random() * weathers.length)];
                }
                this.weather = this.weather || 'sunny';
                
                document.getElementById('outdoorTemp').textContent = this.outdoorTemp + 'Â°C';
                document.getElementById('weatherIcon').textContent = icons[this.weather];
                document.getElementById('weatherText').textContent = texts[this.weather];
                document.getElementById('solarPower').textContent = Math.round(this.getSolarGeneration()) + 'W';
                
                // å®¤å†…æ¸©åº¦
                const acOn = Object.values(this.appliances).some(a => a.type === 'ac' && a.isOn);
                const indoorTemp = acOn ? this.params.acTemp : 
                    Math.round(this.outdoorTemp * 0.7 + this.params.acTemp * 0.3);
                document.getElementById('indoorTemp').textContent = indoorTemp + 'Â°C';
            }
            
            updateRoomLighting() {
                RoomData.forEach(room => {
                    const roomEl = document.getElementById(room.id);
                    const hasLightOn = room.appliances.some(appId => {
                        const uniqueId = `${room.id}_${appId}`;
                        const app = this.appliances[uniqueId];
                        return app && app.type === 'light' && app.isOn;
                    });
                    
                    roomEl.classList.toggle('lit', hasLightOn && this.isNight);
                });
            }
            
            updateDashboard() {
                const power = this.calculatePower();
                const price = this.getCurrentPrice();
                
                // æ›´æ–°ç”¨ç”µé‡ï¼ˆæ¯åˆ†é’Ÿï¼‰
                const usagePerMinute = power / 60000; // è½¬æ¢ä¸ºåº¦/åˆ†é’Ÿ
                this.todayUsage += usagePerMinute * this.speed;
                this.todayCost += usagePerMinute * price * this.speed;
                
                // è®°å½•å°æ—¶ç”¨ç”µ
                const hour = Math.floor(this.time / 60);
                this.hourlyUsage[hour] += usagePerMinute * this.speed;
                
                // ç¢³æ’æ”¾ï¼ˆçº¦0.5kg CO2/åº¦ï¼‰
                const carbon = this.todayUsage * 0.5;
                
                // é¢„ä¼°æœˆè´¹
                const monthEstimate = this.todayCost * 30;
                
                // èŠ‚èƒ½æ¯”ä¾‹
                const savings = Math.max(0, (1 - this.todayUsage / this.baselineUsage) * 100);
                
                // èƒ½æ•ˆç­‰çº§
                const level = power < 500 ? 'A+' : power < 1000 ? 'A' : 
                             power < 2000 ? 'B' : power < 3000 ? 'C' : 'D';
                
                document.getElementById('currentPower').textContent = Math.round(power);
                document.getElementById('todayCost').textContent = this.todayCost.toFixed(2);
                document.getElementById('carbonEmission').textContent = carbon.toFixed(1);
                document.getElementById('monthEstimate').textContent = Math.round(monthEstimate);
                document.getElementById('savingsPercent').textContent = savings.toFixed(0) + '%';
                document.getElementById('energyLevel').textContent = level;
                
                // é«˜åŠŸç‡è­¦å‘Š
                const powerCard = document.querySelector('.metric-card');
                powerCard.classList.toggle('warning', power > 3000);
                
                // æ›´æ–°æŒ‘æˆ˜è¿›åº¦
                const target = 15;
                const progress = Math.min(100, (this.todayUsage / target) * 100);
                document.getElementById('challengeProgress').style.width = progress + '%';
                document.getElementById('currentUsage').textContent = this.todayUsage.toFixed(2);
            }
            
            updateSuggestions() {
                const suggestions = [];
                const hour = Math.floor(this.time / 60);
                
                // ç©ºè°ƒå»ºè®®
                const acOn = Object.values(this.appliances).some(a => a.type === 'ac' && a.isOn);
                if (acOn && Math.abs(this.outdoorTemp - this.params.acTemp) < 3) {
                    suggestions.push({ icon: 'â„ï¸', text: 'å®¤å†…å¤–æ¸©å·®å°ï¼Œå»ºè®®å…³é—­ç©ºè°ƒå¼€çª—é€šé£' });
                }
                if (this.params.acTemp < 20 && this.season === 'summer') {
                    suggestions.push({ icon: 'ğŸŒ¡ï¸', text: 'ç©ºè°ƒæ¸©åº¦è¿‡ä½ï¼Œå»ºè®®è®¾ç½®26Â°Cä»¥ä¸ŠèŠ‚èƒ½' });
                }
                
                // ç…§æ˜å»ºè®®
                const lightsOn = Object.values(this.appliances).filter(a => a.type === 'light' && a.isOn).length;
                if (lightsOn > 0 && hour >= 8 && hour <= 17 && this.weather === 'sunny') {
                    suggestions.push({ icon: 'ğŸ’¡', text: 'ç™½å¤©å…‰çº¿å……è¶³ï¼Œå»ºè®®å…³é—­éƒ¨åˆ†ç¯å…‰' });
                }
                
                // ç”µä»·å»ºè®®
                const price = this.getCurrentPrice();
                if (price === PriceRates.peak) {
                    suggestions.push({ icon: 'âš¡', text: 'å½“å‰ä¸ºå³°æ—¶ç”µä»·ï¼Œå»ºè®®å‡å°‘å¤§åŠŸç‡ç”µå™¨ä½¿ç”¨' });
                }
                if (price === PriceRates.valley) {
                    suggestions.push({ icon: 'ğŸŒ™', text: 'å½“å‰ä¸ºè°·æ—¶ç”µä»·ï¼Œé€‚åˆä½¿ç”¨æ´—è¡£æœºç­‰å¤§åŠŸç‡ç”µå™¨' });
                }
                
                // å¤ªé˜³èƒ½å»ºè®®
                if (this.params.solarPercent === 0) {
                    suggestions.push({ icon: 'â˜€ï¸', text: 'å®‰è£…å¤ªé˜³èƒ½æ¿å¯æœ‰æ•ˆé™ä½ç”µè´¹æ”¯å‡º' });
                }
                
                // èƒ½æ•ˆå»ºè®®
                if (this.params.efficiencyLevel > 2) {
                    suggestions.push({ icon: 'ğŸ·ï¸', text: 'å‡çº§ä¸º1çº§èƒ½æ•ˆç”µå™¨å¯èŠ‚çœ15%ä»¥ä¸Šç”µè´¹' });
                }
                
                const container = document.getElementById('suggestions');
                container.innerHTML = suggestions.slice(0, 4).map(s => `
                    <div class="suggestion">
                        <span class="suggestion-icon">${s.icon}</span>
                        <span>${s.text}</span>
                    </div>
                `).join('') || '<div class="suggestion"><span class="suggestion-icon">âœ…</span><span>å½“å‰ç”¨ç”µä¹ æƒ¯è‰¯å¥½ï¼</span></div>';
            }
            
            drawChart() {
                const canvas = document.getElementById('chartCanvas');
                const ctx = canvas.getContext('2d');
                const w = canvas.parentElement.clientWidth;
                const h = canvas.parentElement.clientHeight;
                
                canvas.width = w;
                canvas.height = h;
                
                ctx.fillStyle = this.isNight ? '#1a202c' : '#f7fafc';
                ctx.fillRect(0, 0, w, h);
                
                const padding = 30;
                const chartW = w - padding * 2;
                const chartH = h - padding * 2;
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = this.isNight ? '#4a5568' : '#e2e8f0';
                ctx.lineWidth = 0.5;
                
                for (let i = 0; i <= 4; i++) {
                    const y = padding + (chartH / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(w - padding, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶æŸ±çŠ¶å›¾
                const maxUsage = Math.max(...this.hourlyUsage, 1);
                const barWidth = chartW / 24 - 2;
                
                this.hourlyUsage.forEach((usage, hour) => {
                    const x = padding + (chartW / 24) * hour + 1;
                    const barH = (usage / maxUsage) * chartH;
                    const y = padding + chartH - barH;
                    
                    // æ ¹æ®ç”µä»·ç€è‰²
                    let color;
                    if ((hour >= 8 && hour < 11) || (hour >= 18 && hour < 21)) {
                        color = '#f56565'; // å³°æ—¶çº¢è‰²
                    } else if (hour >= 23 || hour < 7) {
                        color = '#48bb78'; // è°·æ—¶ç»¿è‰²
                    } else {
                        color = '#4299e1'; // å¹³æ—¶è“è‰²
                    }
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, barWidth, barH);
                });
                
                // å½“å‰æ—¶é—´æŒ‡ç¤º
                const currentHour = Math.floor(this.time / 60);
                const indicatorX = padding + (chartW / 24) * currentHour + barWidth / 2;
                ctx.strokeStyle = '#ed8936';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(indicatorX, padding);
                ctx.lineTo(indicatorX, padding + chartH);
                ctx.stroke();
                
                // Xè½´æ ‡ç­¾
                ctx.fillStyle = this.isNight ? '#a0aec0' : '#718096';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                for (let i = 0; i < 24; i += 3) {
                    const x = padding + (chartW / 24) * i + barWidth / 2;
                    ctx.fillText(i + ':00', x, h - 5);
                }
            }
            
            updateTime() {
                this.time += this.speed;
                if (this.time >= 24 * 60) {
                    this.time = 0;
                    this.todayUsage = 0;
                    this.todayCost = 0;
                    this.hourlyUsage = new Array(24).fill(0);
                }
                
                const hours = Math.floor(this.time / 60);
                const mins = Math.floor(this.time % 60);
                document.getElementById('timeDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                
                // è‡ªåŠ¨æ—¥å¤œåˆ‡æ¢
                const shouldBeNight = hours >= 19 || hours < 6;
                if (shouldBeNight !== this.isNight) {
                    this.isNight = shouldBeNight;
                    document.body.className = this.isNight ? 'night' : 'day';
                    document.getElementById('toggleDayNight').textContent = 
                        this.isNight ? 'â˜€ï¸ åˆ‡æ¢ç™½å¤©' : 'ğŸŒ™ åˆ‡æ¢å¤œé—´';
                    this.updateRoomLighting();
                }
            }
            
            reset() {
                this.time = 8 * 60;
                this.todayUsage = 0;
                this.todayCost = 0;
                this.hourlyUsage = new Array(24).fill(0);
                
                Object.values(this.appliances).forEach(app => {
                    if (!app.alwaysOn) app.isOn = false;
                });
                
                document.querySelectorAll('.appliance').forEach(el => {
                    const id = el.dataset.id;
                    const app = this.appliances[id];
                    el.classList.toggle('on', app.isOn);
                });
                
                this.updateRoomLighting();
            }
            
            turnAllOff() {
                Object.values(this.appliances).forEach(app => {
                    if (!app.alwaysOn) app.isOn = false;
                });
                
                document.querySelectorAll('.appliance').forEach(el => {
                    const id = el.dataset.id;
                    const app = this.appliances[id];
                    el.classList.toggle('on', app.isOn);
                });
                
                this.updateRoomLighting();
            }
            
            showComparison() {
                const currentUsage = this.todayUsage;
                const baselineUsage = this.baselineUsage;
                const savings = ((baselineUsage - currentUsage) / baselineUsage * 100).toFixed(1);
                const moneySaved = ((baselineUsage - currentUsage) * 0.55).toFixed(2);
                
                alert(`ğŸ“Š èƒ½è€—å¯¹æ¯”\n\nåŸºå‡†ç”¨ç”µ: ${baselineUsage.toFixed(2)} åº¦\nå½“å‰ç”¨ç”µ: ${currentUsage.toFixed(2)} åº¦\n\nèŠ‚èƒ½æ¯”ä¾‹: ${savings}%\né¢„è®¡èŠ‚çœ: Â¥${moneySaved}/å¤©`);
            }
            
            animate() {
                this.updateTime();
                this.updateWeather();
                this.updateDashboard();
                this.updateSuggestions();
                this.drawChart();
                
                requestAnimationFrame(() => this.animate());
            }
        }

        // å¯åŠ¨æ¨¡æ‹Ÿå™¨
        new EnergyManager();
    </script>
</body>
</html>
