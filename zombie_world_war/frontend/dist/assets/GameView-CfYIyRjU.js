import{d as ie,h as x,j as C,l as o,q as Ze,t as y,s as se,n as te,o as T,r as N,x as Ke,k as W,w as ce,v as de,g as Oe,y as Ce,i as $e,z as Ye,u as Le,F as je,p as Se,c as Xe,A as Je}from"./vue-vendor-CeuWReVY.js";import{G as z,M as O,P as Ge,a as v,B as D,V as c,b as be,C as $,c as Re,S as fe,d as Qe,e as pe,F as ge,f as ze,W as qe,g as et,h as tt,A as st,i as it,D as at,H as nt,R as ae,L as rt,j as ot,E as _e,Q as ht,k as lt,l as ut,m as mt,n as ct,o as dt,p as Ie,q as pt,r as gt}from"./three-DQLkNgDZ.js";import{G as R,W as Me,Z as M,a as b,u as Ne,g as ft}from"./game-DfiOVufx.js";import{u as We}from"./client-CIWp8brx.js";import{l as vt}from"./leaderboard-CE2hxYMA.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Pe=(r=>(r.FORWARD="KeyW",r.LEFT="KeyA",r.BACKWARD="KeyS",r.RIGHT="KeyD",r.JUMP="Space",r.SPRINT="ShiftLeft",r.RELOAD="KeyR",r.WEAPON_1="Digit1",r.WEAPON_2="Digit2",r.WEAPON_3="Digit3",r.WEAPON_4="Digit4",r.PAUSE="Escape",r.INVENTORY="Tab",r))(Pe||{}),Ae=(r=>(r.KEY_DOWN="input:keydown",r.KEY_UP="input:keyup",r.MOUSE_DOWN="input:mousedown",r.MOUSE_UP="input:mouseup",r.MOUSE_MOVE="input:mousemove",r.MOUSE_WHEEL="input:mousewheel",r.POINTER_LOCK_CHANGE="input:pointerlockchange",r))(Ae||{});class _t{keysPressed=new Set;keysJustPressed=new Set;keysJustReleased=new Set;mouseButtonsPressed=new Set;mouseButtonsJustPressed=new Set;mouseButtonsJustReleased=new Set;mouseMovement={movementX:0,movementY:0,clientX:0,clientY:0};mouseWheelDelta=0;isPointerLocked=!1;targetElement=null;mouseSensitivity=.002;eventListeners=new Map;boundKeyDown;boundKeyUp;boundMouseDown;boundMouseUp;boundMouseMove;boundMouseWheel;boundPointerLockChange;boundContextMenu;constructor(){this.boundKeyDown=this.handleKeyDown.bind(this),this.boundKeyUp=this.handleKeyUp.bind(this),this.boundMouseDown=this.handleMouseDown.bind(this),this.boundMouseUp=this.handleMouseUp.bind(this),this.boundMouseMove=this.handleMouseMove.bind(this),this.boundMouseWheel=this.handleMouseWheel.bind(this),this.boundPointerLockChange=this.handlePointerLockChange.bind(this),this.boundContextMenu=e=>e.preventDefault()}init(e){this.targetElement=e,window.addEventListener("keydown",this.boundKeyDown),window.addEventListener("keyup",this.boundKeyUp),e.addEventListener("mousedown",this.boundMouseDown),window.addEventListener("mouseup",this.boundMouseUp),window.addEventListener("mousemove",this.boundMouseMove),e.addEventListener("wheel",this.boundMouseWheel,{passive:!1}),document.addEventListener("pointerlockchange",this.boundPointerLockChange),e.addEventListener("contextmenu",this.boundContextMenu)}dispose(){window.removeEventListener("keydown",this.boundKeyDown),window.removeEventListener("keyup",this.boundKeyUp),this.targetElement&&(this.targetElement.removeEventListener("mousedown",this.boundMouseDown),this.targetElement.removeEventListener("wheel",this.boundMouseWheel),this.targetElement.removeEventListener("contextmenu",this.boundContextMenu)),window.removeEventListener("mouseup",this.boundMouseUp),window.removeEventListener("mousemove",this.boundMouseMove),document.removeEventListener("pointerlockchange",this.boundPointerLockChange),this.exitPointerLock(),this.clearState()}clearState(){this.keysPressed.clear(),this.keysJustPressed.clear(),this.keysJustReleased.clear(),this.mouseButtonsPressed.clear(),this.mouseButtonsJustPressed.clear(),this.mouseButtonsJustReleased.clear(),this.mouseMovement={movementX:0,movementY:0,clientX:0,clientY:0},this.mouseWheelDelta=0}update(){this.keysJustPressed.clear(),this.keysJustReleased.clear(),this.mouseButtonsJustPressed.clear(),this.mouseButtonsJustReleased.clear(),this.mouseMovement.movementX=0,this.mouseMovement.movementY=0,this.mouseWheelDelta=0}handleKeyDown(e){this.isGameKey(e.code)&&e.preventDefault(),this.keysPressed.has(e.code)||(this.keysPressed.add(e.code),this.keysJustPressed.add(e.code),this.emit("input:keydown",{code:e.code,key:e.key}))}handleKeyUp(e){this.keysPressed.has(e.code)&&(this.keysPressed.delete(e.code),this.keysJustReleased.add(e.code),this.emit("input:keyup",{code:e.code,key:e.key}))}isKeyPressed(e){return this.keysPressed.has(e)}isKeyJustPressed(e){return this.keysJustPressed.has(e)}isKeyJustReleased(e){return this.keysJustReleased.has(e)}isGameKey(e){return Object.values(Pe).includes(e)}handleMouseDown(e){this.mouseButtonsPressed.has(e.button)||(this.mouseButtonsPressed.add(e.button),this.mouseButtonsJustPressed.add(e.button),this.emit("input:mousedown",{button:e.button})),e.button===0&&!this.isPointerLocked&&this.requestPointerLock()}handleMouseUp(e){this.mouseButtonsPressed.has(e.button)&&(this.mouseButtonsPressed.delete(e.button),this.mouseButtonsJustReleased.add(e.button),this.emit("input:mouseup",{button:e.button}))}handleMouseMove(e){this.isPointerLocked&&(this.mouseMovement.movementX+=e.movementX,this.mouseMovement.movementY+=e.movementY),this.mouseMovement.clientX=e.clientX,this.mouseMovement.clientY=e.clientY,this.emit("input:mousemove",{movementX:e.movementX*this.mouseSensitivity,movementY:e.movementY*this.mouseSensitivity,clientX:e.clientX,clientY:e.clientY})}handleMouseWheel(e){e.preventDefault(),this.mouseWheelDelta=e.deltaY;const t=e.deltaY>0?"down":"up";this.emit("input:mousewheel",{deltaY:e.deltaY,direction:t})}isMouseButtonPressed(e){return this.mouseButtonsPressed.has(e)}isMouseButtonJustPressed(e){return this.mouseButtonsJustPressed.has(e)}isMouseButtonJustReleased(e){return this.mouseButtonsJustReleased.has(e)}getMouseMovement(){return{movementX:this.mouseMovement.movementX*this.mouseSensitivity,movementY:this.mouseMovement.movementY*this.mouseSensitivity,clientX:this.mouseMovement.clientX,clientY:this.mouseMovement.clientY}}getMouseWheelDelta(){return this.mouseWheelDelta}getMouseWheelDirection(){return this.mouseWheelDelta===0?0:this.mouseWheelDelta>0?1:-1}handlePointerLockChange(){this.isPointerLocked=document.pointerLockElement===this.targetElement,this.emit("input:pointerlockchange",{locked:this.isPointerLocked})}requestPointerLock(){this.targetElement&&!this.isPointerLocked&&this.targetElement.requestPointerLock()}exitPointerLock(){this.isPointerLocked&&document.exitPointerLock()}hasPointerLock(){return this.isPointerLocked}setMouseSensitivity(e){this.mouseSensitivity=Math.max(1e-4,Math.min(.01,e))}getMouseSensitivity(){return this.mouseSensitivity}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}getMovementInput(){let e=0,t=0;this.isKeyPressed("KeyW")&&(t-=1),this.isKeyPressed("KeyS")&&(t+=1),this.isKeyPressed("KeyA")&&(e-=1),this.isKeyPressed("KeyD")&&(e+=1);const s=Math.sqrt(e*e+t*t);return s>0&&(e/=s,t/=s),{x:e,z:t}}wantsToJump(){return this.isKeyJustPressed("Space")}wantsToSprint(){return this.isKeyPressed("ShiftLeft")}wantsToReload(){return this.isKeyJustPressed("KeyR")}wantsToFire(){return this.isMouseButtonPressed(0)}getWeaponSlotPressed(){return this.isKeyJustPressed("Digit1")?0:this.isKeyJustPressed("Digit2")?1:this.isKeyJustPressed("Digit3")?2:this.isKeyJustPressed("Digit4")?3:-1}}class wt{scene;buildings;streets;obstacles;decorations;materials=new Map;collisionMeshes=[];constructor(e){this.scene=e,this.buildings=new z,this.buildings.name="buildings",this.streets=new z,this.streets.name="streets",this.obstacles=new z,this.obstacles.name="obstacles",this.decorations=new z,this.decorations.name="decorations",this.initMaterials()}initMaterials(){this.materials.set("building_concrete",new O({color:5592405,roughness:.9,metalness:.1})),this.materials.set("building_brick",new O({color:9127187,roughness:.85,metalness:.05})),this.materials.set("building_damaged",new O({color:3815994,roughness:.95,metalness:.05})),this.materials.set("window_dark",new O({color:1118498,roughness:.1,metalness:.8})),this.materials.set("window_lit",new O({color:16764006,emissive:16764006,emissiveIntensity:.3,roughness:.1,metalness:.5})),this.materials.set("asphalt",new O({color:2236962,roughness:.95,metalness:0})),this.materials.set("sidewalk",new O({color:6710886,roughness:.9,metalness:0})),this.materials.set("metal_rusty",new O({color:9127187,roughness:.8,metalness:.6})),this.materials.set("car_body",new O({color:3355460,roughness:.4,metalness:.7})),this.materials.set("wood",new O({color:6636321,roughness:.9,metalness:0}))}build(){this.createStreets(),this.createBuildings(),this.createObstacles(),this.createDecorations(),this.scene.add(this.buildings),this.scene.add(this.streets),this.scene.add(this.obstacles),this.scene.add(this.decorations)}createStreets(){const e=this.materials.get("asphalt"),t=this.materials.get("sidewalk"),s=this.createStreet(20,200,e);s.position.set(0,.01,0),this.streets.add(s);for(let n=-80;n<=80;n+=40){const h=this.createStreet(15,100,e);h.rotation.y=Math.PI/2,h.position.set(0,.01,n),this.streets.add(h)}const i=this.createSidewalk(4,200,t);i.position.set(-12,.02,0),this.streets.add(i);const a=this.createSidewalk(4,200,t);a.position.set(12,.02,0),this.streets.add(a)}createStreet(e,t,s){const i=new Ge(e,t),a=new v(i,s);return a.rotation.x=-Math.PI/2,a.receiveShadow=!0,a.name="street",a}createSidewalk(e,t,s){const i=new D(e,.15,t),a=new v(i,s);return a.receiveShadow=!0,a.castShadow=!0,a.name="sidewalk",a}createBuildings(){const e=[{width:15,depth:20,height:25,floors:5,hasWindows:!0,isDamaged:!1,position:new c(-25,0,-70)},{width:20,depth:25,height:35,floors:7,hasWindows:!0,isDamaged:!0,position:new c(-30,0,-35)},{width:18,depth:18,height:20,floors:4,hasWindows:!0,isDamaged:!1,position:new c(-25,0,10)},{width:22,depth:22,height:40,floors:8,hasWindows:!0,isDamaged:!0,position:new c(-28,0,50)},{width:16,depth:20,height:30,floors:6,hasWindows:!0,isDamaged:!1,position:new c(-25,0,85)}],t=[{width:18,depth:22,height:30,floors:6,hasWindows:!0,isDamaged:!0,position:new c(25,0,-75)},{width:15,depth:18,height:22,floors:4,hasWindows:!0,isDamaged:!1,position:new c(22,0,-40)},{width:25,depth:25,height:45,floors:9,hasWindows:!0,isDamaged:!1,position:new c(30,0,5)},{width:20,depth:20,height:28,floors:5,hasWindows:!0,isDamaged:!0,position:new c(25,0,45)},{width:17,depth:22,height:32,floors:6,hasWindows:!0,isDamaged:!1,position:new c(24,0,80)}];[...e,...t].forEach((i,a)=>{const n=this.createBuilding(i);n.name=`building_${a}`,this.buildings.add(n)})}createBuilding(e){const t=new z,s=e.isDamaged?"building_damaged":Math.random()>.5?"building_concrete":"building_brick",i=this.materials.get(s),a=new D(e.width,e.height,e.depth),n=new v(a,i);return n.position.y=e.height/2,n.castShadow=!0,n.receiveShadow=!0,n.name="building_body",t.add(n),this.collisionMeshes.push(n),e.hasWindows&&this.addWindowsToBuilding(t,e),e.isDamaged&&this.addDamageEffects(t,e),this.addRoofDetails(t,e),t.position.copy(e.position),t}addWindowsToBuilding(e,t){const n=t.height/t.floors,h=new D(1.5,2,.1);for(let u=0;u<t.floors;u++){const m=Math.floor(t.width/4),d=-(m-1)*2;for(let p=0;p<m;p++){const S=Math.random()>.7,g=this.materials.get(S?"window_lit":"window_dark"),_=new v(h,g);_.position.set(d+p*4,n*(u+.5),t.depth/2+.05),e.add(_);const G=new v(h,g);G.position.set(d+p*4,n*(u+.5),-t.depth/2-.05),e.add(G)}}}addDamageEffects(e,t){const s=new be({color:0}),i=Math.floor(Math.random()*3)+1;for(let a=0;a<i;a++){const n=2+Math.random()*3,h=2+Math.random()*4,u=new D(n,h,.5),m=new v(u,s),d=Math.random()>.5?1:-1;m.position.set((Math.random()-.5)*t.width*.6,Math.random()*t.height*.7+t.height*.2,d*(t.depth/2+.1)),e.add(m)}}addRoofDetails(e,t){const s=this.materials.get("metal_rusty");if(Math.random()>.3){const i=new D(3,1.5,2),a=new v(i,s);a.position.set((Math.random()-.5)*t.width*.5,t.height+.75,(Math.random()-.5)*t.depth*.5),a.castShadow=!0,e.add(a)}if(Math.random()>.5){const i=new $(1.5,1.5,3,8),a=new v(i,s);a.position.set((Math.random()-.5)*t.width*.4,t.height+1.5,(Math.random()-.5)*t.depth*.4),a.castShadow=!0,e.add(a)}}createObstacles(){[new c(-5,0,-50),new c(6,0,-20),new c(-7,0,30),new c(4,0,60),new c(-3,0,-80),new c(8,0,90)].forEach((a,n)=>{const h=this.createCar();h.position.copy(a),h.rotation.y=Math.random()*Math.PI*2,h.name=`car_${n}`,this.obstacles.add(h)}),[new c(-8,0,0),new c(8,0,0),new c(0,0,-60)].forEach((a,n)=>{const h=this.createBarrier();h.position.copy(a),h.name=`barrier_${n}`,this.obstacles.add(h)}),[new c(-15,0,-45),new c(15,0,25),new c(-12,0,70),new c(18,0,-70)].forEach((a,n)=>{const h=this.createDebrisPile();h.position.copy(a),h.name=`debris_${n}`,this.obstacles.add(h)}),[new c(-14,0,15),new c(16,0,-30),new c(-16,0,55)].forEach((a,n)=>{const h=this.createCrateStack();h.position.copy(a),h.name=`crates_${n}`,this.obstacles.add(h)})}createCar(){const e=new z,t=this.materials.get("car_body"),s=this.materials.get("metal_rusty"),i=new D(4,1.2,2),a=new v(i,t);a.position.y=.8,a.castShadow=!0,a.receiveShadow=!0,e.add(a),this.collisionMeshes.push(a);const n=new D(2.5,1,1.8),h=new v(n,t);h.position.set(-.3,1.9,0),h.castShadow=!0,e.add(h);const u=new $(.4,.4,.3,16);return[new c(1.2,.4,1.1),new c(1.2,.4,-1.1),new c(-1.2,.4,1.1),new c(-1.2,.4,-1.1)].forEach(d=>{const p=new v(u,s);p.position.copy(d),p.rotation.x=Math.PI/2,p.castShadow=!0,e.add(p)}),e}createBarrier(){const e=new z,t=this.materials.get("metal_rusty"),s=new D(3,1,.5),i=new v(s,t);i.position.y=.5,i.castShadow=!0,i.receiveShadow=!0,e.add(i),this.collisionMeshes.push(i);const a=new D(.2,1,.8),n=new v(a,t);n.position.set(-1.2,.5,0),n.castShadow=!0,e.add(n);const h=new v(a,t);return h.position.set(1.2,.5,0),h.castShadow=!0,e.add(h),e}createDebrisPile(){const e=new z,t=this.materials.get("building_damaged"),s=this.materials.get("metal_rusty"),i=5+Math.floor(Math.random()*5);for(let a=0;a<i;a++){const n=.3+Math.random()*1.5,h=new D(n,n*.5,n*.8),u=Math.random()>.3?t:s,m=new v(h,u);m.position.set((Math.random()-.5)*4,n*.25,(Math.random()-.5)*4),m.rotation.set(Math.random()*.5,Math.random()*Math.PI,Math.random()*.5),m.castShadow=!0,m.receiveShadow=!0,e.add(m)}return e}createCrateStack(){const e=new z,t=this.materials.get("wood"),s=1.2,i=new D(s,s,s),a=2+Math.floor(Math.random()*2);for(let n=0;n<a;n++){const h=new v(i,t);h.position.set(n*s*1.1-(a-1)*s*.55,s/2,0),h.castShadow=!0,h.receiveShadow=!0,e.add(h),this.collisionMeshes.push(h)}if(Math.random()>.3){const n=new v(i,t);n.position.set(0,s*1.5,0),n.rotation.y=Math.random()*.3,n.castShadow=!0,n.receiveShadow=!0,e.add(n)}return e}createDecorations(){for(let t=-90;t<=90;t+=20){const s=this.createStreetLight();s.position.set(-11,0,t),this.decorations.add(s);const i=this.createStreetLight();i.position.set(11,0,t),i.rotation.y=Math.PI,this.decorations.add(i)}[new c(-14,0,-25),new c(14,0,40),new c(-13,0,65)].forEach((t,s)=>{const i=this.createFireBarrel();i.position.copy(t),i.name=`fire_barrel_${s}`,this.decorations.add(i)}),this.addTrashDecoration()}createStreetLight(){const e=new z,t=this.materials.get("metal_rusty"),s=new $(.1,.15,5,8),i=new v(s,t);i.position.y=2.5,i.castShadow=!0,e.add(i);const a=new D(1.5,.1,.1),n=new v(a,t);n.position.set(.75,5,0),n.castShadow=!0,e.add(n);const h=new D(.4,.2,.3),u=new O({color:3355443,roughness:.5,metalness:.8}),m=new v(h,u);m.position.set(1.5,4.9,0),e.add(m);const d=new Re(16755285,.5,15);return d.position.set(1.5,4.8,0),d.castShadow=!0,d.shadow.mapSize.width=512,d.shadow.mapSize.height=512,e.add(d),e}createFireBarrel(){const e=new z,t=this.materials.get("metal_rusty"),s=new $(.4,.35,1,12),i=new v(s,t);i.position.y=.5,i.castShadow=!0,i.receiveShadow=!0,e.add(i);const a=new Re(16737792,1,8);a.position.y=1.2,a.castShadow=!1,e.add(a);const n=new fe(.3,8,8),h=new be({color:16729088,transparent:!0,opacity:.6}),u=new v(n,h);return u.position.y=1,e.add(u),e}addTrashDecoration(){const e=new O({color:4473924,roughness:.9});for(let t=0;t<50;t++){const s=.1+Math.random()*.3,i=new D(s,s*.3,s*.8),a=new v(i,e);a.position.set((Math.random()-.5)*180,s*.15,(Math.random()-.5)*180),a.rotation.y=Math.random()*Math.PI*2,a.receiveShadow=!0,this.decorations.add(a)}}getCollisionMeshes(){return this.collisionMeshes}getZombieSpawnPoints(){const e=[],t=[40,60,80],s=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,5*Math.PI/4,3*Math.PI/2,7*Math.PI/4];return t.forEach(i=>{s.forEach(a=>{e.push(new c(Math.cos(a)*i,0,Math.sin(a)*i))})}),e}dispose(){this.materials.forEach(t=>t.dispose()),this.materials.clear();const e=t=>{t.traverse(s=>{s instanceof v&&s.geometry.dispose()})};e(this.buildings),e(this.streets),e(this.obstacles),e(this.decorations),this.collisionMeshes=[]}}const Mt={exterior:{ambientColor:4210752,ambientIntensity:.5,directionalColor:16777215,directionalIntensity:1,directionalPosition:new c(50,100,50),hemisphereTopColor:8900331,hemisphereBottomColor:3550502,hemisphereIntensity:.3},interior:{ambientColor:3158064,ambientIntensity:.8,directionalColor:16774630,directionalIntensity:.3,directionalPosition:new c(0,10,0),hemisphereTopColor:4473924,hemisphereBottomColor:2236962,hemisphereIntensity:.2},night:{ambientColor:1052704,ambientIntensity:.3,directionalColor:8947967,directionalIntensity:.2,directionalPosition:new c(-50,80,-50),hemisphereTopColor:657952,hemisphereBottomColor:0,hemisphereIntensity:.1}};class yt{scene;camera;renderer;container;ambientLight;directionalLight;hemisphereLight;currentPreset="exterior";raycaster;eventListeners=new Map;gameObjects=new Map;citySceneBuilder=null;boundHandleResize;constructor(e){this.container=e,this.scene=new Qe,this.scene.background=new pe(1710638),this.scene.fog=new ge(1710638,50,200),this.camera=new ze(75,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,1.7,0),this.renderer=new qe({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=et,this.renderer.outputColorSpace=tt,this.renderer.toneMapping=st,this.renderer.toneMappingExposure=1,this.ambientLight=new it(4210752,.5),this.directionalLight=new at(16777215,1),this.hemisphereLight=new nt(8900331,3550502,.3),this.raycaster=new ae}async init(){this.container.appendChild(this.renderer.domElement),this.setupLighting(),this.setupDefaultScene(),this.boundHandleResize=this.handleResize.bind(this),window.addEventListener("resize",this.boundHandleResize),this.emit("scene:loaded",{preset:this.currentPreset})}setupLighting(){this.scene.add(this.ambientLight),this.directionalLight.position.set(50,100,50),this.directionalLight.castShadow=!0,this.directionalLight.shadow.mapSize.width=2048,this.directionalLight.shadow.mapSize.height=2048,this.directionalLight.shadow.camera.near=.5,this.directionalLight.shadow.camera.far=500,this.directionalLight.shadow.camera.left=-100,this.directionalLight.shadow.camera.right=100,this.directionalLight.shadow.camera.top=100,this.directionalLight.shadow.camera.bottom=-100,this.directionalLight.shadow.bias=-1e-4,this.scene.add(this.directionalLight),this.scene.add(this.hemisphereLight),this.applyLightingPreset("exterior")}setupDefaultScene(){const e=new Ge(200,200),t=new O({color:3355443,roughness:.9,metalness:.1}),s=new v(e,t);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,s.name="ground",this.scene.add(s),this.gameObjects.set("ground",s),this.citySceneBuilder=new wt(this.scene),this.citySceneBuilder.build()}async loadScene(e){switch(this.clearScene(),e){case"city":default:this.setupDefaultScene();break}this.emit("scene:loaded",{scene:e})}clearScene(){this.citySceneBuilder&&(this.citySceneBuilder.dispose(),this.citySceneBuilder=null);const e=[];this.scene.traverse(t=>{!(t instanceof rt)&&t!==this.scene&&e.push(t)}),e.forEach(t=>{t.parent===this.scene&&this.scene.remove(t)}),this.gameObjects.clear()}getZombieSpawnPoints(){return this.citySceneBuilder?this.citySceneBuilder.getZombieSpawnPoints():[new c(50,0,0),new c(-50,0,0),new c(0,0,50),new c(0,0,-50)]}getCollisionMeshes(){return this.citySceneBuilder?this.citySceneBuilder.getCollisionMeshes():[]}applyLightingPreset(e){const t=Mt[e];if(!t){console.warn(`Lighting preset "${e}" not found`);return}this.currentPreset=e,this.ambientLight.color.setHex(t.ambientColor),this.ambientLight.intensity=t.ambientIntensity,this.directionalLight.color.setHex(t.directionalColor),this.directionalLight.intensity=t.directionalIntensity,this.directionalLight.position.copy(t.directionalPosition),this.hemisphereLight.color.setHex(t.hemisphereTopColor),this.hemisphereLight.groundColor.setHex(t.hemisphereBottomColor),this.hemisphereLight.intensity=t.hemisphereIntensity,e==="night"?(this.scene.fog=new ge(657952,30,150),this.scene.background=new pe(657952)):e==="interior"?(this.scene.fog=new ge(2236962,20,100),this.scene.background=new pe(2236962)):(this.scene.fog=new ge(1710638,50,200),this.scene.background=new pe(1710638)),this.emit("scene:lightingchanged",{preset:e})}updateLighting(e){const s=this.checkIfInterior(e)?"interior":"exterior";s!==this.currentPreset&&this.applyLightingPreset(s)}checkIfInterior(e){return this.raycaster.set(e,new c(0,1,0)),this.raycaster.intersectObjects(this.scene.children,!0).some(s=>s.distance<10&&s.object.name.includes("ceiling"))}addObject(e,t){this.scene.add(e),t&&this.gameObjects.set(t,e),this.emit("scene:objectadded",{object:e,id:t})}removeObject(e){this.scene.remove(e);for(const[t,s]of this.gameObjects)if(s===e){this.gameObjects.delete(t);break}this.emit("scene:objectremoved",{object:e})}removeObjectById(e){const t=this.gameObjects.get(e);t&&(this.scene.remove(t),this.gameObjects.delete(e),this.emit("scene:objectremoved",{object:t,id:e}))}getObjectById(e){return this.gameObjects.get(e)}checkCollision(e,t,s=1/0){return this.raycaster.set(e,t.normalize()),this.raycaster.far=s,this.raycaster.intersectObjects(this.scene.children,!0)}checkCameraCollision(e=1/0){return this.raycaster.setFromCamera(new ot(0,0),this.camera),this.raycaster.far=e,this.raycaster.intersectObjects(this.scene.children,!0)}render(){this.renderer.render(this.scene,this.camera)}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}dispose(){this.boundHandleResize&&window.removeEventListener("resize",this.boundHandleResize),this.citySceneBuilder&&(this.citySceneBuilder.dispose(),this.citySceneBuilder=null);const e=[];this.scene.traverse(t=>{e.push(t)});for(const t of e)t instanceof v&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{this.disposeMaterial(s)}):this.disposeMaterial(t.material)));for(;this.scene.children.length>0;)this.scene.remove(this.scene.children[0]);this.renderer.dispose(),this.renderer.forceContextLoss(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.gameObjects.clear(),this.eventListeners.clear()}disposeMaterial(e){e.dispose();const t=e;t.map&&t.map.dispose(),t.normalMap&&t.normalMap.dispose(),t.roughnessMap&&t.roughnessMap.dispose(),t.metalnessMap&&t.metalnessMap.dispose(),t.aoMap&&t.aoMap.dispose(),t.emissiveMap&&t.emissiveMap.dispose()}getScene(){return this.scene}getCamera(){return this.camera}getRenderer(){return this.renderer}getCurrentPreset(){return this.currentPreset}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}}class St{sceneManager;inputManager;isRunning=!1;isPaused=!1;lastTime=0;animationFrameId=null;targetFPS=60;frameTime=1e3/60;accumulator=0;eventListeners=new Map;gameState=null;constructor(e){this.sceneManager=new yt(e),this.inputManager=new _t}async init(){await this.sceneManager.init(),this.inputManager.init(this.sceneManager.getRenderer().domElement),this.setupInputHandlers(),this.initializeGameState(),this.emit(R.GAME_START,{initialized:!0})}setupInputHandlers(){this.inputManager.on(Ae.KEY_DOWN,e=>{e.code===Pe.PAUSE&&(this.isPaused?this.resume():this.pause())}),this.inputManager.on(Ae.POINTER_LOCK_CHANGE,e=>{!e.locked&&this.isRunning&&!this.isPaused&&this.pause()})}initializeGameState(){this.gameState={player:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},health:100,stamina:100,weapons:[],currentWeaponIndex:0},wave:{currentWave:1,zombiesKilled:0,totalZombiesInWave:0,isPreparationPhase:!0},zombies:[],score:0,playTime:0,timestamp:Date.now()}}start(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTime=performance.now(),this.emit(R.GAME_START),this.gameLoop())}pause(){!this.isRunning||this.isPaused||(this.isPaused=!0,this.emit(R.GAME_PAUSE))}resume(){!this.isRunning||!this.isPaused||(this.isPaused=!1,this.lastTime=performance.now(),this.emit(R.GAME_RESUME),this.gameLoop())}stop(){this.isRunning=!1,this.isPaused=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emit(R.GAME_STOP),this.cleanup()}gameLoop(){if(!this.isRunning||this.isPaused)return;const e=performance.now(),t=e-this.lastTime;this.lastTime=e,this.accumulator+=t,this.accumulator>200&&(this.accumulator=200);let s=0;const i=5;for(;this.accumulator>=this.frameTime&&s<i;)this.fixedUpdate(this.frameTime/1e3),this.accumulator-=this.frameTime,s++;s>=i&&(this.accumulator=0);const a=this.accumulator/this.frameTime;this.update(t/1e3,a),this.render(),this.inputManager.update(),this.animationFrameId=requestAnimationFrame(()=>this.gameLoop())}fixedUpdate(e){this.gameState&&(this.gameState.playTime+=e),this.processInput(e)}update(e,t){if(this.gameState){const s=new c(this.gameState.player.position.x,this.gameState.player.position.y,this.gameState.player.position.z);this.sceneManager.updateLighting(s)}}processInput(e){if(!this.gameState)return;const t=this.inputManager.getMovementInput(),s=this.inputManager.getMouseMovement(),i=this.inputManager.getMouseWheelDirection();i!==0&&this.emit("weapon:cycle",{direction:i});const a=this.inputManager.getWeaponSlotPressed();a>=0&&this.emit("weapon:select",{slot:a}),this.inputManager.wantsToReload()&&this.emit("weapon:reload",{}),this.inputManager.wantsToFire()&&this.emit("weapon:fire",{}),this.inputManager.wantsToJump()&&this.emit("player:jump",{}),this.emit("player:move",{movement:t,mouseMovement:s,sprint:this.inputManager.wantsToSprint(),deltaTime:e})}render(){this.sceneManager.render()}getState(){return this.gameState}setState(e){this.gameState=e}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}cleanup(){this.inputManager.dispose(),this.sceneManager.dispose(),this.eventListeners.clear()}getSceneManager(){return this.sceneManager}getInputManager(){return this.inputManager}getScene(){return this.sceneManager.getScene()}getCamera(){return this.sceneManager.getCamera()}getRenderer(){return this.sceneManager.getRenderer()}isGameRunning(){return this.isRunning}isGamePaused(){return this.isPaused}getTargetFPS(){return this.targetFPS}setTargetFPS(e){this.targetFPS=Math.max(30,Math.min(144,e)),this.frameTime=1e3/this.targetFPS}setMouseSensitivity(e){this.inputManager.setMouseSensitivity(e)}getMouseSensitivity(){return this.inputManager.getMouseSensitivity()}}const I={WALK_SPEED:5,SPRINT_MULTIPLIER:1.5,JUMP_HEIGHT:2,GRAVITY:20,MAX_STAMINA:100,STAMINA_DRAIN_RATE:20,STAMINA_REGEN_RATE:15,STAMINA_THRESHOLD:20,MAX_HEALTH:100,EYE_HEIGHT:1.7,MIN_PITCH:-Math.PI/2+.1,MAX_PITCH:Math.PI/2-.1};var ee=(r=>(r.HEALTH_CHANGED="player:healthChanged",r.STAMINA_CHANGED="player:staminaChanged",r.DEATH="player:death",r.JUMP="player:jumped",r.LAND="player:landed",r))(ee||{});class xe{_position;_rotation;velocity;_health;_maxHealth;_stamina;_maxStamina;_isSprinting=!1;_canSprint=!0;_isOnGround=!0;_isJumping=!1;camera=null;eventListeners=new Map;constructor(e={x:0,y:0,z:0},t={x:0,y:0,z:0}){this._position=new c(e.x,e.y,e.z),this._rotation=new _e(t.x,t.y,t.z,"YXZ"),this.velocity=new c(0,0,0),this._health=I.MAX_HEALTH,this._maxHealth=I.MAX_HEALTH,this._stamina=I.MAX_STAMINA,this._maxStamina=I.MAX_STAMINA}attachCamera(e){this.camera=e,this.updateCameraPosition()}updateCameraPosition(){this.camera&&(this.camera.position.set(this._position.x,this._position.y+I.EYE_HEIGHT,this._position.z),this.camera.rotation.copy(this._rotation))}move(e,t,s){if(e===0&&t===0)return;let i=I.WALK_SPEED;this._isSprinting&&this._canSprint&&(i*=I.SPRINT_MULTIPLIER);const a=new c(0,0,-1),n=new c(1,0,0),h=new _e(0,this._rotation.y,0);a.applyEuler(h),n.applyEuler(h);const u=new c;u.addScaledVector(a,-t),u.addScaledVector(n,e),u.length()>0&&u.normalize(),this._position.addScaledVector(u,i*s),this.updateCameraPosition()}rotate(e,t){this._rotation.y-=e,this._rotation.x-=t,this._rotation.x=Math.max(I.MIN_PITCH,Math.min(I.MAX_PITCH,this._rotation.x)),this.updateCameraPosition()}jump(){if(!this._isOnGround)return!1;const e=Math.sqrt(2*I.GRAVITY*I.JUMP_HEIGHT);return this.velocity.y=e,this._isOnGround=!1,this._isJumping=!0,this.emit("player:jumped"),!0}sprint(e){e&&!this._isSprinting?this._stamina>=I.STAMINA_THRESHOLD&&(this._isSprinting=!0,this._canSprint=!0):e||(this._isSprinting=!1)}takeDamage(e){if(e<=0)return;const t=this._health;this._health=Math.max(0,this._health-e),this.emit("player:healthChanged",{previous:t,current:this._health,damage:e}),this._health<=0&&this.emit("player:death")}heal(e){if(e<=0)return;const t=this._health;this._health=Math.min(this._maxHealth,this._health+e),this.emit("player:healthChanged",{previous:t,current:this._health,healed:e})}updateStamina(e){const t=this._stamina;this._isSprinting&&this._canSprint?(this._stamina=Math.max(0,this._stamina-I.STAMINA_DRAIN_RATE*e),this._stamina<=0&&(this._canSprint=!1,this._isSprinting=!1)):(this._stamina=Math.min(this._maxStamina,this._stamina+I.STAMINA_REGEN_RATE*e),!this._canSprint&&this._stamina>=I.STAMINA_THRESHOLD&&(this._canSprint=!0)),t!==this._stamina&&this.emit("player:staminaChanged",{previous:t,current:this._stamina})}updatePhysics(e,t=0){this._isOnGround||(this.velocity.y-=I.GRAVITY*e,this._position.y+=this.velocity.y*e,this._position.y<=t&&(this._position.y=t,this.velocity.y=0,this._isOnGround=!0,this._isJumping&&(this._isJumping=!1,this.emit("player:landed")))),this.updateCameraPosition()}update(e,t=0){this.updateStamina(e),this.updatePhysics(e,t)}isDead(){return this._health<=0}isSprinting(){return this._isSprinting&&this._canSprint}canSprint(){return this._canSprint}isOnGround(){return this._isOnGround}isJumping(){return this._isJumping}getCurrentSpeed(){return this._isSprinting&&this._canSprint?I.WALK_SPEED*I.SPRINT_MULTIPLIER:I.WALK_SPEED}get position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set position(e){this._position.set(e.x,e.y,e.z),this.updateCameraPosition()}get rotation(){return{x:this._rotation.x,y:this._rotation.y,z:this._rotation.z}}set rotation(e){this._rotation.set(e.x,e.y,e.z,"YXZ"),this.updateCameraPosition()}get health(){return this._health}get maxHealth(){return this._maxHealth}get stamina(){return this._stamina}get maxStamina(){return this._maxStamina}getPosition3(){return this._position.clone()}getRotation3(){return this._rotation.clone()}setOnGround(e){const t=this._isOnGround;this._isOnGround=e,!t&&e&&this._isJumping&&(this._isJumping=!1,this.velocity.y=0,this.emit("player:landed"))}toState(){return{position:this.position,rotation:this.rotation,health:this._health,stamina:this._stamina}}fromState(e){this.position=e.position,this.rotation=e.rotation,this._health=e.health,this._stamina=e.stamina,this._isOnGround=!0,this._isJumping=!1,this.velocity.set(0,0,0)}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}}var J=(r=>(r.FIRE="weapon:fire",r.RELOAD_START="weapon:reloadStart",r.RELOAD_END="weapon:reloadEnd",r.AMMO_CHANGED="weapon:ammoChanged",r.EMPTY="weapon:empty",r))(J||{});class ye{id;name;type;damage;fireRate;magazineSize;maxReserveAmmo;reloadTime;range;spread;pelletCount;_currentAmmo;_reserveAmmo;_isReloading=!1;_lastFireTime=0;_reloadPromise=null;eventListeners=new Map;constructor(e){this.id=e.id,this.name=e.name,this.type=e.type,this.damage=e.damage,this.fireRate=e.fireRate,this.magazineSize=e.magazineSize,this.maxReserveAmmo=e.maxReserveAmmo,this.reloadTime=e.reloadTime,this.range=e.range,this.spread=e.spread??0,this.pelletCount=e.pelletCount??1,this._currentAmmo=this.magazineSize,this._reserveAmmo=this.maxReserveAmmo}get currentAmmo(){return this._currentAmmo}get reserveAmmo(){return this._reserveAmmo}get isReloading(){return this._isReloading}get totalAmmo(){return this._currentAmmo+this._reserveAmmo}canFire(){if(this._currentAmmo<=0||this._isReloading)return!1;const t=(performance.now()-this._lastFireTime)/1e3,s=1/this.fireRate;return t>=s}canReload(){return!(this._isReloading||this._currentAmmo>=this.magazineSize||this._reserveAmmo<=0)}performFire(){return this.canFire()?(this._currentAmmo--,this._lastFireTime=performance.now(),this.emit("weapon:ammoChanged",{currentAmmo:this._currentAmmo,reserveAmmo:this._reserveAmmo}),this.emit("weapon:fire"),!0):(this._currentAmmo<=0&&this.emit("weapon:empty"),!1)}async reload(){this.canReload()&&(this._isReloading=!0,this.emit("weapon:reloadStart"),this._reloadPromise=new Promise(e=>{setTimeout(()=>{this.completeReload(),e()},this.reloadTime*1e3)}),await this._reloadPromise)}completeReload(){if(!this._isReloading)return;const e=this.magazineSize-this._currentAmmo,t=Math.min(e,this._reserveAmmo);this._currentAmmo+=t,this._reserveAmmo-=t,this._isReloading=!1,this._reloadPromise=null,this.emit("weapon:reloadEnd"),this.emit("weapon:ammoChanged",{currentAmmo:this._currentAmmo,reserveAmmo:this._reserveAmmo})}cancelReload(){this._isReloading=!1,this._reloadPromise=null}addAmmo(e){this._reserveAmmo=Math.min(this._reserveAmmo+e,this.maxReserveAmmo),this.emit("weapon:ammoChanged",{currentAmmo:this._currentAmmo,reserveAmmo:this._reserveAmmo})}setAmmo(e,t){this._currentAmmo=Math.max(0,Math.min(e,this.magazineSize)),this._reserveAmmo=Math.max(0,Math.min(t,this.maxReserveAmmo))}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}toState(){return{id:this.id,currentAmmo:this._currentAmmo,reserveAmmo:this._reserveAmmo}}fromState(e){this.setAmmo(e.currentAmmo,e.reserveAmmo)}}const bt={id:"pistol",name:"Pistol",type:Me.PISTOL,damage:25,fireRate:3,magazineSize:15,maxReserveAmmo:90,reloadTime:1.5,range:50};class At extends ye{constructor(e={}){super({...bt,...e})}fire(e,t,s){if(!this.performFire())return{success:!1,damage:0};if(s){const a=new ae(e,t.normalize(),0,this.range).intersectObjects(s.children,!0);if(a.length>0){const n=a[0];return{success:!0,damage:this.damage,hitPoint:n.point,hitNormal:n.face?.normal,hitObject:n.object}}}return{success:!0,damage:this.damage}}}const Et={id:"rifle",name:"Assault Rifle",type:Me.RIFLE,damage:30,fireRate:10,magazineSize:30,maxReserveAmmo:180,reloadTime:2.5,range:100};class Pt extends ye{constructor(e={}){super({...Et,...e})}fire(e,t,s){if(!this.performFire())return{success:!1,damage:0};if(s){const a=new ae(e,t.normalize(),0,this.range).intersectObjects(s.children,!0);if(a.length>0){const n=a[0];return{success:!0,damage:this.damage,hitPoint:n.point,hitNormal:n.face?.normal,hitObject:n.object}}}return{success:!0,damage:this.damage}}}const Tt={id:"shotgun",name:"Shotgun",type:Me.SHOTGUN,damage:15,fireRate:1,magazineSize:8,maxReserveAmmo:48,reloadTime:3,range:25,spread:.1,pelletCount:8};class Ct extends ye{constructor(e={}){super({...Tt,...e})}fire(e,t,s){if(!this.performFire())return{success:!1,damage:0};let i=0,a=null,n=1/0;for(let h=0;h<this.pelletCount;h++){const u=this.applySpread(t.clone());if(s){const d=new ae(e,u.normalize(),0,this.range).intersectObjects(s.children,!0);if(d.length>0){const p=d[0];i+=this.damage,p.distance<n&&(n=p.distance,a={point:p.point,normal:p.face?.normal,object:p.object})}}else i+=this.damage}return a?{success:!0,damage:i,hitPoint:a.point,hitNormal:a.normal,hitObject:a.object}:{success:!0,damage:i}}applySpread(e){const t=(Math.random()-.5)*this.spread*2,s=(Math.random()-.5)*this.spread*2,i=new ht;return i.setFromEuler(new _e(t,s,0)),e.applyQuaternion(i),e}}const Lt={id:"knife",name:"Combat Knife",type:Me.MELEE,damage:50,fireRate:2,magazineSize:1,maxReserveAmmo:0,reloadTime:0,range:2};class Rt extends ye{constructor(e={}){super({...Lt,...e}),this._currentAmmo=1,this._reserveAmmo=0}canFire(){if(this._isReloading)return!1;const t=(performance.now()-this._lastFireTime)/1e3,s=1/this.fireRate;return t>=s}canReload(){return!1}fire(e,t,s){const i=performance.now(),a=(i-this._lastFireTime)/1e3,n=1/this.fireRate;if(a<n)return{success:!1,damage:0};if(this._lastFireTime=i,this.emit("weapon:fire"),s){const u=new ae(e,t.normalize(),0,this.range).intersectObjects(s.children,!0);if(u.length>0){const m=u[0];return{success:!0,damage:this.damage,hitPoint:m.point,hitNormal:m.face?.normal,hitObject:m.object}}}return{success:!0,damage:this.damage}}async reload(){}toState(){return{id:this.id,currentAmmo:1,reserveAmmo:0}}}var Q=(r=>(r.WEAPON_SWITCHED="weaponManager:switched",r.WEAPON_FIRED="weaponManager:fired",r.WEAPON_RELOAD_START="weaponManager:reloadStart",r.WEAPON_RELOAD_END="weaponManager:reloadEnd",r.AMMO_CHANGED="weaponManager:ammoChanged",r.WEAPON_EMPTY="weaponManager:empty",r))(Q||{});const U=4;class It{weapons=[null,null,null,null];currentWeaponIndex=0;eventListeners=new Map;constructor(){this.initializeDefaultWeapons()}initializeDefaultWeapons(){this.weapons[0]=new At,this.weapons[1]=new Pt,this.weapons[2]=new Ct,this.weapons[3]=new Rt,this.weapons.forEach(e=>{e&&this.subscribeToWeaponEvents(e)})}subscribeToWeaponEvents(e){e.on(J.FIRE,()=>{e===this.getCurrentWeapon()&&this.emit("weaponManager:fired",{weapon:e})}),e.on(J.RELOAD_START,()=>{e===this.getCurrentWeapon()&&this.emit("weaponManager:reloadStart",{weapon:e})}),e.on(J.RELOAD_END,()=>{e===this.getCurrentWeapon()&&this.emit("weaponManager:reloadEnd",{weapon:e})}),e.on(J.AMMO_CHANGED,t=>{e===this.getCurrentWeapon()&&this.emit("weaponManager:ammoChanged",{weapon:e,...t})}),e.on(J.EMPTY,()=>{e===this.getCurrentWeapon()&&this.emit("weaponManager:empty",{weapon:e})})}getCurrentWeapon(){return this.weapons[this.currentWeaponIndex]}getCurrentWeaponIndex(){return this.currentWeaponIndex}getWeaponAtSlot(e){return e<0||e>=U?null:this.weapons[e]}getAllWeapons(){return[...this.weapons]}getWeaponCount(){return this.weapons.filter(e=>e!==null).length}switchToSlot(e){if(e<0||e>=U||this.weapons[e]===null||e===this.currentWeaponIndex)return!1;const t=this.getCurrentWeapon();t&&t.cancelReload();const s=this.currentWeaponIndex;return this.currentWeaponIndex=e,this.emit("weaponManager:switched",{previousIndex:s,currentIndex:e,weapon:this.getCurrentWeapon()}),!0}cycleNext(){const e=this.currentWeaponIndex;let t=(this.currentWeaponIndex+1)%U;for(;t!==e;){if(this.weapons[t]!==null)return this.switchToSlot(t);t=(t+1)%U}return!1}cyclePrevious(){const e=this.currentWeaponIndex;let t=(this.currentWeaponIndex-1+U)%U;for(;t!==e;){if(this.weapons[t]!==null)return this.switchToSlot(t);t=(t-1+U)%U}return!1}fire(e,t,s){const i=this.getCurrentWeapon();return i?i.fire(e,t,s):{success:!1,damage:0}}async reload(){const e=this.getCurrentWeapon();e&&await e.reload()}canFire(){const e=this.getCurrentWeapon();return e?e.canFire():!1}canReload(){const e=this.getCurrentWeapon();return e?e.canReload():!1}isReloading(){const e=this.getCurrentWeapon();return e?e.isReloading:!1}setWeaponAtSlot(e,t){e<0||e>=U||(this.weapons[e],this.weapons[e]=t,t&&this.subscribeToWeaponEvents(t))}addAmmoToWeapon(e,t){const s=this.weapons.find(i=>i?.id===e);s&&s.addAmmo(t)}toState(){return{weapons:this.weapons.map(e=>e?e.toState():{id:"",currentAmmo:0,reserveAmmo:0}),currentWeaponIndex:this.currentWeaponIndex}}fromState(e){e.weapons.forEach((t,s)=>{const i=this.weapons[s];i&&t.id===i.id&&i.fromState(t)}),this.currentWeaponIndex=e.currentWeaponIndex}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}}const B={DETECTION_RANGE:30,ATTACK_RANGE:2,ATTACK_COOLDOWN:1.5,DEATH_REMOVE_DELAY:5,WANDER_CHANGE_INTERVAL:3,variants:{[b.WALKER]:{health:100,damage:10,speed:2,name:"Walker"},[b.RUNNER]:{health:75,damage:8,speed:5,name:"Runner"},[b.BRUTE]:{health:250,damage:25,speed:1.5,name:"Brute"},[b.CRAWLER]:{health:50,damage:15,speed:3,name:"Crawler"}}};var ve=(r=>(r.STATE_CHANGED="zombie:stateChanged",r.DAMAGE_TAKEN="zombie:damageTaken",r.ATTACK="zombie:attack",r.DEATH="zombie:death",r))(ve||{});class we{_id;_position;_rotation;_health;_maxHealth;_damage;_speed;_variant;_state=M.IDLE;previousState=M.IDLE;attackCooldown=0;deathTimer=0;wanderTimer=0;wanderDirection=new c;spawnPosition;wanderRadius=10;mesh=null;eventListeners=new Map;constructor(e,t,s=b.WALKER){this._id=e,this._position=new c(t.x,t.y,t.z),this._rotation=new _e(0,0,0,"YXZ"),this.spawnPosition=this._position.clone(),this._variant=s;const i=B.variants[s];this._health=i.health,this._maxHealth=i.health,this._damage=i.damage,this._speed=i.speed,this._state=M.IDLE}setState(e){this._state!==e&&this._state!==M.DYING&&(this.previousState=this._state,this._state=e,this.emit("zombie:stateChanged",{previous:this.previousState,current:this._state}),this.onStateEnter(e))}onStateEnter(e){switch(e){case M.WANDERING:this.pickNewWanderDirection(),this.wanderTimer=B.WANDER_CHANGE_INTERVAL;break;case M.DYING:this.deathTimer=B.DEATH_REMOVE_DELAY,this.emit("zombie:death",{id:this._id});break;case M.ATTACKING:this.attackCooldown=0;break}}pickNewWanderDirection(){const e=Math.random()*Math.PI*2;this.wanderDirection.set(Math.cos(e),0,Math.sin(e))}update(e,t){if(this.attackCooldown>0&&(this.attackCooldown-=e),this._state===M.DYING){this.updateDying(e);return}const s=this._position.distanceTo(t);this.updateStateTransitions(s,t),this.executeStateBehavior(e,t,s),this.updateMeshPosition()}updateStateTransitions(e,t){switch(this._state){case M.IDLE:case M.WANDERING:e<B.DETECTION_RANGE?this.setState(M.CHASING):this._state===M.IDLE&&this.setState(M.WANDERING);break;case M.CHASING:e<B.ATTACK_RANGE?this.setState(M.ATTACKING):e>B.DETECTION_RANGE*1.5&&this.setState(M.WANDERING);break;case M.ATTACKING:e>=B.ATTACK_RANGE&&this.setState(M.CHASING);break}}executeStateBehavior(e,t,s){switch(this._state){case M.IDLE:break;case M.WANDERING:this.updateWandering(e);break;case M.CHASING:this.updateChasing(e,t);break;case M.ATTACKING:this.updateAttacking(e,t);break}}updateWandering(e){this.wanderTimer-=e,this.wanderTimer<=0&&(this.pickNewWanderDirection(),this.wanderTimer=B.WANDER_CHANGE_INTERVAL);const t=this.wanderDirection.clone().multiplyScalar(this._speed*.5*e),s=this._position.clone().add(t);s.distanceTo(this.spawnPosition)<=this.wanderRadius?this._position.copy(s):this.wanderDirection.copy(this.spawnPosition).sub(this._position).normalize(),this.faceDirection(this.wanderDirection)}updateChasing(e,t){const s=new c().subVectors(t,this._position).setY(0).normalize(),i=s.multiplyScalar(this._speed*e);this._position.add(i),this.faceDirection(s)}updateAttacking(e,t){const s=new c().subVectors(t,this._position).setY(0).normalize();this.faceDirection(s),this.attackCooldown<=0&&(this.performAttack(),this.attackCooldown=B.ATTACK_COOLDOWN)}updateDying(e){this.deathTimer-=e}faceDirection(e){e.lengthSq()>0&&(this._rotation.y=Math.atan2(e.x,e.z))}updateMeshPosition(){this.mesh&&(this.mesh.position.copy(this._position),this.mesh.rotation.copy(this._rotation))}performAttack(){this.emit("zombie:attack",{id:this._id,damage:this._damage,position:this.position})}takeDamage(e,t){if(this._state===M.DYING||e<=0)return;const s=this._health;this._health=Math.max(0,this._health-e),this.emit("zombie:damageTaken",{id:this._id,damage:e,previousHealth:s,currentHealth:this._health,hitPoint:t}),this._health<=0&&this.die()}die(){this.setState(M.DYING)}shouldRemove(){return this._state===M.DYING&&this.deathTimer<=0}isDead(){return this._state===M.DYING||this._health<=0}isAwareOfPlayer(){return this._state===M.CHASING||this._state===M.ATTACKING}canAttack(){return this._state===M.ATTACKING&&this.attackCooldown<=0}getDamage(){return this._damage}distanceTo(e){return this._position.distanceTo(new c(e.x,e.y,e.z))}get id(){return this._id}get position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set position(e){this._position.set(e.x,e.y,e.z),this.updateMeshPosition()}get rotation(){return{x:this._rotation.x,y:this._rotation.y,z:this._rotation.z}}get health(){return this._health}get maxHealth(){return this._maxHealth}get damage(){return this._damage}get speed(){return this._speed}get variant(){return this._variant}get state(){return this._state}getPosition3(){return this._position.clone()}setMesh(e){this.mesh=e,this.updateMeshPosition()}getMesh(){return this.mesh}toState(){return{id:this._id,position:this.position,health:this._health,variant:this._variant,state:this._state}}static fromState(e){const t=new we(e.id,e.position,e.variant);return t._health=e.health,t._state=e.state,t}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.eventListeners.clear(),this.mesh&&(this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh=null)}}const xt={[b.WALKER]:{bodyColor:4881486,skinColor:9139029,eyeColor:16711680,height:1.8,width:.5,walkSpeed:1},[b.RUNNER]:{bodyColor:8145482,skinColor:10191717,eyeColor:16724736,height:1.7,width:.4,walkSpeed:2},[b.BRUTE]:{bodyColor:4868732,skinColor:8086341,eyeColor:16711782,height:2.2,width:.8,walkSpeed:.7},[b.CRAWLER]:{bodyColor:8158282,skinColor:7033653,eyeColor:16776960,height:.8,width:.6,walkSpeed:1.5}};class De{mesh;_variant;config;currentAnimation="idle";animationTime=0;animationSpeed=1;body=null;head=null;leftArm=null;rightArm=null;leftLeg=null;rightLeg=null;deathProgress=0;isDeathComplete=!1;constructor(e){this._variant=e,this.config=xt[e],this.mesh=this.createZombieMesh()}get variant(){return this._variant}createZombieMesh(){const e=new z,{bodyColor:t,skinColor:s,eyeColor:i,height:a,width:n}=this.config,h=new O({color:t,roughness:.8,metalness:.1}),u=new O({color:s,roughness:.7,metalness:0}),m=new be({color:i}),d=a*.35,p=new $(n*.45,n*.5,d,8);this.body=new v(p,h),this.body.position.y=a*.5,this.body.castShadow=!0,this.body.receiveShadow=!0,e.add(this.body);const S=n*.35,g=new fe(S,12,12);this.head=new v(g,u),this.head.position.y=a*.75,this.head.castShadow=!0,e.add(this.head);const _=new fe(.04,6,6),G=new v(_,m);G.position.set(-.07,a*.78,S*.8),e.add(G);const Y=new v(_,m);return Y.position.set(.07,a*.78,S*.8),e.add(Y),this.leftArm=this.createArm(u,a,n),this.leftArm.position.set(-n*.55,a*.6,0),e.add(this.leftArm),this.rightArm=this.createArm(u,a,n),this.rightArm.position.set(n*.55,a*.6,0),e.add(this.rightArm),this.leftLeg=this.createLeg(h,a,n),this.leftLeg.position.set(-n*.2,a*.25,0),e.add(this.leftLeg),this.rightLeg=this.createLeg(h,a,n),this.rightLeg.position.set(n*.2,a*.25,0),e.add(this.rightLeg),e}createArm(e,t,s){const i=new z,a=t*.25,n=new $(s*.1,s*.08,a,6),h=new v(n,e);h.position.y=-a/2,h.castShadow=!0,i.add(h);const u=new fe(s*.1,6,6),m=new v(u,e);return m.position.y=-a,m.castShadow=!0,i.add(m),i}createLeg(e,t,s){const i=new z,a=t*.3,n=new $(s*.12,s*.1,a,6),h=new v(n,e);h.position.y=-a/2,h.castShadow=!0,i.add(h);const u=new D(s*.15,s*.08,s*.25),m=new v(u,e);return m.position.set(0,-a,s*.05),m.castShadow=!0,i.add(m),i}update(e,t,s){this.animationTime+=e*this.config.walkSpeed*this.animationSpeed;const i=this.getAnimationForState(t,s);switch(i!==this.currentAnimation&&(this.currentAnimation=i,this.animationTime=0),this.currentAnimation){case"idle":this.animateIdle();break;case"walk":this.animateWalk();break;case"run":this.animateRun();break;case"attack":this.animateAttack();break;case"death":this.animateDeath(e);break}}getAnimationForState(e,t){switch(e){case M.IDLE:return"idle";case M.WANDERING:return"walk";case M.CHASING:return t>3?"run":"walk";case M.ATTACKING:return"attack";case M.DYING:return"death";default:return"idle"}}animateIdle(){const e=Math.sin(this.animationTime*2)*.02;this.body&&(this.body.rotation.z=e),this.head&&(this.head.rotation.z=e*.5,this.head.rotation.y=Math.sin(this.animationTime*.5)*.1),this.resetLimbs()}animateWalk(){const e=this.animationTime*4,t=Math.sin(e)*.5,s=Math.sin(e)*.4;this.leftArm&&(this.leftArm.rotation.x=t,this.leftArm.rotation.z=.3),this.rightArm&&(this.rightArm.rotation.x=-t,this.rightArm.rotation.z=-.3),this.leftLeg&&(this.leftLeg.rotation.x=s),this.rightLeg&&(this.rightLeg.rotation.x=-s),this.body&&(this.body.position.y=this.config.height*.5+Math.abs(Math.sin(e*2))*.02),this.head&&(this.head.rotation.z=Math.sin(e)*.05)}animateRun(){const e=this.animationTime*8,t=Math.sin(e)*.8,s=Math.sin(e)*.6;this.leftArm&&(this.leftArm.rotation.x=t,this.leftArm.rotation.z=.4),this.rightArm&&(this.rightArm.rotation.x=-t,this.rightArm.rotation.z=-.4),this.leftLeg&&(this.leftLeg.rotation.x=s),this.rightLeg&&(this.rightLeg.rotation.x=-s),this.body&&(this.body.position.y=this.config.height*.5+Math.abs(Math.sin(e*2))*.04,this.body.rotation.x=.1)}animateAttack(){const e=this.animationTime%1.5/1.5;if(e<.3){const t=e/.3;this.leftArm&&(this.leftArm.rotation.x=-t*1.5),this.rightArm&&(this.rightArm.rotation.x=-t*1.5)}else if(e<.5){const t=(e-.3)/.2;this.leftArm&&(this.leftArm.rotation.x=-1.5+t*2.5),this.rightArm&&(this.rightArm.rotation.x=-1.5+t*2.5)}else{const t=(e-.5)/.5;this.leftArm&&(this.leftArm.rotation.x=1-t*1),this.rightArm&&(this.rightArm.rotation.x=1-t*1)}this.body&&e<.5&&(this.body.rotation.x=Math.sin(e*Math.PI*2)*.2)}animateDeath(e){this.isDeathComplete||(this.deathProgress+=e*.5,this.deathProgress>=1&&(this.deathProgress=1,this.isDeathComplete=!0),this.mesh.rotation.x=this.deathProgress*(Math.PI/2),this.mesh.position.y=-this.deathProgress*.3,this.leftArm&&(this.leftArm.rotation.x=-this.deathProgress*1.5,this.leftArm.rotation.z=this.deathProgress*.5),this.rightArm&&(this.rightArm.rotation.x=-this.deathProgress*1.5,this.rightArm.rotation.z=-this.deathProgress*.5))}resetLimbs(){this.leftArm&&(this.leftArm.rotation.x=.3,this.leftArm.rotation.z=.2),this.rightArm&&(this.rightArm.rotation.x=.3,this.rightArm.rotation.z=-.2),this.leftLeg&&(this.leftLeg.rotation.x=0),this.rightLeg&&(this.rightLeg.rotation.x=0)}playHitReaction(){if(this.body){const e=this.body.material,t=e.color.getHex();e.color.setHex(16711680),setTimeout(()=>{e.color.setHex(t)},100)}}getMesh(){return this.mesh}isDeathAnimationComplete(){return this.isDeathComplete}setAnimationSpeed(e){this.animationSpeed=e}dispose(){this.mesh.traverse(e=>{e instanceof v&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())})}}class Dt{zombies=new Map;zombieVisuals=new Map;scene;nextZombieId=0;eventListeners=new Map;totalKilled=0;constructor(e){this.scene=e}spawnZombie(e,t){const s=`zombie_${this.nextZombieId++}`,i=t??this.getRandomVariant(),a=new we(s,e,i);this.setupZombieEvents(a);const n=new De(i),h=n.getMesh();return a.setMesh(h),this.scene.add(h),this.zombieVisuals.set(s,n),this.zombies.set(s,a),this.emit(R.ZOMBIE_SPAWN,{zombie:a.toState()}),a}spawnWave(e,t,s=5){const i=[];for(let a=0;a<e;a++){const n=t[Math.floor(Math.random()*t.length)],h=Math.random()*Math.PI*2,u=Math.random()*s,m={x:n.x+Math.cos(h)*u,y:n.y,z:n.z+Math.sin(h)*u},d=this.spawnZombie(m);i.push(d)}return i}getRandomVariant(){const e=Math.random();return e<.5?b.WALKER:e<.75?b.RUNNER:e<.9?b.CRAWLER:b.BRUTE}createZombieVisuals(e){return new De(e)}setupZombieEvents(e){e.on(ve.DEATH,t=>{this.totalKilled++,this.emit(R.ZOMBIE_DEATH,t)}),e.on(ve.ATTACK,t=>{this.emit(ve.ATTACK,t)})}_cachedPlayerPos=new c;update(e,t){this._cachedPlayerPos.set(t.x,t.y,t.z);const s=[];for(const[i,a]of this.zombies)try{a.update(e,this._cachedPlayerPos);const n=this.zombieVisuals.get(i);n&&n.update(e,a.state,a.speed),a.shouldRemove()&&s.push(i)}catch(n){console.error(`Error updating zombie ${i}:`,n),s.push(i)}for(const i of s)this.removeZombie(i)}removeZombie(e){const t=this.zombies.get(e);if(t){const s=t.getMesh();s&&this.scene.remove(s);const i=this.zombieVisuals.get(e);i&&(i.dispose(),this.zombieVisuals.delete(e)),t.dispose(),this.zombies.delete(e)}}damageZombie(e,t,s){const i=this.zombies.get(e);i&&i.takeDamage(t,s)}getZombie(e){return this.zombies.get(e)}getAllZombies(){return Array.from(this.zombies.values())}getZombiesInRange(e,t){return this.getAllZombies().filter(s=>s.distanceTo(e)<=t&&!s.isDead())}getClosestZombie(e){let t=null,s=1/0;for(const i of this.zombies.values()){if(i.isDead())continue;const a=i.distanceTo(e);a<s&&(s=a,t=i)}return t}raycastZombies(e){const t=[],s=new Map;for(const a of this.zombies.values()){if(a.isDead())continue;const n=a.getMesh();n&&(t.push(n),s.set(n,a))}const i=e.intersectObjects(t,!0);if(i.length>0){let a=i[0].object;for(;a.parent&&!s.has(a);)a=a.parent;const n=s.get(a);if(n){const h=i[0].point;return{zombie:n,point:{x:h.x,y:h.y,z:h.z}}}}return null}getActiveCount(){let e=0;for(const t of this.zombies.values())t.isDead()||e++;return e}getTotalCount(){return this.zombies.size}getTotalKilled(){return this.totalKilled}resetKillCount(){this.totalKilled=0}toState(){return this.getAllZombies().map(e=>e.toState())}fromState(e){this.clear();for(const t of e){const s=we.fromState(t);this.setupZombieEvents(s);const i=this.createZombieVisuals(s.variant),a=i.getMesh();s.setMesh(a),this.scene.add(a),this.zombieVisuals.set(s.id,i),this.zombies.set(s.id,s);const n=parseInt(s.id.replace("zombie_",""),10);!isNaN(n)&&n>=this.nextZombieId&&(this.nextZombieId=n+1)}}clear(){for(const[e,t]of this.zombies){const s=t.getMesh();s&&this.scene.remove(s);const i=this.zombieVisuals.get(e);i&&i.dispose(),t.dispose()}this.zombies.clear(),this.zombieVisuals.clear()}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.clear(),this.eventListeners.clear()}}var Te=(r=>(r.PLAYER_DEATH="playerDeath",r.QUIT="quit",r.TIMEOUT="timeout",r))(Te||{});class Ot{_isGameOver=!1;_stats=null;_highScore=0;eventListeners=new Map;get isGameOver(){return this._isGameOver}get stats(){return this._stats}get finalScore(){return this._stats?.finalScore??0}get waveReached(){return this._stats?.waveReached??0}get totalZombiesKilled(){return this._stats?.totalZombiesKilled??0}setHighScore(e){this._highScore=e}isNewHighScore(){return this._stats?this._stats.finalScore>this._highScore:!1}triggerGameOver(e,t,s,i,a){if(this._isGameOver)return;this._isGameOver=!0,this._stats={finalScore:t,waveReached:s,totalZombiesKilled:i,playTime:a,reason:e},this.emit("gameOver:triggered",this._stats),this.emit("gameOver:statsReady",this._stats);const n=this.getFinalScoreDisplay();this.emit("gameOver:scoreDisplayReady",n)}shouldTriggerGameOver(e){return e<=0&&!this._isGameOver}getFormattedScore(){return this._stats?this._stats.finalScore.toLocaleString():"0"}getFormattedPlayTime(){if(!this._stats)return"00:00";const e=Math.floor(this._stats.playTime),t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}getFormattedPlayTimeLong(){if(!this._stats)return"00:00:00";const e=Math.floor(this._stats.playTime),t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}getGameOverMessage(){if(!this._stats)return"Game Over";switch(this._stats.reason){case"playerDeath":return"You have been overwhelmed by the zombie horde!";case"quit":return"You abandoned the fight...";case"timeout":return"Time has run out!";default:return"Game Over"}}getFinalScoreDisplay(){return{score:this.getFormattedScore(),waveReached:this._stats?.waveReached??0,zombiesKilled:this._stats?.totalZombiesKilled??0,playTime:this.getFormattedPlayTime(),message:this.getGameOverMessage(),isHighScore:this.isNewHighScore()}}getSummaryText(){if(!this._stats)return"No game data available";const e=[`Final Score: ${this.getFormattedScore()}`,`Wave Reached: ${this._stats.waveReached}`,`Zombies Killed: ${this._stats.totalZombiesKilled}`,`Time Survived: ${this.getFormattedPlayTime()}`];return this.isNewHighScore()&&e.unshift(" NEW HIGH SCORE! "),e.join(`
`)}requestRestart(){this.emit("gameOver:restart",{})}reset(){this._isGameOver=!1,this._stats=null}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.eventListeners.clear(),this._stats=null}}const F={BASE_ZOMBIES:10,ZOMBIES_PER_WAVE:5,PREPARATION_TIME:30,SCORE_PER_KILL:100,WAVE_COMPLETION_BONUS:500,SPAWN_INTERVAL:.5,MIN_SPAWN_DISTANCE:20};var q=(r=>(r.WAVE_START="wave:start",r.WAVE_END="wave:end",r.PREPARATION_START="wave:preparationStart",r.PREPARATION_END="wave:preparationEnd",r.ZOMBIE_KILLED="wave:zombieKilled",r.SCORE_CHANGED="wave:scoreChanged",r.GAME_OVER="wave:gameOver",r))(q||{});class Gt{_currentWave=0;_zombiesKilled=0;_totalZombiesInWave=0;_zombiesSpawned=0;_isPreparationPhase=!0;_preparationTimeLeft=F.PREPARATION_TIME;_score=0;_waveScore=0;_isGameOver=!1;_gameOverReason=null;_finalScore=0;spawnTimer=0;spawnPoints=[];zombieManager=null;player=null;gameOverManager;_playTime=0;eventListeners=new Map;constructor(){this.spawnPoints=this.generateDefaultSpawnPoints(),this.gameOverManager=new Ot}init(e,t){this.zombieManager=e,this.player=t,this.zombieManager.on(R.ZOMBIE_DEATH,()=>{this.onZombieKilled()})}getGameOverManager(){return this.gameOverManager}generateDefaultSpawnPoints(){const e=[];for(let i=0;i<8;i++){const a=i/8*Math.PI*2;e.push({x:Math.cos(a)*30,y:0,z:Math.sin(a)*30})}return e}setSpawnPoints(e){this.spawnPoints=e}startGame(){this._currentWave=0,this._score=0,this._isGameOver=!1,this._gameOverReason=null,this._playTime=0,this.gameOverManager.reset(),this.startPreparationPhase()}startPreparationPhase(){this._currentWave++,this._isPreparationPhase=!0,this._preparationTimeLeft=F.PREPARATION_TIME,this._zombiesKilled=0,this._zombiesSpawned=0,this._waveScore=0,this._totalZombiesInWave=this.calculateZombieCount(this._currentWave),this.emit("wave:preparationStart",{wave:this._currentWave,preparationTime:F.PREPARATION_TIME,totalZombies:this._totalZombiesInWave})}startWave(){this._isPreparationPhase=!1,this.spawnTimer=0,this.emit("wave:start",{wave:this._currentWave,totalZombies:this._totalZombiesInWave}),this.emit(R.WAVE_START,{wave:this._currentWave,totalZombies:this._totalZombiesInWave})}endWave(){const e=this._currentWave*F.WAVE_COMPLETION_BONUS;this._score+=e,this.emit("wave:end",{wave:this._currentWave,zombiesKilled:this._zombiesKilled,waveScore:this._waveScore,bonus:e,totalScore:this._score}),this.emit(R.WAVE_END,{wave:this._currentWave,score:this._score}),this.startPreparationPhase()}calculateZombieCount(e){return e*F.ZOMBIES_PER_WAVE+F.BASE_ZOMBIES}calculateScore(e,t){return e*F.SCORE_PER_KILL*t}update(e){this._isGameOver||(this._playTime+=e,this.checkPlayerDeath(),!this._isGameOver&&(this._isPreparationPhase?this.updatePreparationPhase(e):this.updateWavePhase(e)))}updatePreparationPhase(e){this._preparationTimeLeft-=e,this._preparationTimeLeft<=0&&(this._preparationTimeLeft=0,this.emit("wave:preparationEnd",{wave:this._currentWave}),this.startWave())}updateWavePhase(e){this._zombiesSpawned<this._totalZombiesInWave&&(this.spawnTimer+=e,this.spawnTimer>=F.SPAWN_INTERVAL&&(this.spawnTimer=0,this.spawnZombie())),this._zombiesKilled>=this._totalZombiesInWave&&this.endWave()}spawnZombie(){if(!this.zombieManager||this._zombiesSpawned>=this._totalZombiesInWave)return;const e=this.getSpawnPoint(),t=this.getZombieVariantForWave();this.zombieManager.spawnZombie(e,t),this._zombiesSpawned++}getSpawnPoint(){if(this.spawnPoints.length===0)return{x:0,y:0,z:30};if(this.player){const e=this.player.position,t=this.spawnPoints.filter(s=>{const i=s.x-e.x,a=s.z-e.z;return Math.sqrt(i*i+a*a)>=F.MIN_SPAWN_DISTANCE});if(t.length>0)return t[Math.floor(Math.random()*t.length)]}return this.spawnPoints[Math.floor(Math.random()*this.spawnPoints.length)]}getZombieVariantForWave(){const e=this._currentWave,t=Math.random();return e>=10?t<.3?b.WALKER:t<.6?b.RUNNER:t<.8?b.CRAWLER:b.BRUTE:e>=5?t<.4?b.WALKER:t<.7?b.RUNNER:t<.9?b.CRAWLER:b.BRUTE:t<.6?b.WALKER:t<.85?b.RUNNER:t<.95?b.CRAWLER:b.BRUTE}onZombieKilled(){if(this._isGameOver||this._isPreparationPhase)return;this._zombiesKilled++;const e=this.calculateScore(1,this._currentWave);this._waveScore+=e,this._score+=e,this.emit("wave:zombieKilled",{zombiesKilled:this._zombiesKilled,totalZombies:this._totalZombiesInWave,killScore:e,totalScore:this._score}),this.emit("wave:scoreChanged",{score:this._score,waveScore:this._waveScore})}checkPlayerDeath(){!this.player||this._isGameOver||this.player.isDead()&&this.triggerGameOver(Te.PLAYER_DEATH)}triggerGameOver(e){if(this._isGameOver)return;this._isGameOver=!0,this._gameOverReason=e,this._finalScore=this._score;const t=this.getTotalZombiesKilled();this.gameOverManager.triggerGameOver(e,this._finalScore,this._currentWave,t,this._playTime),this.emit("wave:gameOver",{reason:e,finalScore:this._finalScore,waveReached:this._currentWave,totalZombiesKilled:t,playTime:this._playTime}),this.emit(R.GAME_OVER,{reason:e,score:this._finalScore,wave:this._currentWave})}getTotalZombiesKilled(){return this.zombieManager?.getTotalKilled()??0}get currentWave(){return this._currentWave}get zombiesKilled(){return this._zombiesKilled}get totalZombiesInWave(){return this._totalZombiesInWave}get zombiesRemaining(){return this._totalZombiesInWave-this._zombiesKilled}get isPreparationPhase(){return this._isPreparationPhase}get preparationTimeLeft(){return this._preparationTimeLeft}get score(){return this._score}get waveScore(){return this._waveScore}get isGameOver(){return this._isGameOver}get gameOverReason(){return this._gameOverReason}get finalScore(){return this._finalScore}get playTime(){return this._playTime}getFinalScoreDisplay(){return this.gameOverManager.getFinalScoreDisplay()}getGameOverSummary(){return this.gameOverManager.getSummaryText()}toState(){return{currentWave:this._currentWave,zombiesKilled:this._zombiesKilled,totalZombiesInWave:this._totalZombiesInWave,isPreparationPhase:this._isPreparationPhase}}getGameState(){return{wave:this.toState(),score:this._score,isGameOver:this._isGameOver}}fromState(e,t=0){this._currentWave=e.currentWave,this._zombiesKilled=e.zombiesKilled,this._totalZombiesInWave=e.totalZombiesInWave,this._isPreparationPhase=e.isPreparationPhase,this._score=t,this._zombiesSpawned=e.zombiesKilled,this._isGameOver=!1,this._gameOverReason=null,this._isPreparationPhase&&(this._preparationTimeLeft=F.PREPARATION_TIME)}reset(){this._currentWave=0,this._zombiesKilled=0,this._totalZombiesInWave=0,this._zombiesSpawned=0,this._isPreparationPhase=!0,this._preparationTimeLeft=F.PREPARATION_TIME,this._score=0,this._waveScore=0,this._isGameOver=!1,this._gameOverReason=null,this._finalScore=0,this._playTime=0,this.spawnTimer=0,this.gameOverManager.reset(),this.zombieManager?.resetKillCount()}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.eventListeners.clear(),this.gameOverManager.dispose(),this.zombieManager=null,this.player=null}}const k={MASTER_VOLUME:1,MUSIC_VOLUME:.5,SFX_VOLUME:.8,AMBIENT_VOLUME:.6,PAUSE_VOLUME_MULTIPLIER:.5,REF_DISTANCE:1,MAX_DISTANCE:100,ROLLOFF_FACTOR:1,CROSSFADE_DURATION:2};var E=(r=>(r.SFX="sfx",r.MUSIC="music",r.AMBIENT="ambient",r.UI="ui",r))(E||{}),L=(r=>(r.MENU="menu",r.AMBIENT="ambient",r.COMBAT="combat",r.TENSE="tense",r.GAME_OVER="gameOver",r))(L||{}),l=(r=>(r.PISTOL_FIRE="pistolFire",r.RIFLE_FIRE="rifleFire",r.SHOTGUN_FIRE="shotgunFire",r.MELEE_SWING="meleeSwing",r.RELOAD="reload",r.EMPTY_CLICK="emptyClick",r.ZOMBIE_GROWL="zombieGrowl",r.ZOMBIE_ATTACK="zombieAttack",r.ZOMBIE_DEATH="zombieDeath",r.ZOMBIE_HIT="zombieHit",r.PLAYER_HURT="playerHurt",r.PLAYER_DEATH="playerDeath",r.FOOTSTEP="footstep",r.JUMP="jump",r.LAND="land",r.BUTTON_CLICK="buttonClick",r.MENU_OPEN="menuOpen",r.MENU_CLOSE="menuClose",r.WAVE_START="waveStart",r.WAVE_COMPLETE="waveComplete",r.PREPARATION_TICK="preparationTick",r))(l||{});class zt{audioContext=null;listener=null;_masterVolume=k.MASTER_VOLUME;_musicVolume=k.MUSIC_VOLUME;_sfxVolume=k.SFX_VOLUME;_ambientVolume=k.AMBIENT_VOLUME;_isPaused=!1;prePauseVolumes=null;soundCache=new Map;loadingPromises=new Map;activeSounds=new Map;soundIdCounter=0;currentMusicTrack=null;currentMusicSource=null;currentMusicGain=null;nextMusicSource=null;nextMusicGain=null;isCrossfading=!1;masterGain=null;musicGain=null;sfxGain=null;ambientGain=null;eventListeners=new Map;camera=null;constructor(){}async init(e){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.masterGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.ambientGain=this.audioContext.createGain(),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.ambientGain.connect(this.masterGain),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=this._masterVolume,this.musicGain.gain.value=this._musicVolume,this.sfxGain.gain.value=this._sfxVolume,this.ambientGain.gain.value=this._ambientVolume,this.listener=new lt,e&&this.setCamera(e),this.emit("audio:loaded")}catch(t){console.error("Failed to initialize AudioManager:",t),this.emit("audio:error",{error:t})}}setCamera(e){this.camera=e,this.listener&&e&&e.add(this.listener)}getListener(){return this.listener}async loadSound(e,t,s="sfx"){if(this.soundCache.has(e))return;if(this.loadingPromises.has(e)){await this.loadingPromises.get(e);return}const i=this.loadAudioBuffer(t);this.loadingPromises.set(e,i);try{const a=await i;this.soundCache.set(e,{buffer:a,type:s})}finally{this.loadingPromises.delete(e)}}async loadAudioBuffer(e){if(!this.audioContext)throw new Error("AudioContext not initialized");const s=await(await fetch(e)).arrayBuffer();return await this.audioContext.decodeAudioData(s)}async preloadSounds(e){await Promise.all(e.map(t=>this.loadSound(t.id,t.url,t.type)))}isSoundLoaded(e){return this.soundCache.has(e)}play(e,t={}){const s=this.soundCache.get(e);if(!s||!this.audioContext)return null;const{volume:i=1,loop:a=!1,playbackRate:n=1}=t,h=this.audioContext.createBufferSource();h.buffer=s.buffer,h.loop=a,h.playbackRate.value=n;const u=this.audioContext.createGain();u.gain.value=i;const m=this.getCategoryGain(s.type);h.connect(u),u.connect(m);const d=`sound_${this.soundIdCounter++}`;return this.activeSounds.set(d,{source:h,gainNode:u,type:s.type,startTime:this.audioContext.currentTime}),h.onended=()=>{this.activeSounds.delete(d)},h.start(),this.emit("audio:soundPlayed",{id:e,soundId:d,type:s.type}),d}play3D(e,t,s={}){const i=this.soundCache.get(e);if(!i||!this.audioContext)return null;const{volume:a=1,loop:n=!1,playbackRate:h=1,refDistance:u=k.REF_DISTANCE,maxDistance:m=k.MAX_DISTANCE,rolloffFactor:d=k.ROLLOFF_FACTOR}=s,p=this.audioContext.createBufferSource();p.buffer=i.buffer,p.loop=n,p.playbackRate.value=h;const S=this.audioContext.createPanner();S.panningModel="HRTF",S.distanceModel="inverse",S.refDistance=u,S.maxDistance=m,S.rolloffFactor=d,S.setPosition(t.x,t.y,t.z);const g=this.audioContext.createGain();g.gain.value=a;const _=this.getCategoryGain(i.type);p.connect(S),S.connect(g),g.connect(_);const G=`sound_${this.soundIdCounter++}`;return this.activeSounds.set(G,{source:p,gainNode:g,pannerNode:S,type:i.type,startTime:this.audioContext.currentTime}),p.onended=()=>{this.activeSounds.delete(G)},p.start(),this.emit("audio:soundPlayed",{id:e,soundId:G,type:i.type,position:t}),G}updateSoundPosition(e,t){const s=this.activeSounds.get(e);s?.pannerNode&&s.pannerNode.setPosition(t.x,t.y,t.z)}stopSound(e){const t=this.activeSounds.get(e);if(t){try{t.source.stop()}catch{}this.activeSounds.delete(e)}}stopAllSounds(e){this.activeSounds.forEach((t,s)=>{if(!e||t.type===e){try{t.source.stop()}catch{}this.activeSounds.delete(s)}})}getCategoryGain(e){switch(e){case"music":return this.musicGain;case"ambient":return this.ambientGain;case"sfx":case"ui":default:return this.sfxGain}}async playMusic(e,t=!0){if(!this.audioContext||!this.musicGain)return;const s=this.soundCache.get(e);if(!s){console.warn(`Music track not loaded: ${e}`);return}this.currentMusicTrack===e&&this.currentMusicSource||(t&&this.currentMusicSource&&!this.isCrossfading?await this.crossfadeToTrack(e,s.buffer):this.playMusicImmediate(e,s.buffer),this.currentMusicTrack=e,this.emit("audio:musicChanged",{track:e}))}playMusicImmediate(e,t){!this.audioContext||!this.musicGain||(this.stopMusic(),this.currentMusicSource=this.audioContext.createBufferSource(),this.currentMusicSource.buffer=t,this.currentMusicSource.loop=!0,this.currentMusicGain=this.audioContext.createGain(),this.currentMusicGain.gain.value=1,this.currentMusicSource.connect(this.currentMusicGain),this.currentMusicGain.connect(this.musicGain),this.currentMusicSource.start(),this.currentMusicTrack=e)}async crossfadeToTrack(e,t){if(!this.audioContext||!this.musicGain)return;this.isCrossfading=!0,this.nextMusicSource=this.audioContext.createBufferSource(),this.nextMusicSource.buffer=t,this.nextMusicSource.loop=!0,this.nextMusicGain=this.audioContext.createGain(),this.nextMusicGain.gain.value=0,this.nextMusicSource.connect(this.nextMusicGain),this.nextMusicGain.connect(this.musicGain),this.nextMusicSource.start();const s=k.CROSSFADE_DURATION,i=this.audioContext.currentTime;if(this.currentMusicGain&&this.currentMusicGain.gain.linearRampToValueAtTime(0,i+s),this.nextMusicGain.gain.linearRampToValueAtTime(1,i+s),await new Promise(a=>setTimeout(a,s*1e3)),this.currentMusicSource)try{this.currentMusicSource.stop()}catch{}this.currentMusicSource=this.nextMusicSource,this.currentMusicGain=this.nextMusicGain,this.nextMusicSource=null,this.nextMusicGain=null,this.currentMusicTrack=e,this.isCrossfading=!1}stopMusic(){if(this.currentMusicSource){try{this.currentMusicSource.stop()}catch{}this.currentMusicSource=null}this.currentMusicGain=null,this.currentMusicTrack=null}getCurrentMusicTrack(){return this.currentMusicTrack}setMasterVolume(e){this._masterVolume=Math.max(0,Math.min(1,e)),this.masterGain&&(this.masterGain.gain.value=this._masterVolume),this.emit("audio:volumeChanged",{type:"master",volume:this._masterVolume})}setMusicVolume(e){this._musicVolume=Math.max(0,Math.min(1,e)),this.musicGain&&(this.musicGain.gain.value=this._musicVolume),this.emit("audio:volumeChanged",{type:"music",volume:this._musicVolume})}setSfxVolume(e){this._sfxVolume=Math.max(0,Math.min(1,e)),this.sfxGain&&(this.sfxGain.gain.value=this._sfxVolume),this.emit("audio:volumeChanged",{type:"sfx",volume:this._sfxVolume})}setAmbientVolume(e){this._ambientVolume=Math.max(0,Math.min(1,e)),this.ambientGain&&(this.ambientGain.gain.value=this._ambientVolume),this.emit("audio:volumeChanged",{type:"ambient",volume:this._ambientVolume})}get masterVolume(){return this._masterVolume}get musicVolume(){return this._musicVolume}get sfxVolume(){return this._sfxVolume}get ambientVolume(){return this._ambientVolume}pause(){if(this._isPaused)return;this._isPaused=!0,this.prePauseVolumes={master:this._masterVolume,music:this._musicVolume,sfx:this._sfxVolume,ambient:this._ambientVolume};const e=k.PAUSE_VOLUME_MULTIPLIER;this.masterGain&&(this.masterGain.gain.value=this._masterVolume*e)}resume(){this._isPaused&&(this._isPaused=!1,this.prePauseVolumes&&(this.masterGain&&(this.masterGain.gain.value=this.prePauseVolumes.master),this.prePauseVolumes=null))}get isPaused(){return this._isPaused}updateListenerPosition(e,t,s={x:0,y:1,z:0}){if(!this.audioContext)return;const i=this.audioContext.listener;i.positionX?(i.positionX.value=e.x,i.positionY.value=e.y,i.positionZ.value=e.z,i.forwardX.value=t.x,i.forwardY.value=t.y,i.forwardZ.value=t.z,i.upX.value=s.x,i.upY.value=s.y,i.upZ.value=s.z):(i.setPosition(e.x,e.y,e.z),i.setOrientation(t.x,t.y,t.z,s.x,s.y,s.z))}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.stopAllSounds(),this.stopMusic(),this.soundCache.clear(),this.loadingPromises.clear(),this.activeSounds.clear(),this.listener&&this.camera&&this.camera.remove(this.listener),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.listener=null,this.camera=null,this.masterGain=null,this.musicGain=null,this.sfxGain=null,this.ambientGain=null,this.eventListeners.clear()}isInitialized(){return this.audioContext!==null&&this.audioContext.state!=="closed"}getContextState(){return this.audioContext?.state??null}}const P={[l.PISTOL_FIRE]:"/audio/weapons/pistol_fire.mp3",[l.RIFLE_FIRE]:"/audio/weapons/rifle_fire.mp3",[l.SHOTGUN_FIRE]:"/audio/weapons/shotgun_fire.mp3",[l.MELEE_SWING]:"/audio/weapons/melee_swing.mp3",[l.RELOAD]:"/audio/weapons/reload.mp3",[l.EMPTY_CLICK]:"/audio/weapons/empty_click.mp3",[l.ZOMBIE_GROWL]:"/audio/zombies/growl.mp3",[l.ZOMBIE_ATTACK]:"/audio/zombies/attack.mp3",[l.ZOMBIE_DEATH]:"/audio/zombies/death.mp3",[l.ZOMBIE_HIT]:"/audio/zombies/hit.mp3",[l.PLAYER_HURT]:"/audio/player/hurt.mp3",[l.PLAYER_DEATH]:"/audio/player/death.mp3",[l.FOOTSTEP]:"/audio/player/footstep.mp3",[l.JUMP]:"/audio/player/jump.mp3",[l.LAND]:"/audio/player/land.mp3",[l.BUTTON_CLICK]:"/audio/ui/click.mp3",[l.MENU_OPEN]:"/audio/ui/menu_open.mp3",[l.MENU_CLOSE]:"/audio/ui/menu_close.mp3",[l.WAVE_START]:"/audio/waves/wave_start.mp3",[l.WAVE_COMPLETE]:"/audio/waves/wave_complete.mp3",[l.PREPARATION_TICK]:"/audio/waves/tick.mp3",[L.MENU]:"/audio/music/menu.mp3",[L.AMBIENT]:"/audio/music/ambient.mp3",[L.COMBAT]:"/audio/music/combat.mp3",[L.TENSE]:"/audio/music/tense.mp3",[L.GAME_OVER]:"/audio/music/game_over.mp3"};class Nt{audioManager;isInitialized=!1;zombieAmbientSounds=new Map;zombieGrowlMinInterval=3;zombieGrowlMaxInterval=8;playerPosition={x:0,y:0,z:0};activeLoopingSounds=new Map;eventListeners=new Map;constructor(e){this.audioManager=e}async init(){if(this.isInitialized)return;const e=[];e.push({id:l.PISTOL_FIRE,url:P[l.PISTOL_FIRE],type:E.SFX},{id:l.RIFLE_FIRE,url:P[l.RIFLE_FIRE],type:E.SFX},{id:l.SHOTGUN_FIRE,url:P[l.SHOTGUN_FIRE],type:E.SFX},{id:l.MELEE_SWING,url:P[l.MELEE_SWING],type:E.SFX},{id:l.RELOAD,url:P[l.RELOAD],type:E.SFX},{id:l.EMPTY_CLICK,url:P[l.EMPTY_CLICK],type:E.SFX}),e.push({id:l.ZOMBIE_GROWL,url:P[l.ZOMBIE_GROWL],type:E.AMBIENT},{id:l.ZOMBIE_ATTACK,url:P[l.ZOMBIE_ATTACK],type:E.SFX},{id:l.ZOMBIE_DEATH,url:P[l.ZOMBIE_DEATH],type:E.SFX},{id:l.ZOMBIE_HIT,url:P[l.ZOMBIE_HIT],type:E.SFX}),e.push({id:l.PLAYER_HURT,url:P[l.PLAYER_HURT],type:E.SFX},{id:l.PLAYER_DEATH,url:P[l.PLAYER_DEATH],type:E.SFX},{id:l.FOOTSTEP,url:P[l.FOOTSTEP],type:E.SFX},{id:l.JUMP,url:P[l.JUMP],type:E.SFX},{id:l.LAND,url:P[l.LAND],type:E.SFX}),e.push({id:l.WAVE_START,url:P[l.WAVE_START],type:E.SFX},{id:l.WAVE_COMPLETE,url:P[l.WAVE_COMPLETE],type:E.SFX},{id:l.PREPARATION_TICK,url:P[l.PREPARATION_TICK],type:E.UI}),e.push({id:L.MENU,url:P[L.MENU],type:E.MUSIC},{id:L.AMBIENT,url:P[L.AMBIENT],type:E.MUSIC},{id:L.COMBAT,url:P[L.COMBAT],type:E.MUSIC},{id:L.TENSE,url:P[L.TENSE],type:E.MUSIC},{id:L.GAME_OVER,url:P[L.GAME_OVER],type:E.MUSIC});for(const t of e)try{await this.audioManager.loadSound(t.id,t.url,t.type)}catch{console.debug(`Audio file not found: ${t.url}`)}this.isInitialized=!0}playWeaponFire(e,t){let s;switch(e.toLowerCase()){case"pistol":s=l.PISTOL_FIRE;break;case"rifle":s=l.RIFLE_FIRE;break;case"shotgun":s=l.SHOTGUN_FIRE;break;case"melee":s=l.MELEE_SWING;break;default:s=l.PISTOL_FIRE}this.audioManager.play3D(s,t,{volume:1,refDistance:5,maxDistance:50})}playReload(e){this.audioManager.play3D(l.RELOAD,e,{volume:.8,refDistance:2,maxDistance:20})}playEmptyClick(e){this.audioManager.play3D(l.EMPTY_CLICK,e,{volume:.6,refDistance:1,maxDistance:10})}playZombieGrowl(e){this.audioManager.play3D(l.ZOMBIE_GROWL,e,{volume:.7,refDistance:5,maxDistance:k.MAX_DISTANCE,rolloffFactor:1.5})}playZombieAttack(e){this.audioManager.play3D(l.ZOMBIE_ATTACK,e,{volume:.9,refDistance:3,maxDistance:30})}playZombieDeath(e){this.audioManager.play3D(l.ZOMBIE_DEATH,e,{volume:.8,refDistance:5,maxDistance:40})}playZombieHit(e){this.audioManager.play3D(l.ZOMBIE_HIT,e,{volume:.7,refDistance:3,maxDistance:30})}registerZombie(e){this.zombieAmbientSounds.has(e)||this.zombieAmbientSounds.set(e,{soundId:null,lastPlayTime:0,interval:this.getRandomGrowlInterval()})}unregisterZombie(e){const t=this.zombieAmbientSounds.get(e);t?.soundId&&this.audioManager.stopSound(t.soundId),this.zombieAmbientSounds.delete(e)}updateZombieAmbientSounds(e,t){const s=performance.now()/1e3;for(const i of t){if(i.state===M.DYING)continue;let a=this.zombieAmbientSounds.get(i.id);a||(this.registerZombie(i.id),a=this.zombieAmbientSounds.get(i.id)),s-a.lastPlayTime>=a.interval&&this.calculateDistance(i.position,this.playerPosition)<k.MAX_DISTANCE&&(this.playZombieGrowl(i.position),a.lastPlayTime=s,a.interval=this.getRandomGrowlInterval())}}getRandomGrowlInterval(){return this.zombieGrowlMinInterval+Math.random()*(this.zombieGrowlMaxInterval-this.zombieGrowlMinInterval)}calculateDistance(e,t){const s=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return Math.sqrt(s*s+i*i+a*a)}playPlayerHurt(){this.audioManager.play(l.PLAYER_HURT,{volume:1})}playPlayerDeath(){this.audioManager.play(l.PLAYER_DEATH,{volume:1})}playFootstep(e){const t=.9+Math.random()*.2;this.audioManager.play3D(l.FOOTSTEP,e,{volume:.4,playbackRate:t,refDistance:1,maxDistance:15})}playJump(){this.audioManager.play(l.JUMP,{volume:.6})}playLand(){this.audioManager.play(l.LAND,{volume:.5})}playWaveStart(){this.audioManager.play(l.WAVE_START,{volume:1})}playWaveComplete(){this.audioManager.play(l.WAVE_COMPLETE,{volume:1})}playPreparationTick(){this.audioManager.play(l.PREPARATION_TICK,{volume:.5})}playMenuMusic(){this.audioManager.playMusic(L.MENU,!0)}playAmbientMusic(){this.audioManager.playMusic(L.AMBIENT,!0)}playCombatMusic(){this.audioManager.playMusic(L.COMBAT,!0)}playTenseMusic(){this.audioManager.playMusic(L.TENSE,!0)}playGameOverMusic(){this.audioManager.playMusic(L.GAME_OVER,!0)}stopMusic(){this.audioManager.stopMusic()}playButtonClick(){this.audioManager.play(l.BUTTON_CLICK,{volume:.5})}playMenuOpen(){this.audioManager.play(l.MENU_OPEN,{volume:.6})}playMenuClose(){this.audioManager.play(l.MENU_CLOSE,{volume:.6})}setPlayerPosition(e){this.playerPosition={...e}}update(e){}onGamePause(){this.audioManager.pause()}onGameResume(){this.audioManager.resume()}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.zombieAmbientSounds.forEach(e=>{e.soundId&&this.audioManager.stopSound(e.soundId)}),this.zombieAmbientSounds.clear(),this.activeLoopingSounds.forEach(e=>{this.audioManager.stopSound(e)}),this.activeLoopingSounds.clear(),this.eventListeners.clear()}getAudioManager(){return this.audioManager}}const j={DEFAULT_SENSITIVITY:.002,MIN_SENSITIVITY:1e-4,MAX_SENSITIVITY:.01,FOV:75,NEAR:.1,FAR:1e3};class Wt{camera;player=null;sensitivity=j.DEFAULT_SENSITIVITY;eventListeners=new Map;constructor(e=16/9){this.camera=new ze(j.FOV,e,j.NEAR,j.FAR),this.camera.position.set(0,I.EYE_HEIGHT,0),this.camera.rotation.order="YXZ"}attachToPlayer(e){this.player=e,e.attachCamera(this.camera)}detachFromPlayer(){this.player=null}handleMouseMove(e,t){if(!this.player)return;const s=e*this.sensitivity,i=t*this.sensitivity;this.player.rotate(s,i)}updateAspect(e){this.camera.aspect=e,this.camera.updateProjectionMatrix()}setSensitivity(e){const t=this.sensitivity;this.sensitivity=Math.max(j.MIN_SENSITIVITY,Math.min(j.MAX_SENSITIVITY,e)),t!==this.sensitivity&&this.emit("camera:sensitivityChanged",{previous:t,current:this.sensitivity})}getSensitivity(){return this.sensitivity}getCamera(){return this.camera}getPosition(){return this.camera.position.clone()}getForwardDirection(){const e=new c(0,0,-1);return e.applyQuaternion(this.camera.quaternion),e}getRightDirection(){const e=new c(1,0,0);return e.applyQuaternion(this.camera.quaternion),e}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}}class Ft{scene;camera;renderer;lodObjects=new Map;frustum=new ut;projScreenMatrix=new mt;frameCount=0;lastFPSUpdate=0;currentFPS=60;targetFPS=60;frameTimes=[];adaptiveQualityEnabled=!0;currentQualityLevel=1;qualityAdjustCooldown=0;geometryPool=new Map;eventListeners=new Map;visibleCount=0;culledCount=0;constructor(e,t,s){this.scene=e,this.camera=t,this.renderer=s}update(e){this.updatePerformanceMetrics(e),this.updateFrustum(),this.performFrustumCulling(),this.updateLODLevels(),this.adaptiveQualityEnabled&&this.adjustQuality(e)}updatePerformanceMetrics(e){this.frameCount++,this.frameTimes.push(e*1e3),this.frameTimes.length>60&&this.frameTimes.shift();const t=performance.now();t-this.lastFPSUpdate>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSUpdate=t)}updateFrustum(){this.projScreenMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromProjectionMatrix(this.projScreenMatrix)}performFrustumCulling(){this.visibleCount=0,this.culledCount=0,this.scene.traverse(e=>{if(!(e instanceof v)||e.userData.noCull)return;e.geometry.boundingSphere||e.geometry.computeBoundingSphere();const t=new c;e.getWorldPosition(t);const s=e.geometry.boundingSphere.clone();s.center.copy(t);const i=e.scale,a=Math.max(i.x,i.y,i.z);s.radius*=a;const n=this.frustum.intersectsSphere(s);e.visible=n,n?this.visibleCount++:this.culledCount++})}updateLODLevels(){this.lodObjects.forEach(e=>{e.update(this.camera)})}adjustQuality(e){if(this.qualityAdjustCooldown>0){this.qualityAdjustCooldown-=e;return}const t=this.frameTimes.reduce((i,a)=>i+a,0)/this.frameTimes.length,s=1e3/this.targetFPS;t>s*1.5&&this.currentQualityLevel>0?(this.currentQualityLevel--,this.applyQualityLevel(),this.qualityAdjustCooldown=3,this.emit("lod:performanceWarning",{fps:this.currentFPS,quality:this.currentQualityLevel})):t<s*.7&&this.currentQualityLevel<2&&(this.currentQualityLevel++,this.applyQualityLevel(),this.qualityAdjustCooldown=5)}applyQualityLevel(){switch(this.currentQualityLevel){case 0:this.renderer.setPixelRatio(1),this.setLODDistances(20,40,80);break;case 1:this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.setLODDistances(30,60,120);break;case 2:this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setLODDistances(50,100,200);break}this.emit("lod:qualityChanged",{level:this.currentQualityLevel})}setLODDistances(e,t,s){this.lodObjects.forEach(i=>{const a=i.levels;a.length>=3&&(a[0].distance=0,a[1].distance=e,a[2].distance=t,a.length>=4&&(a[3].distance=s))})}createLODObject(e,t,s,i,a){const n=new ct;return n.addLevel(t,0),s&&n.addLevel(s,30),i&&n.addLevel(i,60),a&&n.addLevel(a,120),this.lodObjects.set(e,n),n}createSimplifiedGeometry(e,t){const s=e.getAttribute("position");if(!s)return e.clone();const i=s.count,a=Math.floor(i*t);if(a>=i)return e.clone();const n=new dt,h=[],u=Math.ceil(i/a);for(let d=0;d<i;d+=u)h.push(s.getX(d),s.getY(d),s.getZ(d));n.setAttribute("position",new Ie(h,3));const m=e.getAttribute("normal");if(m){const d=[];for(let p=0;p<i;p+=u)d.push(m.getX(p),m.getY(p),m.getZ(p));n.setAttribute("normal",new Ie(d,3))}return n.computeBoundingSphere(),n}createBillboard(e,t=8947848,s=10){const i=new pt({map:e,color:t,transparent:!0,opacity:.8}),a=new gt(i);return a.scale.set(s,s,1),a}removeLODObject(e){const t=this.lodObjects.get(e);t&&(this.scene.remove(t),this.lodObjects.delete(e))}getPooledGeometry(e,t){const s=this.geometryPool.get(e);return s&&s.length>0?s.pop():t()}returnToPool(e,t){this.geometryPool.has(e)||this.geometryPool.set(e,[]);const s=this.geometryPool.get(e);s.length<50?s.push(t):t.dispose()}getPerformanceMetrics(){const e=this.renderer.info,t=this.frameTimes.length>0?this.frameTimes.reduce((s,i)=>s+i,0)/this.frameTimes.length:16.67;return{fps:this.currentFPS,frameTime:t,drawCalls:e.render.calls,triangles:e.render.triangles,visibleObjects:this.visibleCount,culledObjects:this.culledCount}}getFPS(){return this.currentFPS}getQualityLevel(){return this.currentQualityLevel}setQualityLevel(e){this.currentQualityLevel=Math.max(0,Math.min(2,e)),this.applyQualityLevel()}setAdaptiveQuality(e){this.adaptiveQualityEnabled=e}setTargetFPS(e){this.targetFPS=Math.max(30,Math.min(144,e))}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}dispose(){this.lodObjects.forEach(e=>{e.traverse(t=>{t instanceof v&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(s=>s.dispose()):t.material.dispose())})}),this.lodObjects.clear(),this.geometryPool.forEach(e=>{e.forEach(t=>t.dispose())}),this.geometryPool.clear(),this.eventListeners.clear()}}var Ee=(r=>(r.FPS_DROP="performance:fpsDrop",r.FPS_RECOVER="performance:fpsRecover",r.MEMORY_WARNING="performance:memoryWarning",r))(Ee||{});class kt{renderer=null;frameCount=0;lastFPSUpdate=0;currentFPS=60;frameTimes=[];maxFrameTimeSamples=120;targetFPS=60;lowFPSThreshold=45;criticalFPSThreshold=30;isLowFPS=!1;consecutiveLowFrames=0;lowFrameThreshold=30;lastMemoryCheck=0;memoryCheckInterval=5e3;zombieCount=0;visibleObjectCount=0;eventListeners=new Map;constructor(){this.lastFPSUpdate=performance.now(),this.lastMemoryCheck=performance.now()}setRenderer(e){this.renderer=e}setTargetFPS(e){this.targetFPS=Math.max(30,Math.min(144,e)),this.lowFPSThreshold=this.targetFPS*.75,this.criticalFPSThreshold=this.targetFPS*.5}update(e){const t=e*1e3;this.frameTimes.push(t),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift(),this.frameCount++;const s=performance.now();s-this.lastFPSUpdate>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSUpdate=s,this.checkFPSHealth()),s-this.lastMemoryCheck>=this.memoryCheckInterval&&(this.checkMemory(),this.lastMemoryCheck=s)}checkFPSHealth(){this.currentFPS<this.lowFPSThreshold?(this.consecutiveLowFrames++,!this.isLowFPS&&this.consecutiveLowFrames>=this.lowFrameThreshold/60&&(this.isLowFPS=!0,this.emit("performance:fpsDrop",{fps:this.currentFPS,target:this.targetFPS,isCritical:this.currentFPS<this.criticalFPSThreshold}))):(this.isLowFPS&&(this.isLowFPS=!1,this.emit("performance:fpsRecover",{fps:this.currentFPS,target:this.targetFPS})),this.consecutiveLowFrames=0)}checkMemory(){const e=performance;if(e.memory){const t=e.memory.usedJSHeapSize/1048576,s=e.memory.jsHeapSizeLimit/(1024*1024),i=t/s*100;i>80&&this.emit("performance:memoryWarning",{usedMB:Math.round(t),limitMB:Math.round(s),usagePercent:Math.round(i)})}}setZombieCount(e){this.zombieCount=e}setVisibleObjectCount(e){this.visibleObjectCount=e}getMetrics(){const e=this.frameTimes.length>0?this.frameTimes.reduce((d,p)=>d+p,0)/this.frameTimes.length:16.67,t=this.frameTimes.length>0?Math.min(...this.frameTimes):16.67,s=this.frameTimes.length>0?Math.max(...this.frameTimes):16.67;let i=0,a=0,n=0,h=0;if(this.renderer){const d=this.renderer.info;i=d.render.calls,a=d.render.triangles,n=d.memory.geometries,h=d.memory.textures}let u=0;const m=performance;return m.memory&&(u=Math.round(m.memory.usedJSHeapSize/(1024*1024))),{fps:this.currentFPS,frameTime:this.frameTimes[this.frameTimes.length-1]??16.67,avgFrameTime:e,minFrameTime:t,maxFrameTime:s,drawCalls:i,triangles:a,geometries:n,textures:h,memoryUsed:u,zombieCount:this.zombieCount,visibleObjects:this.visibleObjectCount}}getFPS(){return this.currentFPS}isPerformanceDegraded(){return this.isLowFPS}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}reset(){this.frameCount=0,this.currentFPS=60,this.frameTimes=[],this.isLowFPS=!1,this.consecutiveLowFrames=0}dispose(){this.eventListeners.clear(),this.frameTimes=[],this.renderer=null}}var K=(r=>(r.STATE_CHANGED="gameController:stateChanged",r.SCORE_UPDATED="gameController:scoreUpdated",r.WAVE_STARTED="gameController:waveStarted",r.WAVE_ENDED="gameController:waveEnded",r.GAME_OVER="gameController:gameOver",r.PLAYER_DAMAGED="gameController:playerDamaged",r))(K||{});const X={mouseSensitivity:50,masterVolume:80,musicVolume:70,sfxVolume:90};class Vt{sceneManager;inputManager;player;weaponManager;zombieManager;waveManager;audioManager;audioController;firstPersonCamera;lodManager;performanceMonitor;_isInitialized=!1;_isRunning=!1;_isPaused=!1;_score=0;_playTime=0;config={...X};eventListeners=new Map;_cachedPlayerPos=new c;_cachedDirection=new c;constructor(e,t){this.sceneManager=e,this.inputManager=t,this.player=new xe({x:0,y:0,z:0}),this.weaponManager=new It,this.zombieManager=new Dt(this.sceneManager.getScene()),this.waveManager=new Gt,this.audioManager=new zt,this.audioController=new Nt(this.audioManager);const s=this.sceneManager.getCamera();this.firstPersonCamera=new Wt(s.aspect),this.firstPersonCamera.setSensitivity(this.config.mouseSensitivity/50*.002),this.lodManager=new Ft(this.sceneManager.getScene(),this.sceneManager.getCamera(),this.sceneManager.getRenderer()),this.performanceMonitor=new kt,this.performanceMonitor.setRenderer(this.sceneManager.getRenderer())}async init(){this._isInitialized||(this.player.attachCamera(this.sceneManager.getCamera()),this.waveManager.init(this.zombieManager,this.player),await this.audioController.init(),this.setupEventListeners(),this.setupPerformanceListeners(),this.loadConfig(),this._isInitialized=!0)}setupPerformanceListeners(){this.performanceMonitor.on(Ee.FPS_DROP,e=>{const t=e;if(console.warn(`Performance warning: FPS dropped to ${t.fps}`),t.isCritical){const s=this.lodManager.getQualityLevel();s>0&&this.lodManager.setQualityLevel(s-1)}}),this.performanceMonitor.on(Ee.FPS_RECOVER,()=>{})}setupEventListeners(){this.player.on(ee.HEALTH_CHANGED,e=>{const t=e;t.damage&&t.damage>0&&(this.audioController.playPlayerHurt(),this.emit("gameController:playerDamaged",t)),this.emitStateChanged()}),this.player.on(ee.DEATH,()=>{this.audioController.playPlayerDeath(),this.waveManager.triggerGameOver(Te.PLAYER_DEATH)}),this.player.on(ee.JUMP,()=>{this.audioController.playJump()}),this.player.on(ee.LAND,()=>{this.audioController.playLand()}),this.weaponManager.on(Q.WEAPON_FIRED,e=>{const t=e;this.audioController.playWeaponFire(t.weapon.type,this.player.position)}),this.weaponManager.on(Q.WEAPON_RELOAD_START,()=>{this.audioController.playReload(this.player.position)}),this.weaponManager.on(Q.WEAPON_EMPTY,()=>{this.audioController.playEmptyClick(this.player.position)}),this.weaponManager.on(Q.WEAPON_SWITCHED,()=>{this.emitStateChanged()}),this.weaponManager.on(Q.AMMO_CHANGED,()=>{this.emitStateChanged()}),this.waveManager.on(q.WAVE_START,()=>{this.audioController.playWaveStart(),this.audioController.playCombatMusic(),this.emit("gameController:waveStarted",{wave:this.waveManager.currentWave,totalZombies:this.waveManager.totalZombiesInWave})}),this.waveManager.on(q.WAVE_END,()=>{this.audioController.playWaveComplete(),this.audioController.playAmbientMusic(),this.emit("gameController:waveEnded",{wave:this.waveManager.currentWave,score:this.waveManager.score})}),this.waveManager.on(q.PREPARATION_START,()=>{this.audioController.playAmbientMusic()}),this.waveManager.on(q.SCORE_CHANGED,e=>{const t=e;this._score=t.score,this.emit("gameController:scoreUpdated",{score:this._score})}),this.waveManager.on(q.GAME_OVER,e=>{this.audioController.playGameOverMusic(),this.emit("gameController:gameOver",e)}),this.zombieManager.on(R.ZOMBIE_DEATH,e=>{const t=e;t.position&&this.audioController.playZombieDeath(t.position)})}startNewGame(){this.player=new xe({x:0,y:0,z:0}),this.player.attachCamera(this.sceneManager.getCamera()),this.setupEventListeners(),this.zombieManager.clear(),this.waveManager.reset(),this.waveManager.init(this.zombieManager,this.player),this._score=0,this._playTime=0,this._isRunning=!0,this._isPaused=!1,this.waveManager.startGame(),this.audioController.playAmbientMusic(),this.emit(R.GAME_START)}loadGame(e){this.player.fromState({position:e.player.position,rotation:e.player.rotation,health:e.player.health,stamina:e.player.stamina}),this.weaponManager.fromState({weapons:e.player.weapons,currentWeaponIndex:e.player.currentWeaponIndex}),this.waveManager.fromState(e.wave,e.score),this.zombieManager.fromState(e.zombies),this._score=e.score,this._playTime=e.playTime,this._isRunning=!0,this._isPaused=!1,this.emit(R.GAME_START)}getGameState(){const e=this.weaponManager.toState();return{player:{position:this.player.position,rotation:this.player.rotation,health:this.player.health,stamina:this.player.stamina,weapons:e.weapons,currentWeaponIndex:e.currentWeaponIndex},wave:this.waveManager.toState(),zombies:this.zombieManager.toState(),score:this._score,playTime:this._playTime,timestamp:Date.now()}}update(e){!this._isRunning||this._isPaused||(this._playTime+=e,this.performanceMonitor.update(e),this.performanceMonitor.setZombieCount(this.zombieManager.getActiveCount()),this.player.update(e),this.zombieManager.update(e,this.player.position),this.waveManager.update(e),this.audioController.setPlayerPosition(this.player.position),this.audioController.update(e),this.updateZombieAmbientSoundsThrottled(e),this.checkZombieAttacks(),this._cachedPlayerPos.set(this.player.position.x,this.player.position.y,this.player.position.z),this.sceneManager.updateLighting(this._cachedPlayerPos),this.lodManager.update(e))}_lastZombieAudioUpdate=0;_zombieAudioUpdateInterval=.1;updateZombieAmbientSoundsThrottled(e){if(this._lastZombieAudioUpdate+=e,this._lastZombieAudioUpdate>=this._zombieAudioUpdateInterval){this._lastZombieAudioUpdate=0;const t=this.zombieManager.getAllZombies().map(s=>({id:s.id,position:s.position,state:s.state}));this.audioController.updateZombieAmbientSounds(e,t)}}checkZombieAttacks(){const e=this.zombieManager.getZombiesInRange(this.player.position,2);for(const t of e)if(t.canAttack()){const s=t.getDamage();this.player.takeDamage(s),this.audioController.playZombieAttack(t.position)}}processInput(e){if(!this._isRunning||this._isPaused)return;const t=this.inputManager.getMovementInput(),s=this.inputManager.getMouseMovement();this.player.move(t.x,t.z,e);const i=this.config.mouseSensitivity/50;this.player.rotate(s.x*i*.002,s.y*i*.002),this.player.sprint(this.inputManager.wantsToSprint()),this.inputManager.wantsToJump()&&this.player.jump(),this.inputManager.wantsToFire()&&this.fireWeapon(),this.inputManager.wantsToReload()&&this.weaponManager.reload();const a=this.inputManager.getMouseWheelDirection();a>0?this.weaponManager.cycleNext():a<0&&this.weaponManager.cyclePrevious();const n=this.inputManager.getWeaponSlotPressed();n>=0&&this.weaponManager.switchToSlot(n)}fireWeapon(){const e=this.sceneManager.getCamera(),t=e.position.clone(),s=new c;e.getWorldDirection(s);const i=this.weaponManager.fire(t,s,this.sceneManager.getScene());if(i.success&&i.hits)for(const a of i.hits)a.zombieId&&(this.zombieManager.damageZombie(a.zombieId,i.damage,a.point),this.audioController.playZombieHit(a.point))}pause(){!this._isRunning||this._isPaused||(this._isPaused=!0,this.audioController.onGamePause(),this.emit(R.GAME_PAUSE))}resume(){!this._isRunning||!this._isPaused||(this._isPaused=!1,this.audioController.onGameResume(),this.emit(R.GAME_RESUME))}stop(){this._isRunning=!1,this._isPaused=!1,this.audioController.stopMusic(),this.emit(R.GAME_STOP)}applyConfig(e){this.config={...this.config,...e},e.mouseSensitivity!==void 0&&this.firstPersonCamera.setSensitivity(e.mouseSensitivity/50),e.masterVolume!==void 0&&this.audioManager.setMasterVolume(e.masterVolume/100),e.musicVolume!==void 0&&this.audioManager.setMusicVolume(e.musicVolume/100),e.sfxVolume!==void 0&&this.audioManager.setSfxVolume(e.sfxVolume/100),this.saveConfig()}saveConfig(){localStorage.setItem("gameSettings",JSON.stringify(this.config))}loadConfig(){const e=localStorage.getItem("zww_settings");if(e)try{const t=JSON.parse(e);this.config={...X,mouseSensitivity:t.mouseSensitivity??X.mouseSensitivity,masterVolume:t.masterVolume??X.masterVolume,musicVolume:t.musicVolume??X.musicVolume,sfxVolume:t.sfxVolume??X.sfxVolume},this.applyConfig(this.config)}catch{}}getConfig(){return{...this.config}}get isInitialized(){return this._isInitialized}get isRunning(){return this._isRunning}get isPaused(){return this._isPaused}get score(){return this._score}get playTime(){return this._playTime}getPlayer(){return this.player}getWeaponManager(){return this.weaponManager}getZombieManager(){return this.zombieManager}getWaveManager(){return this.waveManager}getAudioController(){return this.audioController}getLODManager(){return this.lodManager}getPerformanceMonitor(){return this.performanceMonitor}getPerformanceMetrics(){return this.performanceMonitor.getMetrics()}getHUDState(){const e=this.weaponManager.getCurrentWeapon();return{health:this.player.health,maxHealth:this.player.maxHealth,stamina:this.player.stamina,maxStamina:this.player.maxStamina,currentWeaponName:e?.name??"None",currentWeaponSlot:this.weaponManager.getCurrentWeaponIndex(),currentAmmo:e?.currentAmmo??0,reserveAmmo:e?.reserveAmmo??0,magazineSize:e?.magazineSize??0,isReloading:this.weaponManager.isReloading(),currentWave:this.waveManager.currentWave,zombiesKilled:this.waveManager.zombiesKilled,totalZombiesInWave:this.waveManager.totalZombiesInWave,isPreparationPhase:this.waveManager.isPreparationPhase,preparationTimeLeft:this.waveManager.preparationTimeLeft,score:this._score}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}emitStateChanged(){this.emit("gameController:stateChanged",this.getHUDState())}dispose(){this.stop(),this.zombieManager.dispose(),this.waveManager.dispose(),this.audioController.dispose(),this.audioManager.dispose(),this.lodManager.dispose(),this.performanceMonitor.dispose(),this.eventListeners.clear()}}const Ht={class:"game-hud"},Ut={class:"hud-section top-left"},Bt={class:"wave-info"},Zt={class:"wave-number"},Kt={class:"value"},$t={key:0,class:"preparation-phase"},Yt={class:"prep-time"},jt={key:1,class:"zombie-count"},Xt={class:"value"},Jt={class:"hud-section top-right"},Qt={class:"score-display"},qt={class:"value"},es={class:"hud-section bottom-left"},ts={class:"player-stats"},ss={class:"stat-bar health-bar"},is={class:"bar-container"},as={class:"bar-value"},ns={class:"stat-bar stamina-bar"},rs={class:"bar-container"},os={class:"bar-value"},hs={class:"hud-section bottom-right"},ls={class:"weapon-info"},us={class:"weapon-name"},ms={class:"slot-indicator"},cs={class:"name"},ds={class:"ammo-text"},ps=ie({__name:"GameHUD",props:{health:{default:100},maxHealth:{default:100},stamina:{default:100},maxStamina:{default:100},currentWeaponName:{default:"Pistol"},currentWeaponSlot:{default:0},currentAmmo:{default:15},reserveAmmo:{default:60},magazineSize:{default:15},isReloading:{type:Boolean,default:!1},currentWave:{default:1},zombiesKilled:{default:0},totalZombiesInWave:{default:15},isPreparationPhase:{type:Boolean,default:!1},preparationTimeLeft:{default:30},score:{default:0}},setup(r){const e=r,t=x(()=>e.health/e.maxHealth*100),s=x(()=>e.stamina/e.maxStamina*100),i=x(()=>e.totalZombiesInWave-e.zombiesKilled),a=x(()=>t.value>50?"#4ade80":t.value>25?"#fbbf24":"#ef4444"),n=x(()=>{const S=Math.ceil(e.preparationTimeLeft),g=Math.floor(S/60),_=S%60;return`${g}:${_.toString().padStart(2,"0")}`}),h=x(()=>e.score.toLocaleString()),u=x(()=>e.currentWeaponSlot+1),m=x(()=>e.isReloading?"RELOADING...":`${e.currentAmmo} / ${e.reserveAmmo}`),d=x(()=>e.currentAmmo<=e.magazineSize*.25&&e.currentAmmo>0),p=x(()=>e.currentAmmo===0);return(S,g)=>(T(),C("div",Ht,[o("div",Ut,[o("div",Bt,[o("div",Zt,[g[0]||(g[0]=o("span",{class:"label"},"WAVE",-1)),o("span",Kt,y(r.currentWave),1)]),r.isPreparationPhase?(T(),C("div",$t,[g[1]||(g[1]=o("span",{class:"prep-label"},"NEXT WAVE IN",-1)),o("span",Yt,y(n.value),1)])):(T(),C("div",jt,[g[2]||(g[2]=o("span",{class:"label"},"ZOMBIES",-1)),o("span",Xt,y(i.value),1)]))])]),o("div",Jt,[o("div",Qt,[g[3]||(g[3]=o("span",{class:"label"},"SCORE",-1)),o("span",qt,y(h.value),1)])]),o("div",es,[o("div",ts,[o("div",ss,[g[4]||(g[4]=o("div",{class:"bar-label"},[o("span",{class:"icon"},""),o("span",{class:"text"},"HEALTH")],-1)),o("div",is,[o("div",{class:"bar-fill",style:se({width:`${t.value}%`,backgroundColor:a.value})},null,4),o("span",as,y(Math.ceil(r.health))+" / "+y(r.maxHealth),1)])]),o("div",ns,[g[5]||(g[5]=o("div",{class:"bar-label"},[o("span",{class:"icon"},""),o("span",{class:"text"},"STAMINA")],-1)),o("div",rs,[o("div",{class:"bar-fill stamina-fill",style:se({width:`${s.value}%`})},null,4),o("span",os,y(Math.ceil(r.stamina))+"%",1)])])])]),o("div",hs,[o("div",ls,[o("div",us,[o("span",ms,"["+y(u.value)+"]",1),o("span",cs,y(r.currentWeaponName),1)]),o("div",{class:te(["ammo-display",{"low-ammo":d.value,"empty-ammo":p.value,reloading:r.isReloading}])},[g[6]||(g[6]=o("span",{class:"ammo-icon"},"",-1)),o("span",ds,y(m.value),1)],2)])]),g[7]||(g[7]=Ze('<div class="crosshair" data-v-9f35ac9c><div class="crosshair-dot" data-v-9f35ac9c></div><div class="crosshair-line top" data-v-9f35ac9c></div><div class="crosshair-line bottom" data-v-9f35ac9c></div><div class="crosshair-line left" data-v-9f35ac9c></div><div class="crosshair-line right" data-v-9f35ac9c></div></div>',1))]))}}),gs=ne(ps,[["__scopeId","data-v-9f35ac9c"]]),fs={class:"damage-overlay"},vs={class:"health-value"},_s={key:2,class:"heartbeat-overlay"},ws=ie({__name:"DamageOverlay",props:{health:{default:100},maxHealth:{default:100},lastDamage:{default:0},damageTimestamp:{default:0}},setup(r){const e=r,t=N(!1),s=N(0),i=x(()=>e.health/e.maxHealth*100),a=x(()=>i.value<25&&i.value>0),n=x(()=>i.value<10&&i.value>0),h=x(()=>a.value?Math.min(.6,(25-i.value)/25*.6):0);Ke(()=>e.damageTimestamp,()=>{e.lastDamage>0&&u(e.lastDamage)});function u(m){s.value=Math.min(.8,m/50*.8),t.value=!0,setTimeout(()=>{t.value=!1,s.value=0},300)}return x(()=>t.value?s.value:h.value),(m,d)=>(T(),C("div",fs,[o("div",{class:te(["vignette damage-vignette",{"flash-active":t.value}]),style:se({opacity:t.value?s.value:0})},null,6),a.value?(T(),C("div",{key:0,class:te(["vignette low-health-vignette",{critical:n.value}]),style:se({opacity:h.value})},null,6)):W("",!0),a.value?(T(),C("div",{key:1,class:te(["low-health-warning",{critical:n.value}])},[d[0]||(d[0]=o("div",{class:"warning-icon"},"",-1)),d[1]||(d[1]=o("div",{class:"warning-text"},"LOW HEALTH",-1)),o("div",vs,y(Math.ceil(e.health)),1)],2)):W("",!0),n.value?(T(),C("div",_s)):W("",!0)]))}}),Ms=ne(ws,[["__scopeId","data-v-3520d873"]]),ys={class:"pause-menu-overlay"},Ss={class:"pause-menu"},bs={key:0,class:"menu-content"},As={key:0,class:"save-message success"},Es={key:1,class:"save-message error"},Ps={class:"menu-buttons"},Ts=["disabled"],Cs={class:"btn-text"},Ls={key:2,class:"login-hint"},Rs={key:1,class:"menu-content settings-view"},Is={class:"settings-list"},xs={class:"setting-item"},Ds={class:"slider-container"},Os={class:"slider-value"},Gs={class:"setting-item"},zs={class:"slider-container"},Ns={class:"slider-value"},Ws={class:"setting-item"},Fs={class:"slider-container"},ks={class:"slider-value"},Vs={class:"setting-item"},Hs={class:"slider-container"},Us={class:"slider-value"},Bs={key:2,class:"menu-content confirm-view"},Zs=ie({__name:"PauseMenu",props:{gameState:{}},emits:["resume","quit","settingsChanged"],setup(r,{emit:e}){const t=r,s=e,i=Oe(),a=We(),n=Ne(),h=N("main"),u=N(!1),m=N(null),d=N(null),p=N({mouseSensitivity:50,masterVolume:80,musicVolume:70,sfxVolume:90}),S=x(()=>a.isAuthenticated),g=x(()=>S.value&&t.gameState!==null);function _(){const V=localStorage.getItem("gameSettings");if(V)try{const f=JSON.parse(V);p.value={...p.value,...f}}catch{}}_();function G(){s("resume")}async function Y(){if(!(!g.value||!t.gameState)){u.value=!0,m.value=null,d.value=null;try{const V=await ft.saveGame(t.gameState);n.setCurrentSaveId(V.saveId),n.updateLastSaveTime(),m.value="!",setTimeout(()=>{m.value=null},2e3)}catch(V){d.value=V instanceof Error?V.message:""}finally{u.value=!1}}}function re(){h.value="settings"}function oe(){h.value="main"}function he(){localStorage.setItem("gameSettings",JSON.stringify(p.value)),s("settingsChanged",p.value),h.value="main"}function le(){h.value="confirm-quit"}function ue(){h.value="main"}function me(){s("quit"),i.push("/")}return(V,f)=>(T(),C("div",ys,[o("div",Ss,[h.value==="main"?(T(),C("div",bs,[f[8]||(f[8]=o("h2",{class:"menu-title"},"",-1)),m.value?(T(),C("div",As,y(m.value),1)):W("",!0),d.value?(T(),C("div",Es,y(d.value),1)):W("",!0),o("div",Ps,[o("button",{class:"menu-btn primary",onClick:G},[...f[4]||(f[4]=[o("span",{class:"btn-icon"},"",-1),o("span",{class:"btn-text"},"",-1)])]),o("button",{class:te(["menu-btn",{disabled:!g.value||u.value}]),onClick:Y,disabled:!g.value||u.value},[f[5]||(f[5]=o("span",{class:"btn-icon"},"",-1)),o("span",Cs,y(u.value?"...":""),1)],10,Ts),o("button",{class:"menu-btn",onClick:re},[...f[6]||(f[6]=[o("span",{class:"btn-icon"},"",-1),o("span",{class:"btn-text"},"",-1)])]),o("button",{class:"menu-btn danger",onClick:le},[...f[7]||(f[7]=[o("span",{class:"btn-icon"},"",-1),o("span",{class:"btn-text"},"",-1)])])]),S.value?W("",!0):(T(),C("p",Ls,"  "))])):W("",!0),h.value==="settings"?(T(),C("div",Rs,[f[13]||(f[13]=o("h2",{class:"menu-title"},"",-1)),o("div",Is,[o("div",xs,[f[9]||(f[9]=o("label",null,"",-1)),o("div",Ds,[ce(o("input",{type:"range","onUpdate:modelValue":f[0]||(f[0]=H=>p.value.mouseSensitivity=H),min:"1",max:"100",class:"slider"},null,512),[[de,p.value.mouseSensitivity,void 0,{number:!0}]]),o("span",Os,y(p.value.mouseSensitivity),1)])]),o("div",Gs,[f[10]||(f[10]=o("label",null,"",-1)),o("div",zs,[ce(o("input",{type:"range","onUpdate:modelValue":f[1]||(f[1]=H=>p.value.masterVolume=H),min:"0",max:"100",class:"slider"},null,512),[[de,p.value.masterVolume,void 0,{number:!0}]]),o("span",Ns,y(p.value.masterVolume)+"%",1)])]),o("div",Ws,[f[11]||(f[11]=o("label",null,"",-1)),o("div",Fs,[ce(o("input",{type:"range","onUpdate:modelValue":f[2]||(f[2]=H=>p.value.musicVolume=H),min:"0",max:"100",class:"slider"},null,512),[[de,p.value.musicVolume,void 0,{number:!0}]]),o("span",ks,y(p.value.musicVolume)+"%",1)])]),o("div",Vs,[f[12]||(f[12]=o("label",null,"",-1)),o("div",Hs,[ce(o("input",{type:"range","onUpdate:modelValue":f[3]||(f[3]=H=>p.value.sfxVolume=H),min:"0",max:"100",class:"slider"},null,512),[[de,p.value.sfxVolume,void 0,{number:!0}]]),o("span",Us,y(p.value.sfxVolume)+"%",1)])])]),o("div",{class:"menu-buttons horizontal"},[o("button",{class:"menu-btn",onClick:he},""),o("button",{class:"menu-btn secondary",onClick:oe},"")])])):W("",!0),h.value==="confirm-quit"?(T(),C("div",Bs,[f[14]||(f[14]=o("h2",{class:"menu-title"},"",-1)),f[15]||(f[15]=o("p",{class:"confirm-text"},"",-1)),o("div",{class:"menu-buttons horizontal"},[o("button",{class:"menu-btn danger",onClick:me},""),o("button",{class:"menu-btn secondary",onClick:ue},"")])])):W("",!0)])]))}}),Ks=ne(Zs,[["__scopeId","data-v-d420c4a0"]]),$s={key:0,class:"performance-stats"},Ys={class:"stat-row"},js={class:"stat-row"},Xs={class:"stat-value"},Js={class:"stat-row"},Qs={class:"stat-value"},qs={class:"stat-row"},ei={class:"stat-value"},ti={class:"stat-row"},si={class:"stat-value"},ii={key:0,class:"stat-row"},ai={class:"stat-value"},ni=ie({__name:"PerformanceStats",props:{metrics:{},visible:{type:Boolean}},setup(r){const e=r,t=x(()=>{if(!e.metrics)return"#ffffff";const a=e.metrics.fps;return a>=55?"#4ade80":a>=40?"#fbbf24":"#ef4444"}),s=a=>`${a} MB`,i=a=>a>=1e6?`${(a/1e6).toFixed(1)}M`:a>=1e3?`${(a/1e3).toFixed(1)}K`:a.toString();return(a,n)=>r.visible&&r.metrics?(T(),C("div",$s,[o("div",Ys,[n[0]||(n[0]=o("span",{class:"stat-label"},"FPS:",-1)),o("span",{class:"stat-value",style:se({color:t.value})},y(r.metrics.fps),5)]),o("div",js,[n[1]||(n[1]=o("span",{class:"stat-label"},"Frame:",-1)),o("span",Xs,y(r.metrics.avgFrameTime.toFixed(1))+"ms",1)]),o("div",Js,[n[2]||(n[2]=o("span",{class:"stat-label"},"Draw:",-1)),o("span",Qs,y(r.metrics.drawCalls),1)]),o("div",qs,[n[3]||(n[3]=o("span",{class:"stat-label"},"Tris:",-1)),o("span",ei,y(i(r.metrics.triangles)),1)]),o("div",ti,[n[4]||(n[4]=o("span",{class:"stat-label"},"Zombies:",-1)),o("span",si,y(r.metrics.zombieCount),1)]),r.metrics.memoryUsed>0?(T(),C("div",ii,[n[5]||(n[5]=o("span",{class:"stat-label"},"Mem:",-1)),o("span",ai,y(s(r.metrics.memoryUsed)),1)])):W("",!0)])):W("",!0)}}),ri=ne(ni,[["__scopeId","data-v-4f296322"]]),oi={class:"game-view"},hi={key:0,class:"loading-screen"},li={key:1,class:"error-screen"},ui={class:"error-content"},mi={key:1,class:"game-over-overlay"},ci={class:"game-over-content"},di={key:0,class:"top-ten-badge"},pi={class:"game-over-stats"},gi={class:"stat-item"},fi={class:"stat-value score"},vi={class:"stat-item"},_i={class:"stat-value"},wi={class:"stat-item"},Mi={class:"stat-value"},yi={class:"stat-item"},Si={class:"stat-value"},bi={class:"game-over-buttons"},Ai=ie({__name:"GameView",setup(r){const e=Oe();Je();const t=We(),s=Ne(),i=N(null);let a=null,n=null;const h=N(!1),u=N(!1),m=N(!0),d=N(null),p=N(!1),S=N(null),g=Ce({score:0,waveReached:0,zombiesKilled:0,playTime:0,isTopTen:!1}),_=Ce({health:100,maxHealth:100,stamina:100,maxStamina:100,currentWeaponName:"Pistol",currentWeaponSlot:0,currentAmmo:15,reserveAmmo:60,magazineSize:15,isReloading:!1,currentWave:1,zombiesKilled:0,totalZombiesInWave:15,isPreparationPhase:!0,preparationTimeLeft:30,score:0,lastDamage:0,damageTimestamp:0}),G=x(()=>t.isAuthenticated);function Y(){if(!n)return;const A=n.getHUDState();Object.assign(_,A),p.value&&(S.value=n.getPerformanceMetrics())}function re(A){A.code==="F3"&&(A.preventDefault(),p.value=!p.value)}function oe(A){Object.assign(_,A)}function he(A){const w=A;_.lastDamage=w.damage,_.damageTimestamp=Date.now()}async function le(A){const w=A;if(u.value=!0,g.score=w.finalScore,g.waveReached=w.waveReached,g.zombiesKilled=w.totalZombiesKilled,g.playTime=w.playTime,G.value)try{const Z=await vt.submitScore({score:w.finalScore,waveReached:w.waveReached,zombiesKilled:w.totalZombiesKilled,playTimeSeconds:Math.floor(w.playTime)});g.isTopTen=Z.isTopTen}catch(Z){console.error("Failed to submit score:",Z)}}function ue(){h.value=!0}function me(){h.value=!1}function V(){n&&n.resume()}function f(){n&&n.stop(),a&&a.stop(),e.push("/")}function H(A){n&&n.applyConfig(A)}function Fe(){return n?.getGameState()??null}function ke(){u.value=!1,n&&n.startNewGame()}function Ve(){f()}async function He(){if(i.value){m.value=!0,d.value=null;try{a=new St(i.value),await a.init(),n=new Vt(a.getSceneManager(),a.getInputManager()),await n.init(),n.on(K.STATE_CHANGED,oe),n.on(K.PLAYER_DAMAGED,he),n.on(K.GAME_OVER,le),n.on(R.GAME_PAUSE,ue),n.on(R.GAME_RESUME,me);const A=s.gameState;A?(n.loadGame(A),s.clearGameState()):n.startNewGame(),a.start(),Ue(),m.value=!1}catch(A){d.value=A instanceof Error?A.message:"",m.value=!1}}}function Ue(){if(!a||!n)return;const A=a.fixedUpdate.bind(a);a.fixedUpdate=w=>{A(w),n&&!h.value&&!u.value&&(n.processInput(w),n.update(w),Y())}}function Be(A){const w=Math.floor(A/60),Z=Math.floor(A%60);return`${w}:${Z.toString().padStart(2,"0")}`}return $e(async()=>{window.addEventListener("keydown",re),await He()}),Ye(()=>{window.removeEventListener("keydown",re),n&&(n.off(K.STATE_CHANGED,oe),n.off(K.PLAYER_DAMAGED,he),n.off(K.GAME_OVER,le),n.off(R.GAME_PAUSE,ue),n.off(R.GAME_RESUME,me),n.dispose(),n=null),a&&(a.stop(),a=null)}),(A,w)=>(T(),C("div",oi,[m.value?(T(),C("div",hi,[...w[2]||(w[2]=[o("div",{class:"loading-content"},[o("h2",null,"..."),o("div",{class:"loading-spinner"})],-1)])])):d.value?(T(),C("div",li,[o("div",ui,[w[3]||(w[3]=o("h2",null,"",-1)),o("p",null,y(d.value),1),o("button",{class:"menu-btn",onClick:w[0]||(w[0]=Z=>Le(e).push("/"))},"")])])):(T(),C(je,{key:2},[o("div",{ref_key:"gameContainer",ref:i,class:"game-container"},null,512),Se(gs,{health:_.health,"max-health":_.maxHealth,stamina:_.stamina,"max-stamina":_.maxStamina,"current-weapon-name":_.currentWeaponName,"current-weapon-slot":_.currentWeaponSlot,"current-ammo":_.currentAmmo,"reserve-ammo":_.reserveAmmo,"magazine-size":_.magazineSize,"is-reloading":_.isReloading,"current-wave":_.currentWave,"zombies-killed":_.zombiesKilled,"total-zombies-in-wave":_.totalZombiesInWave,"is-preparation-phase":_.isPreparationPhase,"preparation-time-left":_.preparationTimeLeft,score:_.score},null,8,["health","max-health","stamina","max-stamina","current-weapon-name","current-weapon-slot","current-ammo","reserve-ammo","magazine-size","is-reloading","current-wave","zombies-killed","total-zombies-in-wave","is-preparation-phase","preparation-time-left","score"]),Se(Ms,{health:_.health,"max-health":_.maxHealth,"last-damage":_.lastDamage,"damage-timestamp":_.damageTimestamp},null,8,["health","max-health","last-damage","damage-timestamp"]),Se(ri,{metrics:S.value,visible:p.value},null,8,["metrics","visible"]),h.value&&!u.value?(T(),Xe(Ks,{key:0,"game-state":Fe(),onResume:V,onQuit:f,onSettingsChanged:H},null,8,["game-state"])):W("",!0),u.value?(T(),C("div",mi,[o("div",ci,[w[8]||(w[8]=o("h1",{class:"game-over-title"},"",-1)),g.isTopTen?(T(),C("div",di,"  10! ")):W("",!0),o("div",pi,[o("div",gi,[w[4]||(w[4]=o("span",{class:"stat-label"},"",-1)),o("span",fi,y(g.score.toLocaleString()),1)]),o("div",vi,[w[5]||(w[5]=o("span",{class:"stat-label"},"",-1)),o("span",_i,y(g.waveReached),1)]),o("div",wi,[w[6]||(w[6]=o("span",{class:"stat-label"},"",-1)),o("span",Mi,y(g.zombiesKilled),1)]),o("div",yi,[w[7]||(w[7]=o("span",{class:"stat-label"},"",-1)),o("span",Si,y(Be(g.playTime)),1)])]),o("div",bi,[o("button",{class:"menu-btn primary",onClick:ke},""),o("button",{class:"menu-btn",onClick:w[1]||(w[1]=Z=>Le(e).push("/leaderboard"))},""),o("button",{class:"menu-btn secondary",onClick:Ve},"")])])])):W("",!0)],64))]))}}),Ii=ne(Ai,[["__scopeId","data-v-9c89f7cd"]]);export{Ii as default};
//# sourceMappingURL=GameView-CfYIyRjU.js.map
